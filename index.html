<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>啟英高中學生技術檢定證照填報系統 - 登入</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; max-width: 860px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin-bottom: 12px; }
  fieldset { border: 1px solid #ddd; padding: 16px; border-radius: 8px; }
  .row { display: flex; gap: 12px; margin: 8px 0; flex-wrap: wrap; }
  label { min-width: 90px; display: inline-block; }
  input, select, button { padding: 8px 10px; font-size: 14px; }
  .hidden { display: none; }
  .card { background:#fafafa; border:1px solid #eee; border-radius:8px; padding:16px; margin-top:12px;}
  .actions { margin-top: 12px; display: flex; gap: 8px; }
  .note { color:#666; font-size: 12px; }
</style>
</head>
<body>
<h1>啟英高中學生取得技術檢定證照填報系統</h1>

<div class="card">
  <div class="row">
    <label>身分</label>
    <select id="role">
      <option value="student">學生</option>
      <option value="teacher">教師</option>
    </select>
  </div>

  <!-- 學生表單 -->
  <fieldset id="studentForm">
    <legend>學生登入</legend>
    <div class="row">
      <label>群科</label>
      <select id="dept">
        <option value="汽車科">汽車科</option>
        <option value="資訊科">資訊科</option>
        <option value="商管群">商管群</option>
        <option value="設計群">設計群</option>
        <option value="時尚科">時尚科</option>
        <option value="餐旅群">餐旅群</option>
        <option value="外語群">外語群</option>
      </select>
    </div>
    <!-- 設計群專用的子選單：廣設 / 室設（預設隱藏） -->
<div class="row hidden" id="designMajorRow">
  <label>科別</label>
  <select id="designMajor">
    <option value="">請選擇</option>
    <option value="廣設">廣設</option>
    <option value="室設">室設</option>
  </select>
</div>
    <div class="row">
      <label>姓名</label>
      <input id="stuName" placeholder="請輸入姓名" />
    </div>
    <div class="row">
      <label>學號</label>
      <input id="stuSid" placeholder="請輸入學號" />
    </div>
    <div class="actions">
      <button id="btnStuLogin">學生登入</button>
    </div>
  </fieldset>

  <!-- 教師表單 -->
  <fieldset id="teacherForm" class="hidden">
    <legend>教師登入</legend>
    <div class="row">
      <label>帳號</label>
      <input id="tAccount" placeholder="請輸入帳號" />
    </div>
    <div class="row">
      <label>密碼</label>
      <input id="tPassword" type="password" placeholder="請輸入密碼（預設 123456）" />
    </div>
        <!-- 新增：教師選群科 -->
    <div class="row">
      <label>群科</label>
      <select id="tDept"></select>
    </div>

    <!-- 新增：教師選班級（會依群科動態灌入） -->
    <div class="row">
      <label>班級</label>
      <select id="tClass"></select>
    </div>

    <!-- 新增：學號首碼（0-9） -->
    <div class="row">
      <label>學號首碼</label>
      <select id="tDigit"></select>
    </div>

    <div class="actions">
      <button id="btnTeacherLogin">教師登入</button>
    </div>
    <div class="note">教師驗證：固定密碼 + 導師名單查詢帳號 → 取得班級/導師/科別</div>
  </fieldset>
</div>

<div class="card">
  <div class="note">提示：登入成功後會導向對應頁面，token 與基本資訊儲存在 localStorage。</div>
</div>
<style>
  #busyMask{position:fixed;inset:0;display:none;background:rgba(255,255,255,.6);backdrop-filter:blur(1px);align-items:center;justify-content:center;z-index:9999}
  #busyMask .sp{width:48px;height:48px;border-radius:50%;border:6px solid #ccc;border-top-color:#4a7;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
<div id="busyMask"><div class="sp"></div></div>
<script>
  function showBusy(on){ const m=document.getElementById('busyMask'); if(m) m.style.display = on ? 'flex' : 'none'; }
  // === 群科 -> 班級清單（依你提供的名單） ===
const DEPT_CLASSES = {
  '汽車科': [
    '汽車三甲','汽車三戊','實汽三甲','實汽三乙',
    '汽車二甲','汽車二戊','實汽二甲','實汽二乙',
    '汽車一甲','汽車一戊','實汽一甲'
  ],
  '資訊科': [
    '資訊三甲','資訊三戊','實微三甲','僑資三甲A','僑資三甲B',
    '資訊二甲','資訊二戊','僑資二甲A','僑資二甲B',
    '資訊一戊','僑資一甲A','僑資一甲B'
  ],
  '商管群': [
    '資處三戊','電商三甲','資處二戊','電商二甲','電商一甲','實寵一甲'
  ],
  '時尚科': [
    '時尚三甲','時尚三戊','實容三甲','實髮三甲',
    '時尚二甲','時尚二乙','時尚二戊','實容二甲','實髮二甲',
    '僑時二甲A','僑時二甲B',
    '時尚一甲','時尚一戊','實容一甲','實髮一甲',
    '僑時一甲A','僑時一甲B'
  ],
  '設計群': [
    '廣設三甲','廣設三戊','室設三甲','室設三戊',
    '廣設二甲','廣設二戊','室設二甲','室設二戊',
    '廣設一甲','室設一戊'
  ],
  '餐旅群': [
    '餐管三甲','餐管三乙','餐管三丙','餐管三戊','實餐三甲',
    '餐管二甲','餐管二乙','餐管二丙','餐管二丁','餐管二戊','實餐二甲',
    '餐管一甲','餐管一乙','餐管一丙','餐管一丁','餐管一戊','實餐一甲',
    '僑餐一甲A','僑餐一甲B'
  ],
  '外語群': [
    '應英三戊','應日三戊','應英二戊','應日二戊','應日一戊'
  ]
};

// 塞 <select> 選項的小工具
function fillSelect(selectEl, options, placeholder, selectedValue) {
  selectEl.innerHTML = '';
  if (placeholder) {
    const op = document.createElement('option');
    op.value = ''; op.textContent = placeholder;
    selectEl.appendChild(op);
  }
  options.forEach(v => {
    const op = document.createElement('option');
    op.value = v; op.textContent = v;
    if (selectedValue && selectedValue === v) op.selected = true;
    selectEl.appendChild(op);
  });
}

// 綁定「群科 → 班級」聯動
function bindDeptClassCascade(deptSel, classSel) {
  const deptSelect  = typeof deptSel  === 'string' ? document.querySelector(deptSel)  : deptSel;
  const classSelect = typeof classSel === 'string' ? document.querySelector(classSel) : classSel;

  fillSelect(deptSelect, Object.keys(DEPT_CLASSES), '請選擇群科');

  deptSelect.addEventListener('change', () => {
    const dept = deptSelect.value.trim();
    const classes = DEPT_CLASSES[dept] || [];
    fillSelect(classSelect, classes, classes.length ? '請選擇班級' : '無可選班級');
  });

  fillSelect(classSelect, [], '請先選群科');
}
    // 專門檢查教師帳號是否需要被攔下
  function guardTeacherAccount(account) {
    const BLOCKED_ACCOUNTS = new Set([
      '31014','13007','31042','30003','18015','30038','18007','31019','31032','30021',
      '33032','32031','31044','31040','35006','30051','31002','18013','31022','35011'
    ]);
    if (BLOCKED_ACCOUNTS.has(String(account).trim())) {
      alert('非職科無需填報，謝謝您');
      return false; // 表示「不允許通過」
    }
    return true; // 表示「可繼續登入」
  }
    // 若未定義 dbg，就提供 fallback；開啟 ?debug=1 才會輸出
  (function() {
    if (!window.dbg) {
      window.dbg = function(title, obj) {
        try {
          const enabled = new URLSearchParams(location.search).get('debug') === '1'
                       || (window.localStorage && localStorage.getItem('debug') === '1');
          if (!enabled) return;
          console.log('[DBG]', title, obj);
        } catch (e) { /* ignore */ }
      };
    }
  })();
  const GAS_BASE = '/api/gas';
  async function apiGet(path, params) {
    const url = GAS_BASE + '?' + new URLSearchParams({ path, ...params });
    dbg('GET ' + url, null);
    const r = await fetch(url);
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try { return JSON.parse(txt); } catch { return { ok:false, as:'html', status:r.status, body:txt }; }
  }

  async function apiPost(path, params) {
    const body = new URLSearchParams({ path, ...params }).toString();
    dbg('POST ' + GAS_BASE, body);
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try { return JSON.parse(txt); } catch { return { ok:false, as:'html', status:r.status, body:txt }; }
  }

  const roleSel = document.getElementById('role');
  const studentForm = document.getElementById('studentForm');
  const teacherForm = document.getElementById('teacherForm');

  roleSel.addEventListener('change', () => {
    const isTeacher = roleSel.value === 'teacher';
    teacherForm.classList.toggle('hidden', !isTeacher);
    studentForm.classList.toggle('hidden', isTeacher);
  });
  // === 學生端：群科=設計群 → 顯示子別（廣設/室設） ===
const deptSelect      = document.getElementById('dept');
const designRow       = document.getElementById('designMajorRow');
const designMajorSel  = document.getElementById('designMajor');

function updateDesignRow() {
  const show = deptSelect.value === '設計群';
  designRow.classList.toggle('hidden', !show);
  if (!show) designMajorSel.value = '';
}
deptSelect.addEventListener('change', updateDesignRow);
// 首次載入也判斷一次
updateDesignRow();

// 頁面載入後初始化教師選單（群科→班級、首碼 0-9）
document.addEventListener('DOMContentLoaded', () => {
  const deptSel  = document.getElementById('tDept');
  const classSel = document.getElementById('tClass');
  const digitSel = document.getElementById('tDigit');
  if (deptSel && classSel) {
    bindDeptClassCascade(deptSel, classSel);
  }
  if (digitSel) {
    fillSelect(digitSel, Array.from({length:10}, (_,i)=>String(i)), '請選擇首碼');
  }
});
document.getElementById('btnStuLogin').addEventListener('click', async () => {
  showBusy(true);
  const dept = document.getElementById('dept').value.trim();
  const name = document.getElementById('stuName').value.trim();
  const sid  = document.getElementById('stuSid').value.trim();
  const designSub = (document.getElementById('designMajor')?.value || '').trim();

  if (!dept || !name || !sid) { alert('請完整填寫群科、姓名、學號'); return; }
  if (dept === '設計群' && !designSub) { alert('請選擇子別（廣設 / 室設）'); return; }

  try {
    // 1) 登入 API（有帶上 designSub）
    const res = await apiPost('auth/student', { dept, name, sid, designSub, debug:'1' });
    if (!res.ok) throw new Error(res.error || '學生登入失敗');

    // 2) 儲存 session 到 localStorage（★關鍵：designSub）
    localStorage.setItem('token', res.token);
    localStorage.setItem('role', 'student');
    localStorage.setItem('dept', dept);
    if (dept === '設計群') {
      localStorage.setItem('designSub', designSub);  // ★ 讓 student.html 能帶 designSub 給後端
    } else {
      localStorage.removeItem('designSub');          // 避免殘留舊的子別
    }
    localStorage.removeItem('classId'); // 維持你原本的行為

    // （可選）後端若回傳 sheetName，也一起存起來，之後 profile 用得到
    if (res.sheetName) localStorage.setItem('sheetName', res.sheetName);

    // 3) 進入學生頁
    window.location.href = 'student.html';
  } catch (err) {
    alert(err.message);
  } finally {
    showBusy(false);
  }
});


document.getElementById('btnTeacherLogin').addEventListener('click', async () => {
  showBusy(true);
  const account  = document.getElementById('tAccount').value.trim();
  const password = document.getElementById('tPassword').value.trim();
  const dept     = (document.getElementById('tDept')  ?.value || '').trim();
  const classId  = (document.getElementById('tClass') ?.value || '').trim();
  const digit    = (document.getElementById('tDigit') ?.value || '').trim();

  try {
    if (!account || !password) throw new Error('請輸入帳號與密碼');
    if (!guardTeacherAccount(account)) return;
    if (!dept)    throw new Error('請選擇群科');
    if (!classId) throw new Error('請選擇班級');
    if (!/^[0-9]$/.test(digit)) throw new Error('請選擇學號首碼（0-9）');

    // 1) 向後端登入教師帳號 → 取得「教師 token」
    //    注意：路由名稱需與 Apps Script doPost 對應（建議 'auth/teacher'）
    const auth = await apiPost('auth/teacher', { account, password });
    if (!auth.ok) throw new Error(auth.error || '教師登入失敗');

    // 2) 清掉舊 session，寫入教師 session（避免殘留學生 token）
    localStorage.clear();
    localStorage.setItem('token',   auth.token);
    localStorage.setItem('role',    'teacher');
    localStorage.setItem('dept',    auth.dept || dept);  // 後端回的 dept 優先
    localStorage.setItem('classId', classId);
    localStorage.setItem('digit',   digit);
    if (auth.tutor)   localStorage.setItem('tutor',   auth.tutor);
    if (auth.classId) localStorage.setItem('classId', auth.classId); // 若後端直接回導師班級也可覆蓋

    // 3) （可選）先測一次班級資料取得，並快取
    const res = await apiGet('class.bySheet', { dept: (auth.dept || dept), classId, digit });
    if (!res.ok) throw new Error(res.error || '無法取得班級資料');
    localStorage.setItem('teacherClassData', JSON.stringify(res));

    // 4) 進入教師頁
    window.location.href = 'teacher.html';
  } catch (err) {
    alert(err.message || '教師登入失敗');
  } finally {
    showBusy(false);
  }
});



</script>
</body>
</html>
