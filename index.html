<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>啟英高中學生職業證照管理系統</title>
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --danger:#ef4444;
      --btn:#1f2937; --btn2:#0ea5e9;
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(120deg,#0b1020,#0e1428 60%,#0b1020)}
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:24px 28px;color:var(--text)}
    h1{margin:0 0 6px;font-size:28px;letter-spacing:.5px}
    p.sub{margin:0 0 18px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:#cbd5e1;margin:14px 0 8px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;outline:none}
    input:focus,select:focus{border-color:var(--accent)}
    .radio-group{display:flex;gap:12px;margin:8px 0 4px}
    .radio{display:flex;gap:8px;align-items:center;background:#0b1220;border:1px solid #334155;border-radius:999px;padding:8px 12px;cursor:pointer}
    .btn{display:inline-block;padding:12px 18px;border-radius:12px;border:1px solid #334155;background:var(--btn);color:#e5e7eb;text-decoration:none;cursor:pointer}
    .btn.primary{background:var(--btn2);border-color:#0284c7}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .actions{display:flex;gap:10px;margin-top:18px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .error{color:var(--danger);font-size:13px;margin-top:8px}
    .divider{height:1px;background:#1f2937;margin:18px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .badge{display:inline-block;background:#0b1220;border:1px solid #334155;color:#a5b4fc;padding:6px 10px;border-radius:999px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>名冊＋證照系統</h1>
      <p class="sub">Google Apps Script 後端 / Spreadsheet 資料庫</p>

      <label>選擇身分</label>
      <div class="radio-group" id="roleGroup">
        <div class="radio"><input type="radio" name="role" id="roleStudent" value="student" checked><span>學生</span></div>
        <div class="radio"><input type="radio" name="role" id="roleTeacher" value="teacher"><span>教師</span></div>
      </div>

      <div id="studentPanel">
        <span class="badge">學生登入</span>
        <div class="row">
          <div>
            <label>學號（6碼數字）</label>
            <input id="stuSid" inputmode="numeric" placeholder="例如：215106" maxlength="6">
          </div>
          <div>
            <label>身分證字號（1英文字母 + 9數字）</label>
            <input id="stuNid" placeholder="例如：A123456789" maxlength="10">
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnStuLogin">學生登入</button>
        </div>
        <div class="hint">說明：會到 Google 試算表「名冊+證照」第 3 欄以學號搜尋，並比對第 6 欄身分證字號。</div>
        <div class="error" id="stuErr"></div>
        <div class="divider"></div>
      </div>

      <div id="teacherPanel" style="display:none">
        <span class="badge">教師登入</span>
        <div class="grid2">
          <div>
            <label>教師帳號（5碼）</label>
            <input id="tAcc" placeholder="例如：12345" maxlength="5">
          </div>
          <div>
            <label>密碼（固定：123456）</label>
            <input id="tPwd" type="password" placeholder="123456" value="">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>群科</label>
            <select id="tDept"></select>
          </div>
          <div>
            <label>班級</label>
            <select id="tClass"></select>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnTeaLogin">教師登入</button>
        </div>
        <div class="hint">說明：密碼固定為 123456。會到 Google 試算表第 2 欄以「班級名稱」搜尋並回傳對應資料列。</div>
        <div class="error" id="teaErr"></div>
      </div>
    </div>
  </div>

  <script>
    // 👉 換成你部署的 Apps Script Web App URL
    const GAS_BASE = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec';

    // 群科 → 班級對應（題目提供）
    const DEPT_CLASS_MAP = {
      "普通科": ["普通二甲","普通三甲","普通三乙","普通一戊","普通二戊","普通三戊","普通一己","普通二己","普通三己"],
      "汽車科": ["汽車一甲","汽車二甲","汽車三甲","汽車一戊","汽車二戊","汽車三戊"],
      "資訊科": ["資訊二甲","資訊三甲","資訊一戊","資訊二戊","資訊三戊"],
      "僑生建教資訊": ["僑資一甲A","僑資一甲B","僑資二甲A","僑資二甲B","僑資三甲A","僑資三甲B"],
      "資料處理科": ["資處二戊","資處三戊"],
      "廣告設計科": ["廣設一甲","廣設二甲","廣設三甲","廣設二戊","廣設三戊"],
      "餐飲管理科": ["餐管一甲","餐管二甲","餐管三甲","餐管一乙","餐管二乙","餐管三乙","餐管一丙","餐管二丙","餐管三丙","餐管一丁","餐管二丁","餐管一戊","餐管二戊","餐管三戊"],
      "電子商務科": ["電商一甲","電商二甲","電商三甲"],
      "應用英語科": ["應英三戊","應英二戊"],
      "應用日語科": ["應日三戊","應日一戊","應日二戊"],
      "僑生建教餐管": ["僑餐一甲A","僑餐一甲B"],
      "室內設計科": ["室設二甲","室設三甲","室設一戊","室設二戊","室設三戊"],
      "時尚造型科": ["時尚一甲","時尚二甲","時尚三甲","時尚二乙","時尚一戊","時尚二戊","時尚三戊"],
      "僑生建教時尚": ["僑時一甲A","僑時一甲B","僑時二甲A","僑時二甲B"],
      "音樂科": ["音樂一甲","音樂二甲","音樂三甲"],
      "電影電視科": ["影視二甲","影視三甲"],
      "表演藝術科": ["表藝一甲","表藝二甲","表藝三甲","表藝一乙","表藝二乙","表藝三乙"],
      "綜合職能科": ["綜職一甲","綜職二甲","綜職三甲"],
      "寵物經營科": ["實寵一甲"],
      "汽車修護科": ["實汽一甲","實汽二甲","實汽三甲","實汽二乙","實汽三乙"],
      "微電腦修護科": ["實微三甲"],
      "餐飲技術科": ["實餐一甲","實餐二甲","實餐三甲"],
      "美髮技術科": ["實髮一甲","實髮二甲","實髮三甲"],
      "美容造型科": ["實容一甲","實容二甲","實容三甲"]
    };

    // UI 元件
    const roleStudent = document.querySelector('#roleStudent');
    const roleTeacher = document.querySelector('#roleTeacher');
    const studentPanel = document.querySelector('#studentPanel');
    const teacherPanel = document.querySelector('#teacherPanel');
    const tDept = document.querySelector('#tDept');
    const tClass = document.querySelector('#tClass');

    // 切換面板
    document.getElementById('roleGroup').addEventListener('change', () => {
      const isStu = roleStudent.checked;
      studentPanel.style.display = isStu ? '' : 'none';
      teacherPanel.style.display = isStu ? 'none' : '';
    });

    // 填入群科、連動班級
    function renderDepts(){
      tDept.innerHTML = '';
      for(const dept of Object.keys(DEPT_CLASS_MAP)){
        const opt = document.createElement('option');
        opt.value = opt.textContent = dept;
        tDept.appendChild(opt);
      }
      renderClasses();
    }
    function renderClasses(){
      tClass.innerHTML = '';
      const list = DEPT_CLASS_MAP[tDept.value] || [];
      for(const c of list){
        const opt = document.createElement('option');
        opt.value = opt.textContent = c;
        tClass.appendChild(opt);
      }
    }
    tDept.addEventListener('change', renderClasses);
    renderDepts();

    // 檢核
    const isValidSid = v => /^\d{6}$/.test(v);
    const isValidTeacherAcc = v => /^\d{5}$/.test(v);
    const isValidNID = v => /^[A-Za-z][12]\d{8}$/.test(v);

    // 學生登入
    document.getElementById('btnStuLogin').addEventListener('click', async ()=>{
      const sid = (document.getElementById('stuSid').value||'').trim();
      const nid = (document.getElementById('stuNid').value||'').trim().toUpperCase();
      const err = document.getElementById('stuErr'); err.textContent = '';

      if(!isValidSid(sid)){ err.textContent='學號需為 6 碼數字。'; return; }
      if(!isValidNID(nid)){ err.textContent='身分證字號格式錯誤（1 字母 + 性別碼 1/2 + 8 碼）。'; return; }

      try{
        const body = new URLSearchParams({ path:'login_student', sid, nid }).toString();
        const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
        const data = await r.json();
        if(!data.ok){ err.textContent = data.error || '登入失敗'; return; }
        // 存到 sessionStorage，跳頁
        sessionStorage.setItem('studentRow', JSON.stringify(data.row));
        location.href = 'student.html';
      }catch(e){
        err.textContent = '連線異常：' + e.message;
      }
    });

    // 教師登入
    document.getElementById('btnTeaLogin').addEventListener('click', async ()=>{
      const account = (document.getElementById('tAcc').value||'').trim();
      const password = (document.getElementById('tPwd').value||'').trim();
      const dept = tDept.value;
      const clazz = tClass.value;
      const err = document.getElementById('teaErr'); err.textContent='';

      if(!isValidTeacherAcc(account)){ err.textContent='教師帳號需為 5 碼。'; return; }
      if(password !== '123456'){ err.textContent='密碼錯誤（固定為 123456）。'; return; }
      if(!dept || !clazz){ err.textContent='請選擇群科與班級。'; return; }

      try{
        const body = new URLSearchParams({ path:'login_teacher', account, password, dept, clazz }).toString();
        const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
        const data = await r.json();
        if(!data.ok){ err.textContent = data.error || '登入失敗'; return; }
        sessionStorage.setItem('teacherList', JSON.stringify({ dept, clazz, rows: data.rows }));
        location.href = 'teacher.html';
      }catch(e){
        err.textContent = '連線異常：' + e.message;
      }
    });
  </script>
</body>
</html>
