<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>登入 | 職業證照登管系統</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><text y="14" font-size="14">📜</text></svg>'>
  <style>
    :root{
      /* 溫暖配色 */
      --bg1:#fff7ed;       /* 杏桃奶油 */
      --bg2:#ffedd5;       /* 暖杏 */
      --card:#fffaf0;      /* 米杏 */
      --line:#f5d6b0;      /* 淡金棕 */
      --text:#3b2f2f;      /* 可可棕 */
      --muted:#8b6b5e;     /* 摩卡 */
      --accent:#f59e0b;    /* 琥珀 */
      --btn:#fef3c7;       /* 奶油黃 */
      --btnBorder:#f1c07a; /* 焦糖邊 */
      --btnPrimary:#f59e0b;/* 琥珀橘 */
      --btnPrimaryText:#fffef9;
      --error:#b91c1c;
      --shadow: 0 10px 30px rgba(217, 119, 6, .15);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, var(--bg2), transparent 60%),
        radial-gradient(1200px 600px at 110% 10%, #fde68a, transparent 55%),
        linear-gradient(180deg, var(--bg1), #fff);
      min-height:100dvh;
    }
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:24px 28px;
    }
    h1{margin:0 0 6px;font-size:28px;letter-spacing:.5px}
    p.sub{margin:0 0 18px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:#6b4f43;margin:14px 0 8px}
    input,select{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fffdf7;
      color:var(--text);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 4px rgba(245, 158, 11, .15);
      background:#fffaf2;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .actions{display:flex;gap:10px;margin-top:18px}
    .btn{
      display:inline-block;
      padding:12px 18px;
      border-radius:12px;
      border:1px solid var(--btnBorder);
      background:var(--btn);
      color:var(--text);
      text-decoration:none;
      cursor:pointer;
      transition:transform .05s ease, filter .15s ease;
    }
    .btn:hover{filter:brightness(0.98)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--btnPrimary); border-color:#e08f03; color:var(--btnPrimaryText)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .error{color:var(--error);font-size:13px;margin-top:8px}
    .divider{height:1px;background:var(--line);margin:18px 0}
    .badge{display:inline-block;background:#fff5dc;border:1px solid var(--line);color:#774936;padding:6px 10px;border-radius:999px;font-size:12px}
    .soft{color:var(--muted);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>職業證照登管系統</h1>
      <p class="sub">Google Apps Script 後端 / Spreadsheet 資料庫</p>

      <!-- 身份下拉 -->
      <label>選擇身分</label>
      <select id="roleSelect">
        <option value="student" selected>學生</option>
        <option value="teacher">教師</option>
        <option value="admin">管理員</option>
      </select>

      <!-- 學生面板 -->
      <div id="studentPanel" style="margin-top:8px">
        <span class="badge">學生登入</span>
        <div class="row">
          <div>
            <label>學號</label>
            <input id="stuSid" inputmode="numeric" maxlength="6" autocomplete="off">
          </div>
          <div>
            <label>身分證字號</label>
            <input id="stuNid" maxlength="10" autocomplete="off">
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnStuLogin">學生登入</button>
        </div>
        <div class="error" id="stuErr"></div>
        <div class="divider"></div>
      </div>
<!-- 管理員面板 -->
<div id="adminPanel" style="display:none; margin-top:8px">
  <span class="badge">管理員登入</span>
  <div class="row">
    <div><label>管理員帳號</label><input id="aAcc" type="text" autocomplete="username"/></div>
    <div><label>管理員密碼</label><input id="aPwd" type="password" autocomplete="current-password"/></div>
  </div>
  <div class="actions">
    <button class="btn primary" id="btnAdm">管理員登入</button>
  </div>
  <div class="soft">登入後會先載入統計資料，以加速切換群科。</div>
  <div class="error" id="admErr"></div>
</div>
      <!-- 教師面板 -->
      <div id="teacherPanel" style="display:none">
        <span class="badge">教師登入</span>
        <div class="grid2">
          <div>
            <label>教師帳號</label>
            <input id="tAcc" maxlength="5" autocomplete="off">
          </div>
          <div>
            <label>密碼</label>
            <input id="tPwd" type="password" autocomplete="off">
          </div>
        </div>
<div class="row" id="tModeRow">
  <div>
    <label>學生類別</label>
    <select id="tMode">
      <option value="school">在校生</option>
      <option value="alumni">畢業生</option>
    </select>
  </div>
  <div>
    <label>學號首碼（畢業生）</label>
    <select id="tDigit">
      <option value="">請選擇</option>
      <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
      <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
    </select>
  </div>
</div>
        <div class="grid2">
          <div>
            <label>群科</label>
            <select id="tDept"></select>
          </div>
          <div>
            <label>班級</label>
            <select id="tClass"></select>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnTeaLogin">教師登入</button>
        </div>
        <div class="error" id="teaErr"></div>
      </div>
    </div>
  </div>
<div id="busy" style="position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="width:48px;height:48px;border:5px solid #fff;border-top-color:#f59e0b;border-radius:50%;animation:spin .9s linear infinite"></div>
</div>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>
  <script>
const busyEl = document.getElementById('busy');
function showBusy(on){ const el=document.getElementById('busy'); if(el) el.style.display = on?'flex':'none'; }

async function gasPost(obj){
  const body = new URLSearchParams(obj).toString();
  const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
  return r.json();
}
    // 改成走 Vercel 代理（你已設定 GAS_URL 環境變數）
    const GAS_BASE = '/api/gas';

    // 群科 → 班級對應
    const DEPT_CLASS_MAP = {
      "普通科": ["普通二甲","普通三甲","普通三乙","普通一戊","普通二戊","普通三戊","普通一己","普通二己","普通三己"],
      "汽車科": ["汽車一甲","汽車二甲","汽車三甲","汽車一戊","汽車二戊","汽車三戊"],
      "資訊科": ["資訊二甲","資訊三甲","資訊一戊","資訊二戊","資訊三戊"],
      "僑生建教資訊": ["僑資一甲A","僑資一甲B","僑資二甲A","僑資二甲B","僑資三甲A","僑資三甲B"],
      "資料處理科": ["資處二戊","資處三戊"],
      "廣告設計科": ["廣設一甲","廣設二甲","廣設三甲","廣設二戊","廣設三戊"],
      "餐飲管理科": ["餐管一甲","餐管二甲","餐管三甲","餐管一乙","餐管二乙","餐管三乙","餐管一丙","餐管二丙","餐管三丙","餐管一丁","餐管二丁","餐管一戊","餐管二戊","餐管三戊"],
      "電子商務科": ["電商一甲","電商二甲","電商三甲"],
      "應用英語科": ["應英三戊","應英二戊"],
      "應用日語科": ["應日三戊","應日一戊","應日二戊"],
      "僑生建教餐管": ["僑餐一甲A","僑餐一甲B"],
      "室內設計科": ["室設二甲","室設三甲","室設一戊","室設二戊","室設三戊"],
      "時尚造型科": ["時尚一甲","時尚二甲","時尚三甲","時尚二乙","時尚一戊","時尚二戊","時尚三戊"],
      "僑生建教時尚": ["僑時一甲A","僑時一甲B","僑時二甲A","僑時二甲B"],
      "音樂科": ["音樂一甲","音樂二甲","音樂三甲"],
      "電影電視科": ["影視二甲","影視三甲"],
      "表演藝術科": ["表藝一甲","表藝二甲","表藝三甲","表藝一乙","表藝二乙","表藝三乙"],
      "綜合職能科": ["綜職一甲","綜職二甲","綜職三甲"],
      "寵物經營科": ["實寵一甲"],
      "汽車修護科": ["實汽一甲","實汽二甲","實汽三甲","實汽二乙","實汽三乙"],
      "微電腦修護科": ["實微三甲"],
      "餐飲技術科": ["實餐一甲","實餐二甲","實餐三甲"],
      "美髮技術科": ["實髮一甲","實髮二甲","實髮三甲"],
      "美容造型科": ["實容一甲","實容二甲","實容三甲"]
    };

    // UI refs
    const roleSelect = document.getElementById('roleSelect');
    const studentPanel = document.getElementById('studentPanel');
    const teacherPanel = document.getElementById('teacherPanel');
    const tDept = document.getElementById('tDept');
    const tClass = document.getElementById('tClass');
    // === 教師：模式切換（在校生/畢業生） ===
    const tMode  = document.getElementById('tMode');
    const tDigit = document.getElementById('tDigit');
    const tModeRow = document.getElementById('tModeRow');

    // 初始：在校生 => 隱藏「學號首碼」，顯示「群科」
    tDigit.parentElement.style.display = 'none'; // 隱藏學號首碼
    document.getElementById('tDept').parentElement.style.display = ''; // 顯示群科

tMode.addEventListener('change', ()=>{
  const isAlumni = tMode.value === 'alumni';
  // 畢業生：不需要群科，顯示學號首碼
  document.getElementById('tDept').parentElement.style.display = isAlumni ? 'none' : '';
  tDigit.parentElement.style.display = isAlumni ? '' : 'none';
});


    // 切換面板：下拉選單
const adminPanel = document.getElementById('adminPanel');

roleSelect.addEventListener('change', () => {
  const v = roleSelect.value;
  studentPanel.style.display = (v === 'student') ? '' : 'none';
  teacherPanel.style.display = (v === 'teacher') ? '' : 'none';
  adminPanel.style.display   = (v === 'admin')   ? '' : 'none';
});

    // 填入群科、連動班級
    function renderDepts(){
      tDept.innerHTML = '';
      for(const dept of Object.keys(DEPT_CLASS_MAP)){
        const opt = document.createElement('option');
        opt.value = opt.textContent = dept;
        tDept.appendChild(opt);
      }
      renderClasses();
    }
    function renderClasses(){
      tClass.innerHTML = '';
      const list = DEPT_CLASS_MAP[tDept.value] || [];
      for(const c of list){
        const opt = document.createElement('option');
        opt.value = opt.textContent = c;
        tClass.appendChild(opt);
      }
    }
    tDept.addEventListener('change', renderClasses);
    renderDepts();

    // 檢核（仍保留，僅不在欄位旁提示）
    const isValidSid = v => /^\d{6}$/.test(v);
    const isValidTeacherAcc = v => /^\d{5}$/.test(v);
    const isValidNID = v => /^[A-Za-z][12]\d{8}$/.test(v);

/* 學生登入 */
document.getElementById('btnStuLogin').addEventListener('click', async ()=>{
  const sid = (document.getElementById('stuSid').value||'').trim();
  const nid = (document.getElementById('stuNid').value||'').trim().toUpperCase();
  const err = document.getElementById('stuErr'); err.textContent = '';

  if(!isValidSid(sid)){ err.textContent='學號格式不正確。'; return; }
  if(!isValidNID(nid)){ err.textContent='身分證字號格式不正確。'; return; }

  showBusy(true);
  try{
    const data = await gasPost({ path:'login_student', sid, nid });
    if(!data.ok){ err.textContent = data.error || '登入失敗'; return; }
    sessionStorage.setItem('studentRow', JSON.stringify(data.row)); // [dept,clazz,sid,name,seat,nid]
    location.href = 'student.html';
  }catch(e){
    err.textContent = '連線異常：' + e.message;
  }finally{
    showBusy(false);
  }
});

/* 教師登入 */
document.getElementById('btnTeaLogin').addEventListener('click', async ()=>{
  const account = (document.getElementById('tAcc').value||'').trim();
  const password = (document.getElementById('tPwd').value||'').trim();
  const dept = document.getElementById('tDept').value;
  const clazz = document.getElementById('tClass').value;
  const err = document.getElementById('teaErr'); err.textContent='';

  const isAlumni = (document.getElementById('tMode').value === 'alumni');
  const digit = document.getElementById('tDigit').value;

  if(!isValidTeacherAcc(account)){ err.textContent='教師帳號格式不正確。'; return; }
  if(password !== '123456'){ err.textContent='密碼錯誤。'; return; }

  if (isAlumni) {
    // 畢業生：不需要群科，需班級與學號首碼
    if(!clazz){ err.textContent='請選擇班級。'; return; }
    if(!digit){ err.textContent='請選擇學號首碼。'; return; }

    // 驗證通過後，直接帶參數進 teacher.html
    try{
      showBusy && showBusy(true);
      // 設定給 teacher.html 使用
      sessionStorage.setItem('teacherList', JSON.stringify({ mode:'alumni', clazz, digit }));
      location.href = 'teacher.html';
    } finally {
      showBusy && showBusy(false);
    }

  } else {
    // 在校生：需要群科與班級（維持原本）
    if(!dept || !clazz){ err.textContent='請選擇群科與班級。'; return; }
    try{
      showBusy && showBusy(true);
      sessionStorage.setItem('teacherList', JSON.stringify({ mode:'school', dept, clazz }));
      location.href = 'teacher.html';
    } finally {
      showBusy && showBusy(false);
    }
  }
});


/* 管理員登入（含一次性快取） */
document.getElementById('btnAdm').onclick = async () => {
  const err = document.getElementById('admErr'); err.textContent = '';
  const account = document.getElementById('aAcc').value.trim();
  const password = document.getElementById('aPwd').value;

  if(!account || !password){ err.textContent = '請輸入帳號與密碼'; return; }

  showBusy(true);
  try{
    // 驗證帳密
    const r = await gasPost({ path:'login_admin', account, password });
    if(!r.ok){ err.textContent = r.error || '登入失敗'; return; }

    // 一次載入「名冊+證照」與「導師名冊」
    const all = await gasPost({ path:'get_all_data' });
    if(!all.ok){ err.textContent = all.error || '載入資料失敗'; return; }

    sessionStorage.setItem('adminData', JSON.stringify(all));
    location.href = 'admin.html';
  }catch(e){
    err.textContent = '連線異常：' + e.message;
  }finally{
    showBusy(false);
  }
};
  </script>
</body>
</html>
