<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>教師批次更新</title>
<style>body {
    font-family: system-ui, "Noto Sans TC", sans-serif;
    margin: 0;
    padding: 0 20px;
    background: #fff;
    overflow: hidden;
}

h1 {
    font-size: 20px;
    margin-bottom: 8px;
}

.meta {
    color: #555;
    margin-bottom: 16px;
}

.meta .badge {
    display: inline-block;
    padding: 2px 6px;
    background: #f2f2f2;
    border-radius: 4px;
    margin-left: 6px;
    font-size: 12px;
    color: #666;
}

.actions {
    margin: 12px 0;
    display: flex;
    gap: 8px;
}

.note {
    color: #666;
    font-size: 12px;
}

.small {
    font-size: 12px;
}

.table-wrap {
    position: relative;
    overflow: auto;
    max-height: 80vh;
}

table {
    border-collapse: collapse;
    width: max-content;
    margin-top: 8px;
}

th,
td {
    border: 1px solid #ddd;
    padding: 4px 6px;
    font-size: 13px;
    vertical-align: top;
    white-space: nowrap;
    background: #fff;
}

thead th {
    position: sticky;
    top: 0;
    z-index: 5;
    background: #fafafa;
}

tbody tr:hover {
    background: #fffbe6;
    transition: background .15s ease;
}

input[type="text"] {
    width: 100%;
    box-sizing: border-box;
    padding: 4px 6px;
}

select {
    width: 100%;
    box-sizing: border-box;
    padding: 3px 4px;
}

:root {
    --c1: 0px;
    --c2: 0px;
    --c3: 0px;
    --c4: 0px;
}

th.sticky,
td.sticky {
    position: sticky;
    z-index: 4;
    background: #fff;
    box-shadow: 1px 0 0 #ccc inset;
}

th.c1,
td.c1 {
    left: 0;
}

th.c2,
td.c2 {
    left: var(--c1);
}

th.c3,
td.c3 {
    left: calc(var(--c1) + var(--c2));
}

th.c4,
td.c4 {
    left: calc(var(--c1) + var(--c2) + var(--c3));
}

.scrollbar-float {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 18px;
    background: #eee;
    overflow-x: auto;
    overflow-y: hidden;
    z-index: 9999;
}

.scrollbar-float::-webkit-scrollbar {
    height: 12px;
}

#busyMask {
    position: fixed;
    inset: 0;
    display: none;
    background: rgba(255, 255, 255, .6);
    backdrop-filter: blur(1px);
    align-items: center;
    justify-content: center;
    z-index: 9999
}

#busyMask .sp {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 6px solid #ccc;
    border-top-color: #4a7;
    animation: spin .9s linear infinite
}

@keyframes spin {
    to {
        transform: rotate(360deg)
    }
}

#teacherCertModal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, .35);
    z-index: 99999
}

#teacherCertModal .box {
    background: #fff;
    border-radius: 10px;
    min-width: 320px;
    max-width: 90vw;
    padding: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, .2)
}

#teacherCertModal .row {
    margin: 10px 0
}

#teacherCertModal input[type="text"] {
    width: 100%;
    box-sizing: border-box;
    padding: 6px
}

#teacherCertModal .btns {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 12px
}

.auto-gray {
    background: #f0f0f0 !important;
    cursor: not-allowed !important;
}

/* === Upload Progress (indeterminate + 真實百分比皆可) === */
#uploadProgress {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 24px;
    display: none;
    z-index: 10000
}

#uploadProgress .barWrap {
    height: 8px;
    background: #e5e7eb;
    border-radius: 999px;
    margin: 0 auto;
    max-width: 420px;
    overflow: hidden;
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .05)
}

#uploadProgress .bar {
    height: 100%;
    width: 0%;
    background: #22c55e;
    transition: width .25s ease
}

#uploadProgress .txt {
    font-size: 12px;
    color: #374151;
    text-align: center;
    margin-top: 6px
}

/* 乙/丙 自動帶出欄：窄一點就好 */
.auto-narrow {
    max-width: 72px !important;
    width: 72px !important;
}

.auto-narrow input,
.auto-narrow select {
    max-width: 100%;
}

</style>
</head>
<body>
<h1>教師批次更新</h1>
<div class="meta">
  角色:教師
  <span class="badge" id="deptBadge"></span>
  <span class="badge" id="classBadge"></span>
  <span class="badge" id="tutorBadge"></span>
</div>

<div class="actions">
  <button id="btnSave">確認送出</button>
  <button id="btnLogout" style="float:right">登出</button>
</div>

<div id="root">讀取中…</div>

<div class="note">
  提示:只有非「班級 / 座號 / 學號 / 姓名」欄位可編輯。每列會帶著來源工作表 <code>_sheet</code> 以便回寫。
</div>

<div id="busyMask"><div class="sp"></div></div>

<div id="teacherCertModal">
  <div class="box">
    <div class="row">
      <label>1.請輸入獲證字號</label>
      <input id="tc_certNo" type="text" placeholder="證號">
    </div>
    <div class="row">
      <label>2.請上傳證照圖片</label>
      <input id="tc_file" type="file" accept="image/*">
      <div id="tc_uploadHint" class="small" style="color:#555;margin-top:6px;"></div>
    </div>
    <div class="btns">
      <button id="tc_cancel">取消</button>
      <button id="tc_ok">確認</button>
    </div>
  </div>
</div>
<div id="uploadProgress">
  <div class="barWrap"><div class="bar"></div></div>
  <div class="txt">圖片上傳中… 0%</div>
</div>

< script >
    window.onerror = function(message, source, lineno, colno, error) {
        alert('JS 錯誤：' + message + '\n於 ' + source + ':' + lineno + ':' + colno);
    };

function getSidByRow(rowIdx) {
    // 找出表頭裡的「學號」欄名（避免有人改成 XXX學號 之類）
    const sidKey = headers.find(h => String(h).includes('學號')) || '學號';
    return String(rows?.[rowIdx]?.[sidKey] ?? '').trim();
}

function showBusy(on) {
    const m = document.getElementById('busyMask');
    if (m) m.style.display = on ? 'flex' : 'none';
}

function showUploadProgress(show, percent) {
    const box = document.getElementById('uploadProgress');
    if (!box) return;
    const bar = box.querySelector('.bar');
    const txt = box.querySelector('.txt');
    if (show) {
        box.style.display = 'block';
        if (typeof percent === 'number') {
            const p = Math.max(0, Math.min(100, Math.floor(percent)));
            bar.style.width = p + '%';
            if (txt) txt.textContent = '圖片上傳中… ' + p + '%';
        }
    } else {
        bar.style.width = '100%';
        if (txt) txt.textContent = '完成 100%';
        setTimeout(() => {
            box.style.display = 'none';
            bar.style.width = '0%';
        }, 500);
    }
}

(function() {
    if (!window.dbg) {
        window.dbg = function(title, obj) {
            const on = new URLSearchParams(location.search).get('debug') === '1' ||
                (localStorage.getItem('debug') === '1');
            if (!on) return;
            console.log('[DBG]', title, obj);
        };
    }
})();

const GAS_BASE = '/api/gas';
async function apiGet(path, params) {
    const url = GAS_BASE + '?' + new URLSearchParams({
        path,
        ...params
    });
    dbg('GET ' + url, null);
    const r = await fetch(url);
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try {
        return JSON.parse(txt);
    } catch {
        return {
            ok: false,
            as: 'html',
            status: r.status,
            body: txt
        };
    }
}

async function apiPost(path, params) {
    const body = new URLSearchParams({
        path,
        ...params
    }).toString();
    dbg('POST ' + GAS_BASE, body);
    const r = await fetch(GAS_BASE, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body
    });
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try {
        return JSON.parse(txt);
    } catch {
        return {
            ok: false,
            as: 'html',
            status: r.status,
            body: txt
        };
    }
}

const token = localStorage.getItem('token');
const role = localStorage.getItem('role');
const dept = localStorage.getItem('dept');
const classId = localStorage.getItem('classId');
const tutor = localStorage.getItem('tutor');

if (role !== 'teacher') {
    window.location.href = 'index.html';
}

document.getElementById('deptBadge').textContent = dept || '';
document.getElementById('classBadge').textContent = classId ? ('班級:' + classId) : '';
document.getElementById('tutorBadge').textContent = tutor ? ('導師:' + tutor) : '';

let headers = [];
let rows = [];
let editableGlobal = [];
let editableBySheet = {};
let originalRowsMap = new Map();
let editableKeys = [];

function keyOf(r) {
    return String(r['學號'] || '') + '|' + String(r['_sheet'] || '');
}

async function loadClass(force = false) {
    showBusy(true);
    try {
        let res = null;

        if (!force) {
            const cached = localStorage.getItem('teacherClassData');
            if (cached) {
                try {
                    res = JSON.parse(cached);
                } catch (e) {}
            }
        }

        if (!res) {
            const dept = localStorage.getItem('dept') || '';
            const classId = localStorage.getItem('classId') || '';
            const digit = localStorage.getItem('digit') || '';
            if (!dept || !classId) {
                alert('請先在首頁選擇群科與班級後再進入教師頁');
                location.href = 'index.html';
                return;
            }
            const token = localStorage.getItem('token') || '';
            const role = localStorage.getItem('role') || '';
            if (!token || role !== 'teacher') {
                alert('請重新以教師身分登入');
                location.href = 'index.html';
                return;
            }

            // 重新抓資料（不使用快取）
            res = await apiGet('class.bySheet', {
                token,
                dept,
                classId,
                digit
            });
            if (!res.ok) throw new Error(res.error || '讀取失敗');

            // 更新快取
            localStorage.setItem('teacherClassData', JSON.stringify(res));
        }
        headers = res.headers || [];
        rows = res.rows || [];
        editableKeys = res.editable || headers.filter(h => !['_sheet', '班級', '座號', '學號', '姓名'].includes(h));

        // 重建 baseline
        originalRowsMap.clear();
        rows.forEach(r => originalRowsMap.set(keyOf(r), JSON.parse(JSON.stringify(r))));

        renderTable();
    } finally {
        showBusy(false);
    }
}



function renderTable() {

    const root = document.getElementById('root');
    if (!rows.length) {
        root.innerHTML = '查無資料(請確認班級/科別是否正確)';
        return;
    }

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    function parseHyperlinkFormula(str) {
        const s = String(str || '').trim();
        if (!/^=HYPERLINK\(/i.test(s)) return null;
        // 取第一個 URL 與顯示文字
        const m1 = s.match(/HYPERLINK\(\s*"([^"]+)"\s*,\s*"([^"]*)"\s*\)/i) ||
            s.match(/HYPERLINK\(\s*'([^']+)'\s*,\s*'([^']*)'\s*\)/i);
        if (!m1) return null;
        return {
            url: m1[1],
            text: m1[2] || m1[1]
        };
    }

    // === 表頭(不顯示 _sheet) ===
    const trh = document.createElement('tr');
    headers.forEach((h, i) => {
        if (h === '_sheet') return;
        const th = document.createElement('th');

        // ★ 修正：顯示時去掉唯一鍵前綴「獲證字號|」
        let displayName = h;
        if (/^獲證字號\|/.test(h)) {
            displayName = '獲證字號';
        }
        th.textContent = displayName;
        const isAutoSuffix = /[乙丙]$/.test(h);
        if (isAutoSuffix) th.classList.add('auto-narrow');
        if (i < 4) th.classList.add('sticky', 'c' + (i + 1));
        trh.appendChild(th);
    });
    thead.appendChild(trh);

    // === 資料列 ===
    rows.forEach((r, rowIdx) => {
        const tr = document.createElement('tr');

        headers.forEach((h, colIdx) => {
            if (h === '_sheet') return;
            const td = document.createElement('td');
            const isAutoSuffix = /[乙丙]$/.test(h);
            if (isAutoSuffix) td.classList.add('auto-narrow');
            if (colIdx < 4) td.classList.add('sticky', 'c' + (colIdx + 1));

            // ★ 取值時要用原始的 key (包含唯一鍵格式)
            const val = r[h] ?? '';

            const isFixed = ['班級', '座號', '學號', '姓名', '_sheet'].includes(h);
            const canEdit = !isFixed && Array.isArray(editableKeys) && editableKeys.includes(h);

            if (!canEdit) {
                td.textContent = (val == null ? '' : String(val));
            } else {
                const lastChar = String(h).slice(-1);
                if (lastChar === '科') {
                    td.innerHTML =
                        `<select data-row="${rowIdx}" data-key="${h}">
               <option value=""></option>
               <option value="及格" ${val==='及格'?'selected':''}>及格</option>
               <option value="不及格" ${val==='不及格'?'selected':''}>不及格</option>
             </select>`;
                } else {
                    // ★ 關鍵修正：確保值正確轉義 HTML 特殊字符
                    const safeVal = String(val ?? '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    td.innerHTML = `<input type="text" data-row="${rowIdx}" data-key="${h}" value="${safeVal}" />`;
                }
            }

            // ---- 統一改寫：僅在「有證號但沒有圖片連結」時，加入「更改/上傳」按鈕 ----
            const isCertNoCol = String(h).trim() === '獲證字號' || /^獲證字號\|/.test(h);
            if (isCertNoCol) {
                const link = parseHyperlinkFormula(val);
                const certText = String(val || '').trim();

                if (link) {
                    // 有 HYPERLINK：顯示可點連結 + 綠勾
                    td.innerHTML = `<a href="${link.url}" target="_blank" rel="noopener">${link.text || '檢視圖片'}</a>` +
                        `<span style="color:#16a34a;font-weight:600;margin-left:4px">✔</span>`;
                } else {
                    // 沒連結
                    if (certText) {
                        // 有證號（但沒連結）→ 顯示原本的內容，並在同一格右側加「更改/上傳」
                        if (!canEdit) {
                            td.textContent = certText;
                        } else {
                            const safeVal = String(val ?? '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            td.innerHTML = `<input type="text" data-row="${rowIdx}" data-key="${h}" value="${safeVal}" />`;
                        }
                        const btn = document.createElement('button');
                        btn.textContent = '更改/上傳';
                        btn.className = 'small';
                        btn.style.display = 'inline-block';
                        btn.style.marginLeft = '6px';
                        btn.style.verticalAlign = 'middle';
                        btn.addEventListener('click', (ev) => {
                            ev.preventDefault();
                            if (typeof openTeacherCertModal === 'function') {
                                openTeacherCertModal(rowIdx, h, td.querySelector('input,textarea') || null);
                            } else {
                                teacherCertModal.rowIdx = rowIdx;
                                teacherCertModal.certInput = td.querySelector('input,textarea') || null;
                                teacherCertModal.autoKey = h;
                                document.getElementById('teacherCertModal').style.display = 'flex';
                                teacherCertModal.input && teacherCertModal.input.focus();
                            }
                        });
                        td.appendChild(btn);
                    } else {
                        // 既沒有連結、也沒有證號 → 不顯示按鈕，維持原邏輯
                        if (!canEdit) {
                            td.textContent = '';
                        } else {
                            const safeVal = String(val ?? '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            td.innerHTML = `<input type="text" data-row="${rowIdx}" data-key="${h}" value="${safeVal}" />`;
                        }
                    }
                }
            }

            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);

    function enforceReadOnlyAutoCols(tbodyRoot) {
        const inputs = tbodyRoot.querySelectorAll('input[data-key], select[data-key]');
        inputs.forEach(el => {
            const key = el.dataset.key || '';
            const last = key.slice(-1);
            const isAutoGet = (last === '乙' || last === '丙');
            const isCertNo = /字號$/.test(key) || key.includes('獲證字號') || /^獲證字號\|/.test(key);

            if (isAutoGet || isCertNo) {
                if (el.tagName === 'SELECT') {
                    el.disabled = true;
                } else {
                    el.readOnly = true;
                }
                el.classList.add('auto-gray');
            }
        });
    }

    function findCertNumberInputByAutoCol(rowIdx, autoColKey) {
        const autoIdx = headers.indexOf(autoColKey);
        const maybeNextKey = headers[autoIdx + 1];
        if (maybeNextKey) {
            const isCert = /字號$/.test(maybeNextKey) || String(maybeNextKey).includes('獲證字號') || /^獲證字號\|/.test(maybeNextKey);
            if (isCert) {
                return document.querySelector(`[data-row="${rowIdx}"][data-key="${maybeNextKey}"]`);
            }
        }
        for (const h of headers) {
            if (/字號$/.test(h) || String(h).includes('獲證字號') || /^獲證字號\|/.test(h)) {
                const el = document.querySelector(`[data-row="${rowIdx}"][data-key="${h}"]`);
                if (el) return el;
            }
        }
        return null;
    }

    root.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'table-wrap';
    wrap.appendChild(table);
    root.appendChild(wrap);
    enforceReadOnlyAutoCols(tbody);

    (function computeFrozen() {
        const ths = wrap.querySelectorAll('thead th');
        if (ths.length >= 4) {
            const c1 = ths[0].offsetWidth;
            const c2 = ths[1].offsetWidth;
            const c3 = ths[2].offsetWidth;
            const c4 = ths[3].offsetWidth;
            const rs = document.documentElement.style;
            rs.setProperty('--c1', c1 + 'px');
            rs.setProperty('--c2', c2 + 'px');
            rs.setProperty('--c3', c3 + 'px');
            rs.setProperty('--c4', c4 + 'px');
        }
    })();

    window.addEventListener('resize', () => {
        const ths = document.querySelectorAll('.table-wrap thead th');
        if (ths.length >= 4) {
            const rs = document.documentElement.style;
            rs.setProperty('--c1', ths[0].offsetWidth + 'px');
            rs.setProperty('--c2', ths[1].offsetWidth + 'px');
            rs.setProperty('--c3', ths[2].offsetWidth + 'px');
            rs.setProperty('--c4', ths[3].offsetWidth + 'px');
        }
    });

    let floatScroll = document.querySelector('.scrollbar-float');
    if (!floatScroll) {
        floatScroll = document.createElement('div');
        floatScroll.className = 'scrollbar-float';
        document.body.appendChild(floatScroll);
    }
    floatScroll.innerHTML = '<div style="width:' + wrap.scrollWidth + 'px;height:1px;"></div>';
    floatScroll.onscroll = () => {
        wrap.scrollLeft = floatScroll.scrollLeft;
    };
    wrap.onscroll = () => {
        floatScroll.scrollLeft = wrap.scrollLeft;
    };

    // ===== 教師端:獲證 → 開窗(可選上傳,不強制) =====
    const teacherCertModal = {
        box: null,
        input: null,
        ok: null,
        cancel: null,
        hint: null,
        rowIdx: null,
        autoKey: null,
        certInput: null,
        file: null,
        fileBase64: '',
        fileMime: '',
        fileName: ''
    };

    (function initTeacherCertModal() {
        const m = document.getElementById('teacherCertModal');
        if (!m) return;
        teacherCertModal.box = m;
        teacherCertModal.input = document.getElementById('tc_certNo');
        teacherCertModal.ok = document.getElementById('tc_ok');
        teacherCertModal.cancel = document.getElementById('tc_cancel');
        teacherCertModal.hint = document.getElementById('tc_uploadHint');
        const fileInput = document.getElementById('tc_file');

        fileInput.addEventListener('change', async (ev) => {
            const f = ev.target.files && ev.target.files[0];
            teacherCertModal.file = f || null;
            teacherCertModal.fileBase64 = '';
            teacherCertModal.fileMime = '';
            teacherCertModal.fileName = '';
            if (teacherCertModal.hint) teacherCertModal.hint.textContent = '';
            if (!f) return;

            if (teacherCertModal.hint) teacherCertModal.hint.textContent = '圖片讀取中…';
            const base64 = await new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = () => {
                    const raw = (typeof r.result === 'string') ? r.result : '';
                    const idx = raw.indexOf(',');
                    res(idx >= 0 ? raw.slice(idx + 1) : ''); // 不再直接對 undefined 做 split
                };
                r.onerror = rej;
                r.readAsDataURL(f);
            });
            teacherCertModal.fileBase64 = base64;
            teacherCertModal.fileMime = f.type || 'image/jpeg';
            teacherCertModal.fileName = f.name || 'certificate.jpg';
            if (teacherCertModal.hint) teacherCertModal.hint.textContent = '圖片已就緒(按「確認」時一併上傳)';
        });

        teacherCertModal.ok.addEventListener('click', async () => {
            if (teacherCertModal.__busy) return;
            teacherCertModal.__busy = true;
            const okBtn = document.getElementById('tc_ok');
            const cancelBtn = document.getElementById('tc_cancel');
            if (okBtn) okBtn.disabled = true;
            if (cancelBtn) cancelBtn.disabled = true;

            try {
                // 使用者可不輸入 → 空白表示沿用原本的證號
                let inputNo = String((teacherCertModal.input && teacherCertModal.input.value) || '').trim();
                if (!inputNo && teacherCertModal.certInput) {
                    inputNo = String(teacherCertModal.certInput.value || '').trim();
                }

                // 回寫輸入框文字
                if (teacherCertModal.certInput) {
                    teacherCertModal.certInput.value = no;
                }

                // 決定證照名稱（安全版，不會在 undefined 上 split）
                const safeAutoKey =
                    String(teacherCertModal.autoKey ?? teacherCertModal.autoColKey ?? teacherCertModal.autoKeyRaw ?? '');
                const certName = inferCertNameFromAutoCol(safeAutoKey) || '證照';

                // 若本輪同時選了圖片 → 上傳
                if (teacherCertModal.fileBase64) {
                    try {
                        showBusy(true);
                        const token = localStorage.getItem('token') || '';
                        const dept = localStorage.getItem('dept') || '';
                        const designSub = localStorage.getItem('designSub') || '';

                        const sid = (typeof getSidByRow === 'function') ?
                            getSidByRow(Number(teacherCertModal.rowIdx)) :
                            '';
                        let sim = 1,
                            simTimer = null;

                        function startSimProgress() {
                            showUploadProgress(true, 1);
                            sim = 1;
                            simTimer = setInterval(() => {
                                sim = Math.min(90, sim + 1 + Math.floor(Math.random() * 3)); // 緩慢走到 90%
                                showUploadProgress(true, sim);
                                if (sim >= 90) clearInterval(simTimer);
                            }, 180);
                        }

                        function endSimProgress() {
                            if (simTimer) clearInterval(simTimer);
                            showUploadProgress(true, 100);
                            setTimeout(() => showUploadProgress(false), 400);
                        }
                        if (teacherCertModal.fileBase64) {
                            try {
                                startSimProgress();
                                const resp = await apiPost('upload.certificate', {
                                    token,
                                    dept,
                                    designSub,
                                    base64: teacherCertModal.fileBase64,
                                    mimeType: teacherCertModal.fileMime || 'image/jpeg',
                                    certName, // ← 用安全推導的完整證照名稱（如：汽修-丙）
                                    sid
                                });
                                endSimProgress();

                                if (!resp.ok) {
                                    alert(resp.error || '上傳失敗');
                                } else {
                                    if (resp.url && teacherCertModal.certInput) {
                                        const td = teacherCertModal.certInput.closest('td');
                                        if (td) {
                                            td.innerHTML = `<a href="${resp.url}" target="_blank">${teacherCertModal.certInput.value}</a><span style="color:#16a34a;font-weight:600"> ✔</span>`;
                                        }
                                    }
                                }
                            } finally {
                                endSimProgress();
                            }
                        }

                        if (!resp.ok) {
                            alert(resp.error || '上傳失敗');
                        } else {
                            // 成功提示（你要求的訊息）
                            alert('上傳圖片完成，請記得按「確認送出」。');
                            const url = String(resp.url || resp.webViewLink || '').replace(/"/g, '');
                            if (url) {
                                // 以 inputNo 作為顯示文字；若沒有，就顯示「檢視圖片」
                                const showText = (inputNo && inputNo.trim()) ? inputNo.trim() : '檢視圖片';

                                // 立即更新同一格為連結 + 綠勾
                                if (teacherCertModal.certInput) {
                                    const td = teacherCertModal.certInput.closest('td');
                                    if (td) {
                                        td.innerHTML =
                                            `<a href="${url}" target="_blank" rel="noopener">${showText}</a>` +
                                            `<span style="color:#16a34a;font-weight:600;margin-left:4px">✔</span>`;
                                    }
                                    // 同時把 input 值換成 HYPERLINK 公式，讓「確認送出」回寫時，後端可直接 setFormula
                                    teacherCertModal.certInput.value = `=HYPERLINK("${url}","${(showText||'').replace(/"/g,'""')}")`;
                                }
                            }
                            // 暫存連結，等等把字號改成 HYPERLINK(url,"字號")
                            teacherCertModal.linkUrl = resp.url || resp.webViewLink || '';

                            if (teacherCertModal.hint) {
                                teacherCertModal.hint.textContent = '已上傳圖片(連結已建立)';
                            }
                            const td = teacherCertModal.certInput && teacherCertModal.certInput.closest('td');
                            if (td) td.dataset.hasFile = '1';
                        }
                    } finally {
                        showBusy(false);
                    }
                }

                // 若有上傳連結 & 有輸入字號 → 把文字改成 HYPERLINK 公式（送出時後端會用 setFormula 寫入）
                if (teacherCertModal.linkUrl && teacherCertModal.certInput && teacherCertModal.certInput.value) {
                    const url = String(teacherCertModal.linkUrl).replace(/"/g, '');
                    const num = String(teacherCertModal.certInput.value).replace(/"/g, '""');
                    teacherCertModal.certInput.value = `=HYPERLINK("${url}","${num}")`;
                    teacherCertModal.linkUrl = '';
                }

                if (typeof closeTeacherCertModal === 'function') closeTeacherCertModal();
                return;

            } catch (err) {
                alert(err && err.message ? err.message : '處理時發生錯誤');
            } finally {
                teacherCertModal.__busy = false;
                if (okBtn) okBtn.disabled = false;
                if (cancelBtn) cancelBtn.disabled = false;
            }
        });



        // ★ 修正:只有取消按鈕才清空前兩欄
        teacherCertModal.cancel.addEventListener('click', () => {
            alert('由於您未填字號,系統自動將學科/術科內容清除');
            clearRowByModalContext();
            closeTeacherCertModal();
        });

        function clearRowByModalContext() {
            const kAuto = teacherCertModal.autoKey;
            const autoIdx = headers.indexOf(kAuto);
            const k1 = headers[autoIdx - 2];
            const k2 = headers[autoIdx - 1];
            const row = teacherCertModal.rowIdx;

            const el1 = document.querySelector(`[data-row="${row}"][data-key="${k1}"]`);
            const el2 = document.querySelector(`[data-row="${row}"][data-key="${k2}"]`);
            if (el1) el1.value = '';
            if (el2) el2.value = '';

            const certNoInp = teacherCertModal.certInput;
            const autoInp = document.querySelector(`[data-row="${row}"][data-key="${kAuto}"]`);
            if (autoInp) autoInp.value = '';
            if (certNoInp) certNoInp.value = '';
        }

        function inferCertNameFromAutoCol(autoKey) {
            // 將任何輸入先安全轉字串
            const s = String(autoKey == null ? '' : autoKey).trim();
            if (!s) return '證照';

            // 已經是「xxx-乙/丙」→ 直接回傳
            if (/(乙|丙)$/.test(s)) return s;

            // 「獲證字號|base」→ 安全取 base（不 split）
            let baseFromKey = '';
            if (s.indexOf('獲證字號|') === 0) {
                baseFromKey = s.slice('獲證字號|'.length);
            }

            // 取左邊 base：先用 baseFromKey；否則若字串內含 '-' 再 split；最後移除常見尾綴
            const baseCandidate = (baseFromKey && String(baseFromKey)) || s;
            const base = baseCandidate.indexOf('-') >= 0 ?
                baseCandidate.split('-')[0] :
                baseCandidate.replace(/(學科|術科|學|術|乙|丙)$/, '').replace(/[-_/]+$/, '');

            // 再看最後一字是否為「乙/丙」
            const last = s.slice(-1);
            if (last === '乙' || last === '丙') return `${base}-${last}`;

            return base || '證照';
        }



        function closeTeacherCertModal() {
            teacherCertModal.box.style.display = 'none';
            teacherCertModal.rowIdx = teacherCertModal.autoKey = teacherCertModal.certInput = null;
            teacherCertModal.input.value = '';
            teacherCertModal.file = null;
            teacherCertModal.fileBase64 = '';
            teacherCertModal.fileMime = '';
            teacherCertModal.fileName = '';
            if (teacherCertModal.hint) teacherCertModal.hint.textContent = '';
            const fi = document.getElementById('tc_file');
            if (fi) fi.value = '';
        }

        window.openTeacherCertModal = function(rowIdx, autoKey, certInput) {
            teacherCertModal.rowIdx = rowIdx;
            teacherCertModal.autoKey = autoKey;
            teacherCertModal.certInput = certInput || null;
            teacherCertModal.input.value = '';
            teacherCertModal.box.style.display = 'flex';
            setTimeout(() => teacherCertModal.input.focus(), 0);
        };
    })();

    (function bindRulesOnce() {
        const container = document.getElementById('root');
        if (!container || container.__rulesBound) return;
        container.__rulesBound = true;

        container.addEventListener('change', (ev) => {
            const el = ev.target;
            if (!el.matches('input[data-key], select[data-key]')) return;
            const rowIdx = Number(el.dataset.row);
            const key = el.dataset.key;
            const headersIdx = headers.indexOf(key);
            const lastChar = key.slice(-1);

            headers.forEach((h, colIdx) => {
                const endChar = h.slice(-1);
                if (endChar === '乙' || endChar === '丙') {
                    const k1 = headers[colIdx - 2];
                    const k2 = headers[colIdx - 1];
                    if (!k1 || !k2) return;

                    const sel1 = container.querySelector(`[data-row="${rowIdx}"][data-key="${k1}"]`);
                    const sel2 = container.querySelector(`[data-row="${rowIdx}"][data-key="${k2}"]`);
                    const autoEl = container.querySelector(`[data-row="${rowIdx}"][data-key="${h}"]`);
                    const certEl = findCertNumberInputByAutoCol(rowIdx, h);

                    if (!sel1 || !sel2 || !autoEl) return;

                    const v1 = (sel1.value || '').trim();
                    const v2 = (sel2.value || '').trim();
                    const prevVal = (autoEl.value || '').trim();

                    if (v1 === '及格' && v2 === '及格') {
                        autoEl.value = '獲證';
                        if (prevVal !== '獲證') {
                            window.openTeacherCertModal(rowIdx, h, certEl);
                        }
                    } else {
                        autoEl.value = '';
                        if (certEl) certEl.value = '';
                    }
                }
            });

            if (lastChar === '號') {
                const kPrev = headers[headersIdx - 1];
                if (kPrev) {
                    const prevEl = container.querySelector(`[data-row="${rowIdx}"][data-key="${kPrev}"]`);
                    const prevVal = prevEl ? prevEl.value : '';
                    const curVal = el.value;
                    if (prevVal === '獲證' && !curVal) {
                        el.style.border = '1px solid #e11';
                        alert(`您已取得「${key}」證照,請輸入獲證字號`);
                    } else {
                        el.style.border = '';
                    }
                }
            }
        });
    })();
}

function collectUpdates() {
    const inputs = document.querySelectorAll('input[data-row][data-key], select[data-row][data-key]');
    const changedByRow = new Map();

    inputs.forEach(inp => {
        const rowIdx = Number(inp.dataset.row);
        const key = inp.dataset.key;
        if (key === '_sheet') return;
        const newVal = inp.value;
        const row = rows[rowIdx];
        const orig = originalRowsMap.get(keyOf(row)) || {};
        const oldVal = orig[key] ?? '';

        if (String(newVal) !== String(oldVal)) {
            if (!changedByRow.has(rowIdx)) {
                changedByRow.set(rowIdx, {
                    sid: String(row['學號'] || ''),
                    _sheet: row._sheet,
                    changes: {}
                });
            }
            changedByRow.get(rowIdx).changes[key] = newVal;
        }
    });

    const updates = [];
    changedByRow.forEach(v => {
        if (v.sid && v._sheet && Object.keys(v.changes).length) updates.push(v);
    });

    return updates;
}

document.getElementById('btnSave').addEventListener('click', async () => {
    showBusy(true);
    try {
        const token = localStorage.getItem('token') || '';
        const role = localStorage.getItem('role') || '';
        const dept = localStorage.getItem('dept') || '';

        if (!token || role !== 'teacher') {
            alert('請重新以教師身分登入');
            location.href = 'index.html';
            return;
        }

        const updates = collectUpdates();
        if (!updates.length) {
            alert('沒有變更');
            return;
        }

        const res = await apiPost('class.bulkUpdate', {
            token,
            dept,
            updates: JSON.stringify(updates)
        });
        if (!res.ok) throw new Error(res.error || '更新失敗');

        alert('已送出！更新筆數：' + (res.updated || 0));
        localStorage.removeItem('teacherClassData'); // 清快取
        await loadClass(true); // 強制重抓最新

        // 如果你偏好送出後直接回首頁（登入頁），改用這行：
        // location.href = 'index.html';
    } catch (err) {
        alert(err.message || '送出失敗');
    } finally {
        showBusy(false);
    }
});

document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
});

loadClass().catch(err => alert(err.message)); 
  </script>
  </body>
</html>
