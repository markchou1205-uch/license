<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>教師批次更新</title>
<style>
  /* 版面與文字 */
  body{
    font-family: system-ui, "Noto Sans TC", sans-serif;
    margin: 0;
    padding: 0 20px;            /* 左右各 20px */
    background: #fff;
    overflow: hidden;           /* 避免雙重捲軸 */
  }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .meta { color:#555; margin-bottom: 16px; }
  .meta .badge { display:inline-block; padding:2px 6px; background:#f2f2f2; border-radius:4px; margin-left:6px; font-size:12px; color:#666; }
  .actions { margin: 12px 0; display:flex; gap:8px; }
  .note { color:#666; font-size:12px; }
  .small { font-size:12px; }

  /* 表格容器與表格 */
  .table-wrap { position: relative; overflow: auto; max-height: 80vh; }
  table { border-collapse: collapse; width: max-content; margin-top: 8px; }
  th, td {
    border: 1px solid #ddd;
    padding: 4px 6px;
    font-size: 13px;
    vertical-align: top;
    white-space: nowrap;        /* 不換行，讓欄名完整展開 */
    background: #fff;           /* 預設白底，搭配 sticky 不會透出 */
  }
  thead th { position: sticky; top: 0; z-index: 5; background: #fafafa; }
  tbody tr:hover { background: #fffbe6; transition: background .15s ease; }

  /* 輸入元件 */
  input[type="text"] { width: 100%; box-sizing: border-box; padding: 4px 6px; }
  select { width: 100%; box-sizing: border-box; padding: 3px 4px; }

  /* ===== 前 4 欄凍結（用 CSS 變數計算 left，避免硬編數字） ===== */
  :root { --c1:0px; --c2:0px; --c3:0px; --c4:0px; }  /* 由 JS 依表頭實際寬度注入 */
  th.sticky, td.sticky {
    position: sticky;
    z-index: 4;
    background: #fff;                 /* 不透明底色，避免被後方欄位穿透 */
    box-shadow: 1px 0 0 #ccc inset;   /* 右邊緣描線 */
  }
  /* 依序位移（請在渲染時給 th/td 加上 sticky + c1~c4）*/
  th.c1, td.c1 { left: 0; }
  th.c2, td.c2 { left: var(--c1); }
  th.c3, td.c3 { left: calc(var(--c1) + var(--c2)); }
  th.c4, td.c4 { left: calc(var(--c1) + var(--c2) + var(--c3)); }

  /* ===== 底部浮動橫向捲軸（JS 會同步寬度與位置） ===== */
  .scrollbar-float {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 18px;
    background: #eee;
    overflow-x: auto;
    overflow-y: hidden;
    z-index: 9999;
  }
  .scrollbar-float::-webkit-scrollbar { height: 12px; }
</style>

</head>
<body>
<h1>教師批次更新</h1>
<div class="meta">
  角色：教師
  <span class="badge" id="deptBadge"></span>
  <span class="badge" id="classBadge"></span>
  <span class="badge" id="tutorBadge"></span>
  <button id="btnLogout" style="float:right">登出</button>
</div>

<div class="actions">
  <button id="btnReload">重新載入</button>
  <button id="btnSave">確認送出（批次更新）</button>
</div>

<div id="root">讀取中…</div>

<div class="note">
  提示：只有非「班級 / 座號 / 學號 / 姓名」欄位可編輯。每列會帶著來源工作表 <code>_sheet</code> 以便回寫。
</div>

<style>
  #busyMask{position:fixed;inset:0;display:none;background:rgba(255,255,255,.6);backdrop-filter:blur(1px);align-items:center;justify-content:center;z-index:9999}
  #busyMask .sp{width:48px;height:48px;border-radius:50%;border:6px solid #ccc;border-top-color:#4a7;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
<div id="busyMask"><div class="sp"></div></div>
<!-- 教師：獲證 → 證號 / 上傳提醒 對話框 -->
<style>
  #teacherCertModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:99999}
  #teacherCertModal .box{background:#fff;border-radius:10px;min-width:320px;max-width:90vw;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  #teacherCertModal .row{margin:10px 0}
  #teacherCertModal input[type="text"]{width:100%;box-sizing:border-box;padding:6px}
  #teacherCertModal .btns{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .auto-gray{background:#f0f0f0 !important; cursor:not-allowed !important;}
</style>
<div id="teacherCertModal">
  <div class="box">
    <div class="row"><b>系統判定為「獲證」</b></div>
    <div class="row">請填寫「獲證字號」。<br>（不強制上傳照片；若未上傳，請務必通知學生自行上傳）</div>
    <div class="row">
      <label>獲證字號</label>
      <input id="tc_certNo" type="text" placeholder="請輸入證號">
    </div>
    <div class="row small" id="tc_hint" style="color:#555">提示：教師端不強制上傳照片；若無照片，請告知學生到「學生頁」上傳。</div>
    <div class="btns">
      <button id="tc_cancel">取消</button>
      <button id="tc_ok">確認</button>
    </div>
  </div>
</div>

<script>
function showBusy(on){ const m=document.getElementById('busyMask'); if(m) m.style.display = on ? 'flex' : 'none'; }

    // 若未定義 dbg，就提供 fallback；開啟 ?debug=1 才會輸出
(function(){
  if (!window.dbg) {
    window.dbg = function(title, obj) {
      const on = new URLSearchParams(location.search).get('debug') === '1' ||
                 (localStorage.getItem('debug') === '1');
      if (!on) return;
      console.log('[DBG]', title, obj);
    };
  }
})();
  const GAS_BASE = '/api/gas';
  async function apiGet(path, params) {
    const url = GAS_BASE + '?' + new URLSearchParams({ path, ...params });
    dbg('GET ' + url, null);
    const r = await fetch(url);
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try { return JSON.parse(txt); } catch { return { ok:false, as:'html', status:r.status, body:txt }; }
  }

  async function apiPost(path, params) {
    const body = new URLSearchParams({ path, ...params }).toString();
    dbg('POST ' + GAS_BASE, body);
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try { return JSON.parse(txt); } catch { return { ok:false, as:'html', status:r.status, body:txt }; }
  }

  const token   = localStorage.getItem('token');
  const role    = localStorage.getItem('role');
  const dept    = localStorage.getItem('dept');
  const classId = localStorage.getItem('classId');
  const tutor   = localStorage.getItem('tutor');

if (role !== 'teacher') {
  window.location.href = 'index.html';
}

  document.getElementById('deptBadge').textContent = dept || '';
  document.getElementById('classBadge').textContent = classId ? ('班級：' + classId) : '';
  document.getElementById('tutorBadge').textContent = tutor ? ('導師：' + tutor) : '';

  let headers = [];
  let rows = [];
  let editableGlobal = [];
  let editableBySheet = {};
  let originalRowsMap = new Map(); // key: sid + _sheet → 原始 row 物件

  function keyOf(r){ return String(r['學號'] || '') + '|' + String(r['_sheet'] || ''); }

async function loadClass() {
  showBusy(true);
  // 1) 先吃首頁登入時快取好的資料（若有）
  let res = null;
  const cached = localStorage.getItem('teacherClassData');
  if (cached) {
    try { res = JSON.parse(cached); } catch (e) {}
  }

  // 2) 沒快取，就用 dept/classId/digit 直接打 class.bySheet（不需要 token）
  if (!res) {
    const dept    = localStorage.getItem('dept')    || '';
    const classId = localStorage.getItem('classId') || '';
    const digit   = localStorage.getItem('digit')   || '';
    if (!dept || !classId) {
      alert('請先在首頁選擇群科與班級後再進入教師頁');
      location.href = 'index.html';
      return;
    }
    res = await apiGet('class.bySheet', { dept, classId, digit });
  }

  if (!res || res.ok !== true) {
    throw new Error((res && res.error) || '讀取失敗');
  }

  // 3) 正常渲染（以下名稱依你的檔案而定）
  headers         = res.headers || [];
  rows            = res.rows || [];
  editableGlobal  = res.editable || [];
  editableBySheet = res.editableBySheet || {};

  originalRowsMap.clear();
  rows.forEach(r => originalRowsMap.set(keyOf(r), JSON.parse(JSON.stringify(r))));
  
  renderTable();
  showBusy(false);
}

function renderTable() {
  const root = document.getElementById('root');
  if (!rows.length) { root.innerHTML = '查無資料（請確認班級/科別是否正確）'; return; }

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const tbody = document.createElement('tbody');

  // === 表頭（不顯示 _sheet） ===
  const trh = document.createElement('tr');
  headers.forEach((h, i) => {
    if (h === '_sheet') return;                     // ← 隱藏 _sheet 欄
    const th = document.createElement('th');
    th.textContent = h;
    if (i < 4) th.classList.add('sticky', 'c' + (i + 1)); // 凍結前 4 欄（依原索引 i）
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  // === 資料列 ===
  rows.forEach((r, rowIdx) => {
    const tr = document.createElement('tr');

    headers.forEach((h, colIdx) => {
      if (h === '_sheet') return;                  // ← 隱藏 _sheet 欄
      const td = document.createElement('td');
      if (colIdx < 4) td.classList.add('sticky', 'c' + (colIdx + 1)); // 凍結前 4 欄（依原索引 colIdx）

      const val = r[h] ?? '';
      const editableByThisSheet = (editableBySheet && editableBySheet[r._sheet]) || editableGlobal || [];
      const canEditThisSheet = editableByThisSheet.includes(h);
      const isFixed = ['班級','座號','學號','姓名'].includes(h);

      if (isFixed || !canEditThisSheet) {
        // 只讀欄
        td.textContent = (val == null ? '' : String(val));
      } else {
        // 可編欄
        const lastChar = String(h).slice(-1);
        if (lastChar === '科') {
          // 下拉：及格 / 不及格
          td.innerHTML =
            `<select data-row="${rowIdx}" data-key="${h}">
               <option value=""></option>
               <option value="及格" ${val==='及格'?'selected':''}>及格</option>
               <option value="不及格" ${val==='不及格'?'selected':''}>不及格</option>
             </select>`;
        } else {
          td.innerHTML = `<input type="text" data-row="${rowIdx}" data-key="${h}" value="${String(val ?? '')}" />`;
        }
      }

      // ★ 若這格是「獲證字號」且後端告訴這欄有連結 → 加一個綠色 v 標記
      if (String(h).trim() === '獲證字號' && Array.isArray(r.__linkCols)) {
        // 注意：__linkCols 的欄索引是「原始 headers 的 1-based 索引」，包含 _sheet
        const originalCol1 = colIdx + 1; // 原始 1-based
        if (r.__linkCols.includes(originalCol1)) {
          const badge = document.createElement('span');
          badge.textContent = ' v';
          badge.style.color = '#16a34a';
          badge.style.fontWeight = '600';
          td.appendChild(badge);
        }
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  table.appendChild(thead);
  table.appendChild(tbody);

  // === 放入容器 ===
  // 讓自動欄（乙/丙、獲證、獲證字號）唯讀＋灰底
function enforceReadOnlyAutoCols(tbodyRoot){
  const inputs = tbodyRoot.querySelectorAll('input[data-key], select[data-key]');
  inputs.forEach(el=>{
    const key = el.dataset.key || '';
    const last = key.slice(-1);
    const isAutoGet = (last === '乙' || last === '丙');   // 你系統的「獲證」列
    const isCertNo  = /字號$/.test(key) || key.includes('獲證字號');

    if (isAutoGet || isCertNo) {
      // 乙/丙 & 字號 都禁手動改；字號的值由對話框寫入
      if (el.tagName === 'SELECT') {
        // 若後端把「獲證」欄做成 <select>，也禁用
        el.disabled = true;
      } else {
        el.readOnly = true;
      }
      el.classList.add('auto-gray');
    }
  });
}

// 由「乙/丙」欄位推到同列的「獲證字號」欄位 input
function findCertNumberInputByAutoCol(rowIdx, autoColKey){
  // 先假設「獲證字號」在乙/丙的下一欄
  const autoIdx = headers.indexOf(autoColKey);
  const maybeNextKey = headers[autoIdx + 1];
  if (maybeNextKey) {
    const isCert = /字號$/.test(maybeNextKey) || String(maybeNextKey).includes('獲證字號');
    if (isCert) {
      return document.querySelector(`[data-row="${rowIdx}"][data-key="${maybeNextKey}"]`);
    }
  }
  // fallback：整列掃一遍找「字號」欄
  for (const h of headers) {
    if (/字號$/.test(h) || String(h).includes('獲證字號')) {
      const el = document.querySelector(`[data-row="${rowIdx}"][data-key="${h}"]`);
      if (el) return el;
    }
  }
  return null;
}

  root.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'table-wrap';
  wrap.appendChild(table);
  root.appendChild(wrap);
  // 渲染後，套上唯讀灰底
  enforceReadOnlyAutoCols(tbody);

  // === 量測前4欄實際寬度，注入 CSS 變數，避免重疊/穿透 ===
  (function computeFrozen() {
    const ths = wrap.querySelectorAll('thead th');
    if (ths.length >= 4) {
      const c1 = ths[0].offsetWidth;
      const c2 = ths[1].offsetWidth;
      const c3 = ths[2].offsetWidth;
      const c4 = ths[3].offsetWidth;
      const rs = document.documentElement.style;
      rs.setProperty('--c1', c1 + 'px');
      rs.setProperty('--c2', c2 + 'px');
      rs.setProperty('--c3', c3 + 'px');
      rs.setProperty('--c4', c4 + 'px');
    }
  })();
  window.addEventListener('resize', () => {
    const ths = document.querySelectorAll('.table-wrap thead th');
    if (ths.length >= 4) {
      const rs = document.documentElement.style;
      rs.setProperty('--c1', ths[0].offsetWidth + 'px');
      rs.setProperty('--c2', ths[1].offsetWidth + 'px');
      rs.setProperty('--c3', ths[2].offsetWidth + 'px');
      rs.setProperty('--c4', ths[3].offsetWidth + 'px');
    }
  });

  // ===== 底部浮動橫向捲軸同步（render 時自動建立） =====
  let floatScroll = document.querySelector('.scrollbar-float');
  if (!floatScroll) {
    floatScroll = document.createElement('div');
    floatScroll.className = 'scrollbar-float';
    document.body.appendChild(floatScroll);
  }
  floatScroll.innerHTML = '<div style="width:' + wrap.scrollWidth + 'px;height:1px;"></div>';
  floatScroll.onscroll = () => { wrap.scrollLeft = floatScroll.scrollLeft; };
  wrap.onscroll = () => { floatScroll.scrollLeft = wrap.scrollLeft; };
  // ===== 教師端：獲證 → 開窗（不強制上傳） =====
const teacherCertModal = {
  box: null, input: null, ok: null, cancel: null, hint: null,
  rowIdx: null, autoKey: null, certInput: null, onDone: null
};
(function initTeacherCertModal(){
  const m = document.getElementById('teacherCertModal');
  if (!m) return;
  teacherCertModal.box   = m;
  teacherCertModal.input = document.getElementById('tc_certNo');
  teacherCertModal.ok    = document.getElementById('tc_ok');
  teacherCertModal.cancel= document.getElementById('tc_cancel');
  teacherCertModal.hint  = document.getElementById('tc_hint');

  teacherCertModal.ok.addEventListener('click', ()=>{
    const no = (teacherCertModal.input.value || '').trim();
    if (!no) {
      alert('由於您未填字號，系統自動將學科/術科內容清除');
      // 清除兩個前置欄（學/術）的值，同步清空「獲證」與「字號」
      const kAuto = teacherCertModal.autoKey;
      const autoIdx = headers.indexOf(kAuto);
      const k1 = headers[autoIdx - 2];
      const k2 = headers[autoIdx - 1];
      const row = teacherCertModal.rowIdx;

      // 清空前兩欄
      const el1 = document.querySelector(`[data-row="${row}"][data-key="${k1}"]`);
      const el2 = document.querySelector(`[data-row="${row}"][data-key="${k2}"]`);
      if (el1) el1.value = '';
      if (el2) el2.value = '';

      // 清空獲證與字號
      const certNoInp = teacherCertModal.certInput;
      const autoInp   = document.querySelector(`[data-row="${row}"][data-key="${kAuto}"]`);
      if (autoInp) autoInp.value = '';
      if (certNoInp) certNoInp.value = '';

      closeTeacherCertModal();
      return;
    }

    // 有填字號：寫回「獲證字號」欄
    if (teacherCertModal.certInput) {
      teacherCertModal.certInput.value = no;
    }
    // 教師端不強制上傳：若無任何照片連結，再提醒一次
    alert('您並未上傳證照圖片，請務必要求學生自行上傳');
    closeTeacherCertModal();
  });

  teacherCertModal.cancel.addEventListener('click', ()=>{
    // 視為未填 → 等同未填字號的路徑
    alert('由於您未填字號，系統自動將學科/術科內容清除');
    const kAuto = teacherCertModal.autoKey;
    const autoIdx = headers.indexOf(kAuto);
    const k1 = headers[autoIdx - 2];
    const k2 = headers[autoIdx - 1];
    const row = teacherCertModal.rowIdx;

    const el1 = document.querySelector(`[data-row="${row}"][data-key="${k1}"]`);
    const el2 = document.querySelector(`[data-row="${row}"][data-key="${k2}"]`);
    if (el1) el1.value = '';
    if (el2) el2.value = '';

    const certNoInp = teacherCertModal.certInput;
    const autoInp   = document.querySelector(`[data-row="${row}"][data-key="${kAuto}"]`);
    if (autoInp) autoInp.value = '';
    if (certNoInp) certNoInp.value = '';

    closeTeacherCertModal();
  });

  function closeTeacherCertModal(){
    teacherCertModal.box.style.display = 'none';
    teacherCertModal.rowIdx = teacherCertModal.autoKey = teacherCertModal.certInput = null;
    teacherCertModal.input.value = '';
  }
  window.openTeacherCertModal = function(rowIdx, autoKey, certInput){
    teacherCertModal.rowIdx = rowIdx;
    teacherCertModal.autoKey = autoKey;
    teacherCertModal.certInput = certInput || null;
    teacherCertModal.input.value = '';
    teacherCertModal.box.style.display = 'flex';
    setTimeout(()=>teacherCertModal.input.focus(), 0);
  };
})();

(function bindRulesOnce(){
  const container = document.getElementById('root');
  if (!container || container.__rulesBound) return;
  container.__rulesBound = true;

  container.addEventListener('change', (ev) => {
    const el = ev.target;
    if (!el.matches('input[data-key], select[data-key]')) return;
    const rowIdx = Number(el.dataset.row);
    const key = el.dataset.key;
    const headersIdx = headers.indexOf(key);
    const lastChar = key.slice(-1);

    // === 驗證 / 自動規則：掃描同列所有「乙/丙 → 獲證；否則清空」 ===
    headers.forEach((h, colIdx) => {
      const endChar = h.slice(-1);
      if (endChar === '乙' || endChar === '丙') {
        const k1 = headers[colIdx - 2];
        const k2 = headers[colIdx - 1];
        if (!k1 || !k2) return;

        const sel1   = container.querySelector(`[data-row="${rowIdx}"][data-key="${k1}"]`);
        const sel2   = container.querySelector(`[data-row="${rowIdx}"][data-key="${k2}"]`);
        const autoEl = container.querySelector(`[data-row="${rowIdx}"][data-key="${h}"]`);
        const certEl = findCertNumberInputByAutoCol(rowIdx, h);

        if (!sel1 || !sel2 || !autoEl) return;

        const v1 = (sel1.value || '').trim();
        const v2 = (sel2.value || '').trim();
        const prevVal = (autoEl.value || '').trim();

        if (v1 === '及格' && v2 === '及格') {
          // → 自動判定為「獲證」
          autoEl.value = '獲證';
          // 變成獲證的「當下」→ 開教師對話框（寫入證號，不強制上傳）
          if (prevVal !== '獲證') {
            window.openTeacherCertModal(rowIdx, h, certEl);
          }
        } else {
          // → 任一不及格或空白：立刻清除獲證與字號（修正你的第2點）
          autoEl.value = '';
          if (certEl) certEl.value = '';
        }
      }
    });

    // === 尾字為「號」→ 若上一欄是獲證，則本欄必填提示（保留你原規則）
    if (lastChar === '號') {
      const kPrev = headers[headersIdx - 1];
      if (kPrev) {
        const prevEl = container.querySelector(`[data-row="${rowIdx}"][data-key="${kPrev}"]`);
        const prevVal = prevEl ? prevEl.value : '';
        const curVal = el.value;
        if (prevVal === '獲證' && !curVal) {
          el.style.border = '1px solid #e11';
          alert(`您已取得「${key}」證照，請輸入獲證字號`);
        } else {
          el.style.border = '';
        }
      }
    }
  });
})();
;
}

  // 收集差異 → updates 陣列
function collectUpdates() {
  const inputs = document.querySelectorAll('input[data-row][data-key], select[data-row][data-key]');
  const changedByRow = new Map(); // key: rowIdx → { sid,_sheet, changes:{} }

  inputs.forEach(inp => {
    const rowIdx = Number(inp.dataset.row);
    const key = inp.dataset.key;
    if (key === '_sheet') return; // 不處理隱藏欄
    const newVal = inp.value;
    const row = rows[rowIdx];
    const orig = originalRowsMap.get(keyOf(row)) || {};
    const oldVal = orig[key] ?? '';

    if (String(newVal) !== String(oldVal)) {
      if (!changedByRow.has(rowIdx)) {
        changedByRow.set(rowIdx, { sid: String(row['學號'] || ''), _sheet: row._sheet, changes: {} });
      }
      changedByRow.get(rowIdx).changes[key] = newVal;
    }
  });

  const updates = [];
  changedByRow.forEach(v => {
    if (v.sid && v._sheet && Object.keys(v.changes).length) updates.push(v);
  });

  return updates;
}

document.getElementById('btnSave').addEventListener('click', async () => {
  showBusy(true);
  try {
    const updates = collectUpdates();
    if (!updates.length) { alert('沒有變更'); return; }
    const res = await apiPost('class.bulkUpdate', { token, updates: JSON.stringify(updates) });
    if (!res.ok) throw new Error(res.error || '更新失敗');
    alert('已送出！更新筆數：' + (res.updated || 0));
    await loadClass(); // 重新讀取最新資料，更新 v 標記
  } catch (err) {
    alert(err.message || '送出失敗');
  } finally {
    showBusy(false);
  }
});

  document.getElementById('btnReload').addEventListener('click', () => {
    loadClass().catch(err => alert(err.message));
  });

  document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });

  loadClass().catch(err => alert(err.message));
</script>
</body>
</html>
