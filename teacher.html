<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" href="data:,">
<title>教師名冊 | 職業證照登管系統</title>
<style>
  :root{
    --bg1:#fff7ed; --card:#fffaf0; --line:#e6d3b8;
    --text:#3b2f2f; --muted:#8b6b5e; --accent:#f59e0b;
    --btnBg:#f3f4f6; --btnBorder:#cbd5e1; --btnHover:#e5e7eb;
    --btnPriBg:#f59e0b; --btnPriText:#fff; --btnPriBorder:#d97706;
    --error:#b91c1c; --ok:#16a34a; --shadow:0 10px 30px rgba(217,119,6,.12);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),#fff);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC"}
  .wrap{width:95%;margin:22px auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  h1{margin:0 0 6px} .sub{margin:0 0 10px;color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff5dc}
  .small{font-size:12px;color:var(--muted)}
  /* table */
  .table-wrap{width:95%;overflow:auto;margin-top:10px}
  table{border-collapse:collapse; width:100%}
  th,td{border-bottom:1px solid var(--line);padding:8px 8px;text-align:left;font-size:14px;vertical-align:middle;white-space:nowrap}
  th{font-weight:600;color:#6b4f43;background:#fff8ea;position:sticky;top:0;z-index:1}
  .ro{background:#f7f3ea}
  /* controls */
  select,input[type="text"]{min-width:120px;padding:6px 8px;border:1px solid var(--btnBorder);border-radius:6px;background:#fff;outline:none;appearance:auto}
  select:focus,input[type="text"]:focus{border-color:#94a3b8;box-shadow:0 0 0 2px rgba(148,163,184,.25)}
  /* buttons (傳統樣式) */
  .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:1px solid var(--btnBorder);background:var(--btnBg);color:var(--text);cursor:pointer}
  .btn:hover{background:var(--btnHover)}
  .btn.primary{background:var(--btnPriBg); border-color:var(--btnPriBorder); color:var(--btnPriText)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .okMark{display:inline-block;margin-left:6px;color:var(--ok);font-weight:700}
  /* Spinner */
  #busy{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:9999}
  .spinner{width:48px;height:48px;border:5px solid #fff;border-top-color:#f59e0b;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* Progress */
  #uploadProgress{position:fixed;left:0;right:0;bottom:18px;display:none;z-index:10000}
  #uploadProgress .barWrap{max-width:560px;margin:0 auto;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);overflow:hidden}
  #uploadProgress .bar{height:10px;width:0%;background:linear-gradient(90deg,#f59e0b,#fde68a)}
  #uploadProgress .meta{padding:6px 10px;font-size:12px;color:var(--text)}
  /* Modal */
  #certModal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10001}
  .modalCard{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:14px;max-width:480px;width:92%}
  .row{display:grid;grid-template-columns:1fr;gap:8px}
  .modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .hscroll{
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 8px;
  width: 95%;
  height: 16px;
  overflow-x: auto;
  overflow-y: hidden;
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 8px;
  box-shadow: var(--shadow);
  z-index: 1000;
}
.hscroll .inner{ height: 1px; }
.sticky{ position: sticky; left: 0; background: #fffaf0; z-index: 2; }
.sticky.header{ z-index: 3; } /* 表頭優先層級 */
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>教師名冊</h1>
    <p class="sub" id="meta"></p>
    <div class="actions">
      <span class="chip" id="hdrCount"></span>
      <button class="btn primary" id="btnSubmit" disabled>確認送出</button>
      <a class="btn" href="index.html">返回登入</a>
      <span class="small" id="err"></span>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="hScroll" class="hscroll"><div class="inner"></div></div>
  </div>
</div>

<!-- Spinner & Progress & Modal -->
<div id="busy"><div class="spinner"></div></div>
<div id="uploadProgress"><div class="barWrap"><div class="bar" id="progBar"></div><div class="meta" id="progMeta">準備上傳…</div></div></div>
<div id="certModal">
  <div class="modalCard">
    <h3 id="cmTitle" style="margin:0 0 6px">證號與截圖</h3>
    <div class="row">
      <label>證號 <input id="cmNo" type="text" autocomplete="off"/></label>
      <label>上傳截圖（教師可略過） <input id="cmFile" type="file" accept="image/*"/></label>
    </div>
    <div class="modalActions">
      <button class="btn" id="cmCancel">取消</button>
      <button class="btn primary" id="cmOk">確認</button>
    </div>
  </div>
</div>

<script>
const GAS_BASE = '/api/gas';
const payload = JSON.parse(sessionStorage.getItem('teacherList')||'null');

const meta = document.getElementById('meta');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const errEl = document.getElementById('err');
const btnSubmit = document.getElementById('btnSubmit');
const hdrCount = document.getElementById('hdrCount');
const BASE_COLS = 5; // 基礎欄位數：科別、班級、學號、姓名、座號（不含身分證號）
const busy = document.getElementById('busy');
const upWrap = document.getElementById('uploadProgress');
const progBar = document.getElementById('progBar');
const progMeta = document.getElementById('progMeta');

function showBusy(on){ busy.style.display = on ? 'flex' : 'none'; }
function showProgress(on){ upWrap.style.display = on ? 'block' : 'none'; }
function setProgress(p, txt){ progBar.style.width = (p|0)+'%'; if (txt) progMeta.textContent = txt; }

let headersMeta = []; // [{title,kind,group,colIndex}]
let rowsData = [];
const dirtySet = new Set(); // `${rowIndex}-${colIndex}`
let originalMap = new Map(); // rowIndex => [display...]

function buildOriginalSnapshots(){
  originalMap.clear();
  rowsData.forEach(row=>{
    originalMap.set(row.rowIndex, (row.tail||[]).map(c => (c?.display||'')));
  });
}

function setupHScroll(){
  const wrap = document.querySelector('.table-wrap');
  const bar  = document.getElementById('hScroll');
  const inner = bar.querySelector('.inner');

  // 依表格實際寬度設定「假內容」寬度
  inner.style.width = wrap.scrollWidth + 'px';

  // 互相同步 scrollLeft
  let lock = false;
  bar.onscroll = () => {
    if (lock) return; lock = true;
    wrap.scrollLeft = bar.scrollLeft; lock = false;
  };
  wrap.onscroll = () => {
    if (lock) return; lock = true;
    bar.scrollLeft = wrap.scrollLeft; lock = false;
  };

  // 僅在需要水平滾動時顯示
  bar.style.display = (wrap.scrollWidth > wrap.clientWidth) ? 'block' : 'none';
}
  
function syncDirty(rowIndex, colIndex, newDisplay){
  const headersIdx = headersMeta.findIndex(h=>h.colIndex===colIndex);
  const origList = originalMap.get(rowIndex) || [];
  const orig = origList[headersIdx] || '';
  const key = `${rowIndex}-${colIndex}`;
  if ((newDisplay||'') === orig) dirtySet.delete(key);
  else dirtySet.add(key);
  btnSubmit.disabled = dirtySet.size===0;
}

function setDirty(rowIndex, colIndex){
  dirtySet.add(`${rowIndex}-${colIndex}`);
  btnSubmit.disabled = dirtySet.size===0;
}
function clearDirty(){ dirtySet.clear(); btnSubmit.disabled = true; }

if(!payload){ meta.textContent='無資料，請由登入頁進入。'; }

async function loadClass(){
  try{
    showBusy(true);
    const body = new URLSearchParams({ path:'class_rows', dept:payload.dept, clazz:payload.clazz }).toString();
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'load failed');

    headersMeta = data.headersMeta||[];
    rowsData = data.rows||[];
    hdrCount.textContent = `證照欄位數：${headersMeta.length}`;
    renderTable();
  }catch(e){
    errEl.textContent = e.message;
  }finally{ showBusy(false); }
}
// 讀取畢業生（非在校生）班級資料：依班級＋學號首碼
async function loadAlumni(){
  try{
    showBusy(true);
    const body = new URLSearchParams({
      path: 'alumni_rows',
      clazz: payload.clazz,   // 班級
      digit: payload.digit    // 學號首碼 (0~9)
    }).toString();
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'load alumni failed');

    // 後端需回傳與 class_rows 相同格式：{ ok, headersMeta, rows }
    headersMeta = data.headersMeta||[];
    rowsData = data.rows||[];
    hdrCount.textContent = `證照欄位數：${headersMeta.length}`;
    renderTable();
  }catch(e){
    errEl.textContent = e.message;
  }finally{ showBusy(false); }
}

function th(t){ const x=document.createElement('th'); x.textContent=t; return x; }
function td(){ return document.createElement('td'); }

function renderTable(){
  thead.innerHTML=''; tbody.innerHTML='';
  ['科別名稱','班級名稱','學號','姓名','座號'].forEach(t=>thead.appendChild(th(t)));
  headersMeta.forEach(h=>thead.appendChild(th(h.title)));

  rowsData.forEach(row=>{
    const tr = document.createElement('tr');
    row.base.slice(0, BASE_COLS).forEach(v => { const c = td(); c.textContent = v || ''; tr.appendChild(c); });

    headersMeta.forEach((h, idx)=>{
      const cell = row.tail[idx] || {display:'',hasLink:false};
      const c = td();
      if (h.kind==='S1' || h.kind==='S2'){
        const sel=document.createElement('select');
        ['及格','不及格',''].forEach(op=>{ const o=document.createElement('option'); o.value=op; o.textContent=op||'（空白）'; sel.appendChild(o); });
        sel.value = cell.display || '';
sel.addEventListener('change', async ()=>{
  const group = h.group;
  const prev = row.tail[h.groupOffset]?.display || cell.display || ''; // 記錄原值（預防還原）
  const oldWasCertified = (()=>{ // 變更前是否為「獲證」
    const s3Idx = headersMeta.findIndex(x => x.group === group && x.kind === 'S3');
    return s3Idx >= 0 ? (row.tail[s3Idx]?.display === '獲證') : false;
  })();

  // 寫入新值（前端 / dirty）
  cell.display = sel.value;
  syncDirty(row.rowIndex, h.colIndex, sel.value);

  // 依新 S1/S2 計算 S3
  const newS3 = computeS3ByGroup(row, group);

  if (oldWasCertified && newS3 !== '獲證') {
    // 可能會取消獲證
    const ok1 = confirm('獲證被取消，將刪除證號，你確認嗎？');
    if (!ok1) {
      // 還原選項與前端值
      sel.value = prev;
      cell.display = prev;
      syncDirty(row.rowIndex, h.colIndex, prev);
      return; // 不再往下跑
    }
    // 第二層訊息（可勾選不要再提醒）
    const skipWarn = localStorage.getItem('skipCertWarn') === '1';
    if (!skipWarn) {
      const ok2 = await showDontRemindDialog("請記得關閉視窗前點擊『確認送出』，才會將修正資料存入資料庫。");
      if (!ok2) {
        // 取消 → 一樣還原
        sel.value = prev;
        cell.display = prev;
        syncDirty(row.rowIndex, h.colIndex, prev);
        return;
      }
    }

    // 清除 S3/S4（只改前端 & 標 dirty，不立即寫表）
    const s3Idx = headersMeta.findIndex(x => x.group === group && x.kind === 'S3');
    if (s3Idx >= 0) {
      row.tail[s3Idx].display = '';
      const tdS3 = tbody.children[rowsData.indexOf(row)].children[BASE_COLS + s3Idx];
      tdS3.textContent = '';
      syncDirty(row.rowIndex, headersMeta[s3Idx].colIndex, '');
    }
    const s4Idx = headersMeta.findIndex(x => x.group === group && x.kind === 'S4');
    if (s4Idx >= 0) {
      row.tail[s4Idx].display = '';
      const tdS4 = tbody.children[rowsData.indexOf(row)].children[BASE_COLS + s4Idx];
      tdS4.innerHTML = '';
      const span = document.createElement('span');
      span.textContent = '';
      tdS4.appendChild(span);
      syncDirty(row.rowIndex, headersMeta[s4Idx].colIndex, '');
    }
  }

  // 最後一樣更新 S3 顯示（必要時觸發輸入證號的流程）
  updateS3AndMaybePrompt(row, group);
});


        c.appendChild(sel);
      }else if (h.kind==='S3'){
        c.classList.add('ro');
        const span=document.createElement('span');
        span.textContent = computeS3ByGroup(row, h.group);
        c.appendChild(span);
      }else if (h.kind==='S4'){
        c.classList.add('ro');
        const txt=document.createElement('span'); txt.textContent = cell.display || '';
        c.appendChild(txt);
        if (cell.hasLink){
          const ok=document.createElement('span'); ok.className='okMark'; ok.textContent='✓'; c.appendChild(ok);
        }else if ((cell.display||'').trim()!==''){
          const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='修改/補截圖';
          btn.addEventListener('click', ()=>openCertModal({
           row,
           headerTitle: h.title,
           currentNo: cell.display || '',
           requireImage: false,
           mode: 'edit',
          group: h.group
          }));

          c.appendChild(document.createTextNode(' ')); c.appendChild(btn);
        }
      }else{ // FREE
        const input=document.createElement('input'); input.type='text'; input.value = cell.display || '';
        input.addEventListener('change', ()=>{ cell.display=input.value.trim(); setDirty(row.rowIndex,h.colIndex); });
        c.appendChild(input);
      }
      tr.appendChild(c);
    });

    tbody.appendChild(tr);
  });
  setupHScroll();
  applyStickyFirstN();
}

function applyStickyFirstN(){
  const table = document.getElementById('tbl');
  const headerRow = table.tHead.rows[0];
  const bodyRows  = table.tBodies[0].rows;

  // 量測前 BASE_COLS 欄位的累積 left
  const lefts = [];
  let acc = 0;
  for (let i=0;i<BASE_COLS;i++){
    const th = headerRow.cells[i];
    const w  = th.getBoundingClientRect().width;
    lefts[i] = acc;
    acc += w;
  }

  // 套到表頭
  for (let i=0;i<BASE_COLS;i++){
    const th = headerRow.cells[i];
    th.classList.add('sticky','header');
    th.style.left = lefts[i] + 'px';
  }
  // 套到每一列的前 BASE_COLS 個 td
  for (const tr of bodyRows){
    for (let i=0;i<BASE_COLS;i++){
      const td = tr.cells[i];
      td.classList.add('sticky');
      td.style.left = lefts[i] + 'px';
    }
  }
}



/* -------- 同組 S3 判斷＆更新 -------- */
function computeS3ByGroup(row, group){
  const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
  const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
  const v1 = s1Idx>=0 ? (row.tail[s1Idx]?.display||'').trim() : '';
  const v2 = s2Idx>=0 ? (row.tail[s2Idx]?.display||'').trim() : '';
  return (v1==='及格' && v2==='及格') ? '獲證' : '';
}

// 計算某 group 的 S3（同組學科/術科都為「及格」→回傳「獲證」，否則空字串）
function computeS3ByGroup(row, group){
  const idxS1 = headersMeta.findIndex(h => h.group === group && h.kind === 'S1');
  const idxS2 = headersMeta.findIndex(h => h.group === group && h.kind === 'S2');
  const s1 = idxS1 >= 0 ? (row.tail[idxS1]?.display || '') : '';
  const s2 = idxS2 >= 0 ? (row.tail[idxS2]?.display || '') : '';
  return (s1 === '及格' && s2 === '及格') ? '獲證' : '';
}

  
function updateS3AndMaybePrompt(row, group){
  
  const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
  if (s3Idx<0) return;
  const oldVal = (row.tail[s3Idx]?.display||'');
  const newVal = computeS3ByGroup(row, group);
  row.tail[s3Idx] = row.tail[s3Idx] || {};
  row.tail[s3Idx].display = newVal;
  const tdS3 = tbody.children[ rowsData.indexOf(row) ].children[BASE_COLS + s3Idx];
  tdS3.textContent = newVal;
  syncDirty(row.rowIndex, headersMeta[s3Idx].colIndex, newVal);
  if (oldVal !== '獲證' && newVal === '獲證'){
    const s4Hdr = headersMeta.find(h=>h.group===group && h.kind==='S4');
    if (s4Hdr) openCertModal({ row, headerTitle: s4Hdr.title, currentNo:'', requireImage:false, mode:'new', group });
  }
}

/* -------- Modal：證號＋截圖 -------- */
const certModal = document.getElementById('certModal');
const cmTitle = document.getElementById('cmTitle');
const cmNo = document.getElementById('cmNo');
const cmFile = document.getElementById('cmFile');
const cmCancel = document.getElementById('cmCancel');
const cmOk = document.getElementById('cmOk');
let cmCtx=null;

function openCertModal(ctx){
  cmCtx = ctx;
  cmTitle.textContent = `證號與截圖：${ctx.headerTitle}`;
  cmNo.value = ctx.currentNo||''; cmFile.value='';
  certModal.style.display='flex';
}
cmCancel.onclick = () => {
  certModal.style.display = 'none';
  if (cmCtx && cmCtx.mode === 'new') {
    const { row, group } = cmCtx;
    const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
    const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
    const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
    if (s1Idx>=0){
      row.tail[s1Idx].display = '';
      const sel = tbody.children[ rowsData.indexOf(row) ].children[BASE_COLS+s1Idx].querySelector('select');
      if (sel) sel.value = '';
      syncDirty(row.rowIndex, headersMeta[s1Idx].colIndex, '');  // 正確更新 dirty
    }
    if (s2Idx>=0){
      row.tail[s2Idx].display = '';
      const sel = tbody.children[ rowsData.indexOf(row) ].children[BASE_COLS+s2Idx].querySelector('select');
      if (sel) sel.value = '';
      syncDirty(row.rowIndex, headersMeta[s2Idx].colIndex, '');
    }
    if (s3Idx>=0){
      row.tail[s3Idx].display = '';
      const tdS3 = tbody.children[ rowsData.indexOf(row) ].children[BASE_COLS + s3Idx];
      tdS3.textContent = '';
      syncDirty(row.rowIndex, headersMeta[s3Idx].colIndex, '');
    }
  }
  cmCtx = null;
};


cmOk.onclick=async ()=>{
  if (!cmCtx) return;
  const { row, headerTitle, requireImage, group } = cmCtx;
  const no = (cmNo.value||'').trim();
  const file = cmFile.files[0]||null;
  if (!no){ alert('請輸入證號'); return; }
  certModal.style.display='none';

  try{
    showProgress(true); setProgress(10,'準備上傳…');
    if (file){
      const b64 = await fileToBase64(file); setProgress(30,'上傳檔案至伺服器…');
      const r = await postForm({
        path:'upload_cert',
        dept: row.base[0], clazz: row.base[1], sid: row.base[2], name: row.base[3],
        headerTitle, certNo:no, fileBase64:b64.split(',')[1], mime:file.type||'image/png'
      });
      if (!r.ok) throw new Error(r.error||'upload failed');
      updateS4CellUI(row, headerTitle, no, true, group);
      setProgress(100,'完成');
    }else{
      updateS4CellUI(row, headerTitle, no, false, group);
      setProgress(100,'已暫存，待確認送出');
    }
  }catch(e){ alert('上傳/寫入失敗：' + e.message); }
  finally{ setTimeout(()=>showProgress(false), 500); }
};

function updateS4CellUI(row, headerTitle, certNo, hasLink, group){
  const idx = (group != null)
    ? headersMeta.findIndex(h => h.group === group && h.kind === 'S4')
    : headersMeta.findIndex(h => h.title === headerTitle && h.kind === 'S4');
  if (idx<0) return;
  const cell = row.tail[idx] || (row.tail[idx]={});
  cell.display = certNo; cell.hasLink = !!hasLink;

  const trIdx = rowsData.indexOf(row);
  const tdCell = tbody.children[trIdx].children[BASE_COLS + idx];
  tdCell.innerHTML='';
  const txt=document.createElement('span'); txt.textContent=certNo; tdCell.appendChild(txt);
  if (hasLink){ const ok=document.createElement('span'); ok.className='okMark'; ok.textContent='✓'; tdCell.appendChild(ok); }
  else{
    const hdr = headersMeta[idx];
    const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='修改/補截圖';
    btn.addEventListener('click', ()=>openCertModal({
      row,
      headerTitle: hdr.title,
      currentNo: cell.display||'',
      requireImage:false,
      mode:'edit',
      group: hdr.group
    }));
    tdCell.appendChild(document.createTextNode(' ')); tdCell.appendChild(btn);
  }

    // （A）無圖：僅標記為 dirty，等「確認送出」統一寫入
  if (!hasLink) {
    const colIndex = headersMeta[idx].colIndex;
    syncDirty(row.rowIndex, colIndex, certNo);
  }
// 讓 S1/S2 永遠可編輯：每次更新 S4 後都恢復樣式與互動
if (group != null) {
  ['S1','S2'].forEach(kind => {
    const k = headersMeta.findIndex(h => h.group === group && h.kind === kind);
    if (k >= 0) {
      const td = tbody.children[ rowsData.indexOf(row) ].children[BASE_COLS + k];
      td.style.backgroundColor = '';   // 清除灰底
      td.style.pointerEvents = '';     // 恢復互動
      const sel = td.querySelector('select');
      if (sel) sel.disabled = false;   // 解除停用
    }
  });
}

}

/* -------- 批次送出 -------- */
btnSubmit.onclick = async ()=>{
  if (dirtySet.size===0) return;
  try{
    showBusy(true);
    const updates=[];
    dirtySet.forEach(k=>{
      const [r,c]=k.split('-').map(n=>parseInt(n,10));
      const h = headersMeta.find(h=>h.colIndex===c);
      const rowObj = rowsData.find(x=>x.rowIndex===r);
      const idx = headersMeta.indexOf(h);
      const valueDisplay = (rowObj && rowObj.tail[idx] && rowObj.tail[idx].display) || '';
      updates.push({ rowIndex:r, colIndex:c, valueDisplay, headerTitle:h.title });
    });
    const r = await postForm({ path:'update_rows', updates: JSON.stringify(updates) });
    if (!r.ok) throw new Error(r.error||'update failed');
    clearDirty();
    alert(`已送出！更新筆數：${r.count}`);
  }catch(e){ alert('送出失敗：'+e.message); }
  finally{ showBusy(false); }
};

/* -------- 工具 -------- */
async function postForm(obj){ const body=new URLSearchParams(obj).toString(); const r=await fetch(GAS_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body}); return r.json(); }
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

(async function init(){
  if (!payload) return;

  // payload 可能來自：
  // - 在校生：{ mode:'school', dept, clazz }
  // - 畢業生：{ mode:'alumni', clazz, digit }
  const mode = payload.mode || 'school';

  if (mode === 'alumni'){
    meta.textContent = `身份：畢業生　班級：${payload.clazz}　學號首碼：${payload.digit}`;
    await loadAlumni();
  }else{
    meta.textContent = `群科：${payload.dept}　班級：${payload.clazz}`;
    await loadClass();
  }

  buildOriginalSnapshots();
})();
// 顯示含「不要再提醒我」勾選的自製對話框，回傳 Promise<boolean>（是否確認）
// 若有勾選「不要再提醒我」，會把 localStorage.skipCertWarn 設為 '1'
function showDontRemindDialog(message){
  return new Promise(resolve=>{
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9999;display:flex;align-items:center;justify-content:center;';
    const box = document.createElement('div');
    box.style.cssText = 'background:#fff;padding:16px 18px;border-radius:10px;max-width:520px;width:92%;color:#111;';
    box.innerHTML = `
      <div style="font-size:15px;line-height:1.6;white-space:pre-wrap">${message}</div>
      <label style="display:flex;gap:8px;align-items:center;margin:10px 0 6px;font-size:14px;color:#374151">
        <input id="dlgDontRemind" type="checkbox"> 不要再提醒我
      </label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="dlgCancel"  style="padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff">取消</button>
        <button id="dlgOK"      style="padding:8px 12px;border:1px solid #2563eb;border-radius:8px;background:#2563eb;color:#fff">確定</button>
      </div>
    `;
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    const ok = box.querySelector('#dlgOK');
    const cancel = box.querySelector('#dlgCancel');
    ok.onclick = ()=>{
      if (box.querySelector('#dlgDontRemind').checked) localStorage.setItem('skipCertWarn','1');
      document.body.removeChild(overlay);
      resolve(true);
    };
    cancel.onclick = ()=>{
      document.body.removeChild(overlay);
      resolve(false);
    };
  });
}
</script>
</body>
</html>
