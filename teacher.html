<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>教師名冊 | 職業證照登管系統</title>
<style>
  :root{
    --bg1:#fff7ed; --bg2:#ffedd5; --card:#fffaf0; --line:#f5d6b0;
    --text:#3b2f2f; --muted:#8b6b5e; --accent:#f59e0b;
    --btn:#fef3c7; --btnBorder:#f1c07a; --btnPrimary:#f59e0b; --btnPrimaryText:#fffef9;
    --error:#b91c1c; --ok:#16a34a; --shadow:0 10px 30px rgba(217,119,6,.15);
  }
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,var(--bg1),#fff);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC"}
  .wrap{max-width:1200px;margin:28px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
  h1{margin:0 0 6px} .sub{margin:0 0 12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:14px;vertical-align:middle}
  th{font-weight:600;color:#6b4f43;background:#fff8ea;position:sticky;top:0}
  select,input[type="text"]{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fffdf7;outline:none}
  select:focus,input[type="text"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(245,158,11,.15)}
  .ro{background:#f7f3ea}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid var(--btnBorder);background:var(--btn);text-decoration:none;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--btnPrimary);border-color:#e08f03;color:var(--btnPrimaryText)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .okMark{display:inline-block;margin-left:6px;color:var(--ok);font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center;margin-top:12px}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff5dc;margin-right:6px}
  /* Spinner */
  #busy{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:9999}
  .spinner{width:56px;height:56px;border:5px solid #fff;border-top-color:#f59e0b;border-radius:50%;animation:spin 0.9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* Upload progress bar */
  #uploadProgress{position:fixed;left:0;right:0;bottom:18px;display:none;z-index:10000}
  #uploadProgress .barWrap{max-width:560px;margin:0 auto;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
  #uploadProgress .bar{height:12px;width:0%;background:linear-gradient(90deg,#f59e0b,#fde68a)}
  #uploadProgress .meta{padding:8px 10px;font-size:12px;color:var(--text)}
  /* Modal */
  #certModal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10001}
  .modalCard{background:#fffaf0;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px;max-width:480px;width:92%}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  .modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>教師名冊</h1>
    <p class="sub" id="meta"></p>
    <div class="actions">
      <span class="chip" id="hdrCount"></span>
      <button class="btn primary" id="btnSubmit" disabled>確認送出</button>
      <a class="btn" href="index.html">返回登入</a>
      <span class="small" id="err"></span>
    </div>
    <div style="overflow:auto;max-height:70vh;margin-top:10px">
      <table id="tbl">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Spinner -->
<div id="busy"><div class="spinner"></div></div>
<!-- Progress -->
<div id="uploadProgress">
  <div class="barWrap">
    <div class="bar" id="progBar"></div>
    <div class="meta" id="progMeta">準備上傳…</div>
  </div>
</div>
<!-- Cert Modal -->
<div id="certModal">
  <div class="modalCard">
    <h3 id="cmTitle" style="margin:0 0 8px">證號與截圖</h3>
    <div class="row">
      <label>證號 <input id="cmNo" type="text" autocomplete="off"/></label>
      <label>上傳截圖（教師可略過） <input id="cmFile" type="file" accept="image/*"/></label>
    </div>
    <div class="modalActions">
      <button class="btn" id="cmCancel">取消</button>
      <button class="btn primary" id="cmOk">確認</button>
    </div>
  </div>
</div>

<script>
const GAS_BASE = '/api/gas';
const role = 'teacher';

const payload = JSON.parse(sessionStorage.getItem('teacherList')||'null');
const meta = document.getElementById('meta');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const errEl = document.getElementById('err');
const btnSubmit = document.getElementById('btnSubmit');
const hdrCount = document.getElementById('hdrCount');

const busy = document.getElementById('busy');
const upWrap = document.getElementById('uploadProgress');
const progBar = document.getElementById('progBar');
const progMeta = document.getElementById('progMeta');

function showBusy(on){ busy.style.display = on ? 'flex' : 'none'; }
function showProgress(on){ upWrap.style.display = on ? 'block' : 'none'; }
function setProgress(p, txt){ progBar.style.width = (p|0)+'%'; if (txt) progMeta.textContent = txt; }

if(!payload){ meta.textContent = '無資料，請由登入頁進入。'; }

let headersMeta = [];
let rowsData = [];
const dirtySet = new Set(); // `${rowIndex}-${colIndex}`

function setDirty(rowIndex, colIndex, headerTitle, valueDisplay){
  const key = `${rowIndex}-${colIndex}`;
  dirtySet.add(key);
  btnSubmit.disabled = dirtySet.size === 0;
}

function clearDirty(){
  dirtySet.clear();
  btnSubmit.disabled = true;
}

function cellTextBeforeSlash(str){
  const idx = (str||'').indexOf('/');
  return idx>=0 ? str.slice(0,idx) : str;
}

// 取得班級完整資料＋尾欄 meta
async function loadClass(){
  try{
    showBusy(true);
    const body = new URLSearchParams({ path:'class_rows', dept:payload.dept, clazz:payload.clazz }).toString();
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'load failed');

    headersMeta = data.headersMeta||[];
    rowsData = data.rows||[];
    hdrCount.textContent = `證照欄位數：${headersMeta.length}`;
    renderTable();
  }catch(e){
    errEl.textContent = e.message;
  }finally{
    showBusy(false);
  }
}

function th(text){ const th=document.createElement('th'); th.textContent=text; return th; }
function td(){ return document.createElement('td'); }

function renderTable(){
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // 表頭：前6欄固定
  ['科別名稱','班級名稱','學號','姓名','座號','身分證號'].forEach(t=>thead.appendChild(th(t)));
  headersMeta.forEach(h=>thead.appendChild(th(h.title)));

  // 資料列
  rowsData.forEach(row=>{
    const tr = document.createElement('tr');
    row.base.forEach(v=>{ const c=td(); c.textContent=v||''; tr.appendChild(c); });

    headersMeta.forEach((h, idx)=>{
      const cell = row.tail[idx] || {display:'',hasLink:false};
      const c = td();
      const headerTitle = h.title;

      if (h.kind === 'S1' || h.kind === 'S2') {
        const sel = document.createElement('select');
        ['及格','不及格',''].forEach(op=>{
          const o=document.createElement('option'); o.value=op; o.textContent=op||'（空白）';
          sel.appendChild(o);
        });
        sel.value = cell.display || '';
        sel.addEventListener('change', ()=>{
          // s1/s2 變更 → 標記 dirty
          setDirty(row.rowIndex, h.colIndex, headerTitle, sel.value);
          // 自動更新同組 s3
          autoUpdateS3(row, headerTitle);
        });
        c.appendChild(sel);
      }
      else if (h.kind === 'S3') {
        c.classList.add('ro');
        const span = document.createElement('span');
        span.textContent = autoComputeS3Value(row, headerTitle) || '';
        c.appendChild(span);
        // 若 s3 由空→獲證，之後在 s1/s2 事件中會彈窗（在 autoUpdateS3 內）
      }
      else if (h.kind === 'S4') {
        c.classList.add('ro');
        const txt = document.createElement('span');
        txt.textContent = cell.display || '';
        c.appendChild(txt);
        if (cell.hasLink) {
          const ok = document.createElement('span'); ok.className='okMark'; ok.textContent='✓';
          c.appendChild(ok);
        } else {
          const btn = document.createElement('button');
          btn.className='btn small';
          btn.textContent = '修改/補截圖';
          btn.addEventListener('click', ()=> openCertModal({
            mode:'edit',
            row,
            headerTitle,
            currentNo: cell.display || '',
            requireImage: false // 教師可略過
          }));
          c.appendChild(document.createTextNode(' '));
          c.appendChild(btn);
        }
      }
      else { // FREE 欄：可編輯文字
        const input = document.createElement('input');
        input.type='text'; input.value = cell.display || '';
        input.addEventListener('change', ()=>{
          setDirty(row.rowIndex, h.colIndex, headerTitle, input.value.trim());
        });
        c.appendChild(input);
      }
      tr.appendChild(c);
    });

    tbody.appendChild(tr);
  });
}

// 取得同列的 s1/s2 類別值，判斷 s3
function findCellValue(row, kindLabel){ // 'S1' or 'S2'
  // 找到對應 kind 的欄位 index
  for (let i=0;i<headersMeta.length;i++){
    if (headersMeta[i].kind === kindLabel) {
      return (row.tail[i]?.display || '').trim();
    }
  }
  return '';
}

function autoComputeS3Value(row, headerTitle){
  const s1 = findCellValue(row,'S1') === '及格';
  const s2 = findCellValue(row,'S2') === '及格';
  return (s1 && s2) ? '獲證' : '';
}

async function autoUpdateS3(row, triggerHeader){
  // 找到該列的 S3 欄
  const s3Index = headersMeta.findIndex(h=>h.kind==='S3');
  if (s3Index < 0) return;
  const s3Header = headersMeta[s3Index];
  const newVal = autoComputeS3Value(row, s3Header.title);
  const tdS3 = tbody.children[ rowsData.indexOf(row) ].children[6 + s3Index]; // 前6欄偏移
  tdS3.textContent = newVal;

  if (newVal === '獲證') {
    // 自動打開對話框要求證號（教師可無圖）
    const s4Header = headersMeta.find(h=>h.kind==='S4');
    if (s4Header) {
      openCertModal({
        mode:'new',
        row,
        headerTitle: s4Header.title,
        currentNo: '', // 預設
        requireImage: false // 教師可無圖
      });
    }
  } else {
    // 變回空白，不主動清 s4（避免誤刪後端資料）
  }
}

/* ------- 證號＋截圖對話框 ------- */
const certModal = document.getElementById('certModal');
const cmTitle = document.getElementById('cmTitle');
const cmNo = document.getElementById('cmNo');
const cmFile = document.getElementById('cmFile');
const cmCancel = document.getElementById('cmCancel');
const cmOk = document.getElementById('cmOk');

let cmCtx = null; // {row, headerTitle, currentNo, requireImage}

function openCertModal(ctx){
  cmCtx = ctx;
  cmTitle.textContent = `證號與截圖：${ctx.headerTitle}`;
  cmNo.value = ctx.currentNo || '';
  cmFile.value = '';
  certModal.style.display = 'flex';
}
cmCancel.onclick = ()=>{ certModal.style.display='none'; cmCtx=null; };

cmOk.onclick = async ()=>{
  if (!cmCtx) return;
  const { row, headerTitle, requireImage } = cmCtx;
  const no = (cmNo.value||'').trim();
  const file = cmFile.files[0] || null;
  if (!no) { alert('請輸入證號'); return; }
  if (requireImage && !file) { alert('此情境需上傳截圖'); return; }

  certModal.style.display = 'none';
  try{
    // 上傳流程
    showProgress(true); setProgress(10,'準備上傳…');

    if (file) {
      // 讀檔成 base64
      const b64 = await fileToBase64(file); setProgress(30,'上傳檔案至伺服器…');
      // 呼叫 upload_cert：直接寫入 s4（=HYPERLINK）
      const params = {
        path:'upload_cert',
        dept: row.base[0],
        clazz: row.base[1],
        sid:   row.base[2],
        name:  row.base[3],
        headerTitle,
        certNo: no,
        fileBase64: b64.split(',')[1],
        mime: file.type || 'image/png'
      };
      const r = await postForm(params); setProgress(70,'雲端處理中…');
      if (!r.ok) throw new Error(r.error||'upload failed');
      // 前端同步更新 s4 顯示＋打勾
      updateS4CellUI(row, headerTitle, no, true);
      setProgress(100,'完成');
    } else {
      // 教師可無圖：直接寫入純文字證號（不帶 ✅）
      const r = await postForm({ path:'write_cert', sid: row.base[2], headerTitle, certNo: no });
      if (!r.ok) throw new Error(r.error||'write failed');
      updateS4CellUI(row, headerTitle, no, false);
      setProgress(100,'完成');
    }
  }catch(e){
    alert('上傳/寫入失敗：' + e.message);
  }finally{
    setTimeout(()=>showProgress(false), 500);
  }
};

function updateS4CellUI(row, headerTitle, certNo, hasLink){
  // 找出 s4 欄位 index
  const idx = headersMeta.findIndex(h=>h.title===headerTitle);
  if (idx<0) return;
  // 更新 rowsData
  const cell = row.tail[idx] || (row.tail[idx] = {});
  cell.display = certNo;
  cell.hasLink = !!hasLink;
  // 更新表格的該儲存格
  const trIdx = rowsData.indexOf(row);
  const tdCell = tbody.children[trIdx].children[6 + idx];
  tdCell.innerHTML = '';
  const txt = document.createElement('span'); txt.textContent = certNo;
  tdCell.appendChild(txt);
  if (hasLink) {
    const ok = document.createElement('span'); ok.className='okMark'; ok.textContent='✓';
    tdCell.appendChild(ok);
  } else {
    const btn = document.createElement('button'); btn.className='btn small'; btn.textContent='修改/補截圖';
    btn.addEventListener('click', ()=> openCertModal({
      mode:'edit',
      row,
      headerTitle,
      currentNo: certNo,
      requireImage: false
    }));
    tdCell.appendChild(document.createTextNode(' '));
    tdCell.appendChild(btn);
  }
}

/* ------- 送出（批次寫入） ------- */
btnSubmit.onclick = async ()=>{
  if (dirtySet.size===0) return;
  try{
    showBusy(true);
    const updates = [];
    dirtySet.forEach(k=>{
      const [r,c] = k.split('-').map(x=>parseInt(x,10));
      // 找出 headerTitle 與目前顯示值
      const h = headersMeta.find(h=>h.colIndex===c);
      const rowObj = rowsData.find(x=>x.rowIndex===r);
      const idx = headersMeta.indexOf(h);
      const valueDisplay = (rowObj && rowObj.tail[idx] && rowObj.tail[idx].display) ||
                           getCurrentDisplayFromDOM(r,c) || '';
      updates.push({ rowIndex:r, colIndex:c, valueDisplay, headerTitle: h.title });
    });
    const r = await postForm({ path:'update_rows', updates: JSON.stringify(updates) });
    if (!r.ok) throw new Error(r.error||'update failed');
    clearDirty();
    alert(`已送出！更新筆數：${r.count}`);
  }catch(e){
    alert('送出失敗：' + e.message);
  }finally{
    showBusy(false);
  }
};

function getCurrentDisplayFromDOM(rowIndex, colIndex){
  const trIdx = rowsData.findIndex(x=>x.rowIndex===rowIndex);
  const hdrIdx = headersMeta.findIndex(h=>h.colIndex===colIndex);
  const tdNode = tbody.children[trIdx]?.children[6+hdrIdx];
  if (!tdNode) return '';
  const input = tdNode.querySelector('input,select,span');
  return input ? (input.value || input.textContent || '').trim() : '';
}

/* ------- 小工具 ------- */
async function postForm(obj){
  const body = new URLSearchParams(obj).toString();
  const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
  return r.json();
}
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

(async function init(){
  if (!payload) return;
  meta.textContent = `群科：${payload.dept}　班級：${payload.clazz}`;
  await loadClass();
})();
</script>
</body>
</html>
