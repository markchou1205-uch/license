<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>教師批次更新</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; max-width: 1200px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .meta { color:#555; margin-bottom: 16px; }
  .meta .badge { display:inline-block; padding:2px 6px; background:#f2f2f2; border-radius:4px; margin-left:6px; font-size:12px; color:#666; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; vertical-align: top; }
  th { background: #fafafa; position: sticky; top:0; z-index:1; }
  input[type="text"] { width: 100%; box-sizing: border-box; padding: 4px 6px; }
  .actions { margin: 12px 0; display:flex; gap:8px; }
  .note { color:#666; font-size:12px; }
  .small { font-size:12px; }
  body { max-width: 1200px; margin: 16px auto; padding: 0 8px; } /* 左側間距縮小 */
  .table-wrap { overflow:auto; }
  table { width: max-content; border-collapse: collapse; } /* 讓表頭完整展開 */
  th, td { white-space: nowrap; padding: 4px 6px; }        /* 不換行、縮小 padding */
  tbody tr:hover { background: #fffbe6; transition: background .15s ease; } /* 滑過高亮 */

</style>
</head>
<body>
<h1>教師批次更新</h1>
<div class="meta">
  角色：教師
  <span class="badge" id="deptBadge"></span>
  <span class="badge" id="classBadge"></span>
  <span class="badge" id="tutorBadge"></span>
  <button id="btnLogout" style="float:right">登出</button>
</div>

<div class="actions">
  <button id="btnReload">重新載入</button>
  <button id="btnSave">確認送出（批次更新）</button>
</div>

<div id="root">讀取中…</div>

<div class="note">
  提示：只有非「班級 / 座號 / 學號 / 姓名」欄位可編輯。每列會帶著來源工作表 <code>_sheet</code> 以便回寫。
</div>
<style>
  #busyMask{position:fixed;inset:0;display:none;background:rgba(255,255,255,.6);backdrop-filter:blur(1px);align-items:center;justify-content:center;z-index:9999}
  #busyMask .sp{width:48px;height:48px;border-radius:50%;border:6px solid #ccc;border-top-color:#4a7;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
<div id="busyMask"><div class="sp"></div></div>
<script>
function showBusy(on){ const m=document.getElementById('busyMask'); if(m) m.style.display = on ? 'flex' : 'none'; }

    // 若未定義 dbg，就提供 fallback；開啟 ?debug=1 才會輸出
(function(){
  if (!window.dbg) {
    window.dbg = function(title, obj) {
      const on = new URLSearchParams(location.search).get('debug') === '1' ||
                 (localStorage.getItem('debug') === '1');
      if (!on) return;
      console.log('[DBG]', title, obj);
    };
  }
})();
  const GAS_BASE = '/api/gas';
  async function apiGet(path, params) {
    const url = GAS_BASE + '?' + new URLSearchParams({ path, ...params });
    dbg('GET ' + url, null);
    const r = await fetch(url);
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try { return JSON.parse(txt); } catch { return { ok:false, as:'html', status:r.status, body:txt }; }
  }

  async function apiPost(path, params) {
    const body = new URLSearchParams({ path, ...params }).toString();
    dbg('POST ' + GAS_BASE, body);
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const txt = await r.text();
    dbg('RESP ' + r.status + ' ' + path, txt);
    try { return JSON.parse(txt); } catch { return { ok:false, as:'html', status:r.status, body:txt }; }
  }

  const token   = localStorage.getItem('token');
  const role    = localStorage.getItem('role');
  const dept    = localStorage.getItem('dept');
  const classId = localStorage.getItem('classId');
  const tutor   = localStorage.getItem('tutor');

if (role !== 'teacher') {
  window.location.href = 'index.html';
}

  document.getElementById('deptBadge').textContent = dept || '';
  document.getElementById('classBadge').textContent = classId ? ('班級：' + classId) : '';
  document.getElementById('tutorBadge').textContent = tutor ? ('導師：' + tutor) : '';

  let headers = [];
  let rows = [];
  let editableGlobal = [];
  let editableBySheet = {};
  let originalRowsMap = new Map(); // key: sid + _sheet → 原始 row 物件

  function keyOf(r){ return String(r['學號'] || '') + '|' + String(r['_sheet'] || ''); }

async function loadClass() {
  showBusy(true);
  // 1) 先吃首頁登入時快取好的資料（若有）
  let res = null;
  const cached = localStorage.getItem('teacherClassData');
  if (cached) {
    try { res = JSON.parse(cached); } catch (e) {}
  }

  // 2) 沒快取，就用 dept/classId/digit 直接打 class.bySheet（不需要 token）
  if (!res) {
    const dept    = localStorage.getItem('dept')    || '';
    const classId = localStorage.getItem('classId') || '';
    const digit   = localStorage.getItem('digit')   || '';
    if (!dept || !classId) {
      alert('請先在首頁選擇群科與班級後再進入教師頁');
      location.href = 'index.html';
      return;
    }
    res = await apiGet('class.bySheet', { dept, classId, digit });
  }

  if (!res || res.ok !== true) {
    throw new Error((res && res.error) || '讀取失敗');
  }

  // 3) 正常渲染（以下名稱依你的檔案而定）
  headers         = res.headers || [];
  rows            = res.rows || [];
  editableGlobal  = res.editable || [];
  editableBySheet = res.editableBySheet || {};

  originalRowsMap.clear();
  rows.forEach(r => originalRowsMap.set(keyOf(r), JSON.parse(JSON.stringify(r))));
  
  renderTable();
  showBusy(false);
}


  function renderTable() {
    const root = document.getElementById('root');
    if (!rows.length) { root.innerHTML = '查無資料（請確認班級/科別是否正確）'; return; }

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    // 表頭：在 headers 最前面加入 _sheet（只讀，幫助除錯）
    const heads = headers.slice();
    const trh = document.createElement('tr');
    heads.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    // 逐列渲染
    rows.forEach((r, idx) => {
      const tr = document.createElement('tr');

      headers.forEach(h => {
        const td = document.createElement('td');
        const val = r[h] ?? '';
        const canEditThisSheet = (editableBySheet[r._sheet] || editableGlobal).includes(h);
        const isFixed = ['班級','座號','學號','姓名'].includes(h);

        if (isFixed || !canEditThisSheet) {
          td.textContent = val;
 } else {
   const lastChar = String(h).slice(-1);
   if (lastChar === '科') {
     td.innerHTML =
       `<select data-row="${idx}" data-key="${h}">
          <option value=""></option>
          <option value="合格" ${val==='合格'?'selected':''}>合格</option>
          <option value="不合格" ${val==='不合格'?'selected':''}>不合格</option>
        </select>`;
   } else {
     td.innerHTML = `<input type="text" data-row="${idx}" data-key="${h}" value="${String(val)}" />`;
   }
 }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    root.innerHTML = '';
    root.appendChild(table);
    // === 欄位規則：乙/丙、號 ===
(function bindRulesOnce(){
  const root = document.getElementById('root');
  if (!root || root.__rulesBound) return;
  root.__rulesBound = true;

  root.addEventListener('change', (ev) => {
    const el = ev.target;
    if (!el.matches('input[data-key], select[data-key]')) return;

    const rowIdx = Number(el.getAttribute('data-row'));
    const key = el.getAttribute('data-key');
    const headersIdx = headers.indexOf(key);
    if (headersIdx < 0) return;

    // 1) 乙/丙 → 檢查前2欄是否皆為「合格」，若是，填入「獲證」
    const lastChar = key.slice(-1);
    if (lastChar === '乙' || lastChar === '丙') {
      const k1 = headers[headersIdx - 2];
      const k2 = headers[headersIdx - 1];
      if (k1 && k2) {
        // 取同列前兩欄目前的值（UI 上的最新值）
        const sel1 = root.querySelector(`[data-row="${rowIdx}"][data-key="${k1}"]`);
        const sel2 = root.querySelector(`[data-row="${rowIdx}"][data-key="${k2}"]`);
        const v1 = sel1 ? (sel1.tagName==='SELECT' ? sel1.value : sel1.value) : rows[rowIdx][k1];
        const v2 = sel2 ? (sel2.tagName==='SELECT' ? sel2.value : sel2.value) : rows[rowIdx][k2];
        if (v1 === '合格' && v2 === '合格') {
          // 將目前欄位改成「獲證」
          if (el.tagName === 'SELECT' || el.tagName === 'INPUT') {
            el.value = '獲證';
          }
        }
      }
    }

    // 2) 號 → 若前1欄為「獲證」，則此欄必填；未填給提示並加紅框
    if (lastChar === '號') {
      const kPrev = headers[headersIdx - 1];
      if (kPrev) {
        const prevEl = root.querySelector(`[data-row="${rowIdx}"][data-key="${kPrev}"]`);
        const prevVal = prevEl ? (prevEl.tagName==='SELECT' ? prevEl.value : prevEl.value) : rows[rowIdx][kPrev];
        const curVal = (el.tagName==='SELECT' ? el.value : el.value);
        if (prevVal === '獲證' && !curVal) {
          el.classList.add('need-input');
          el.style.border = '1px solid #e11';
          alert(`您已取得「${key}」證照，請輸入獲證字號`);
        } else {
          el.classList.remove('need-input');
          el.style.border = '';
        }
      }
    }
  });
})();

  }

  // 收集差異 → updates 陣列
  function collectUpdates() {
    const updates = [];
    const inputs = document.querySelectorAll('input[data-row][data-key]');
    const changedByRow = new Map(); // key: rowIdx → { sid,_sheet, changes:{} }

    inputs.forEach(inp => {
      const rowIdx = Number(inp.dataset.row);
      const key = inp.dataset.key;
      const newVal = inp.value;
      const row = rows[rowIdx];
      const orig = originalRowsMap.get(keyOf(row)) || {};

      const oldVal = orig[key] ?? '';
      if (String(newVal) !== String(oldVal)) {
        if (!changedByRow.has(rowIdx)) {
          changedByRow.set(rowIdx, { sid: String(row['學號'] || ''), _sheet: row._sheet, changes: {} });
        }
        changedByRow.get(rowIdx).changes[key] = newVal;
      }
    });

    changedByRow.forEach(v => {
      // 安全檢查：sid 與 _sheet 必須存在
      if (v.sid && v._sheet && Object.keys(v.changes).length) {
        updates.push(v);
      }
    });

    return updates;
  }

  document.getElementById('btnSave').addEventListener('click', async () => {
    showBusy(true);
    try {
      const updates = collectUpdates();
      if (!updates.length) { alert('沒有變更'); return; }
      const res = await apiPost('class.bulkUpdate', { token, updates: JSON.stringify(updates) });
      if (!res.ok) throw new Error(res.error || '更新失敗');
      alert('已送出！更新筆數：' + res.updated);
      await loadClass(); // 重新讀取最新資料
    } catch (err) {
      alert(err.message);
    }finally {
    showBusy(false);
   }
  });

  document.getElementById('btnReload').addEventListener('click', () => {
    loadClass().catch(err => alert(err.message));
  });

  document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });

  loadClass().catch(err => alert(err.message));
</script>
</body>
</html>
