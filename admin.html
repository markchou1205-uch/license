<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>管理頁 | 職業證照登管系統</title>
<style>
  :root{ --bg:#fff7ed; --card:#fffaf0; --line:#e6d3b8; --text:#3b2f2f; --muted:#8b6b5e;
         --btnBg:#f3f4f6; --btnBorder:#cbd5e1; --btnHover:#e5e7eb; --pri:#f59e0b; --ok:#16a34a; }
  body{margin:0;background:linear-gradient(180deg,var(--bg),#fff);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC"}
  .wrap{width:95%;margin:24px auto}
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tab{padding:8px 14px;border:1px solid var(--btnBorder);border-radius:8px;background:var(--btnBg);cursor:pointer}
  .tab.active{background:#ffe8bb;border-color:#f1c27a}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  label{margin-right:6px}
  select{padding:6px 8px;border:1px solid var(--btnBorder);border-radius:6px;background:#fff;min-width:160px}
  .table-wrap{overflow:auto;margin-top:10px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--line);padding:6px 8px;font-size:14px;white-space:nowrap}
  th{background:#fff3cf}
  tr:nth-child(even) td{background:#fffef8}
  .right{text-align:right}
  .muted{color:var(--muted);font-size:12px}
  .subtotal td{background:#e9f7e9;font-weight:600}
  .grand td{background:#e5f1ff;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="stat">統計</button>
    <button class="tab" data-tab="annual">年度作業</button>
  </div>

  <!-- 統計 -->
  <section id="stat" class="card">
    <div>
      <label>請選擇群科</label>
      <select id="groupSel">
        <option value="汽車科">汽車科</option>
        <option value="資訊科">資訊科</option>
        <option value="商管群">商管群</option>
        <option value="設計群">設計群</option>
        <option value="時尚科">時尚科</option>
        <option value="餐旅群">餐旅群</option>
        <option value="外語群">外語群</option>
      </select>
      <span class="muted">（資料來自登入時快取，切換即時生成）</span>
    </div>
    <div class="table-wrap">
      <table id="tbl">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- 年度作業 -->
  <section id="annual" class="card" style="display:none">
    <h3 style="margin:6px 0">年度作業</h3>
    <p class="muted">此區塊後續依需求補功能。</p>
  </section>
</div>

<script>
/* ============= 分頁切換（只綁定有 data-tab 的項目） ============= */
const tabButtons = document.querySelectorAll('.tab[data-tab]');
tabButtons.forEach(btn=>{
  btn.onclick=()=>{
    tabButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('stat').style.display   = (btn.dataset.tab==='stat')  ? 'block' : 'none';
    document.getElementById('annual').style.display = (btn.dataset.tab==='annual')? 'block' : 'none';
  };
});

/* ============= 動態加入「登出」按鈕（置於分頁列最右） ============= */
(function addLogout(){
  const wrap = document.querySelector('.tabs');
  if (!wrap) return;
  const btn = document.createElement('button');
  btn.id = 'btnLogout';
  btn.className = 'tab';
  btn.textContent = '登出';
  btn.style.marginLeft = 'auto'; // 推到最右
  btn.title = '清除快取並回到登入頁';
  btn.onclick = ()=>{
    try{
      // 清除本系統快取
      sessionStorage.removeItem('adminData');
      sessionStorage.removeItem('teacherList');
      sessionStorage.removeItem('studentRow');
    }catch(_){}
    location.href = 'index.html';
  };
  wrap.appendChild(btn);
})();

/* ============= 讀取快取資料 ============= */
const adminData = JSON.parse(sessionStorage.getItem('adminData')||'null');
if(!adminData || !adminData.ok){ alert('找不到管理員快取，請重新登入'); location.href='index.html'; }

const rosterRows = adminData.roster.rows || []; // [科,班,學號,姓名,座號,身分證,...]
const advisorsMap = adminData.advisors || {};   // {班級: 導師}

/* ============= 群科對應科別 ============= */
const GROUP_MAP = {
  "汽車科": ["汽車科","汽車修護科"],
  "資訊科": ["資訊科","僑生建教資訊","微電腦修護科"],
  "商管群": ["資料處理科","電子商務科"],
  "設計群": ["室內設計科","廣告設計科"],
  "時尚科": ["時尚造型科","僑生建教時尚","美髮技術科","美容造型科"],
  "餐旅群": ["餐飲管理科","僑生建教餐管","餐飲技術科"],
  "外語群": ["應用英語科","應用日語科"]
};

/* ============= 各群科之證照定義（標題、比對簡稱、規則） ============= */
const DEF = {
  "汽車科": [
    {label:"機器腳踏車(丙)張數", key:"機車-丙", rule:"=獲證"},
    {label:"汽車修護(丙)張數",   key:"汽修-丙", rule:"=獲證"},
    {label:"機器腳踏車(乙)張數", key:"機-乙",   rule:"=獲證"},
    {label:"汽車修護(技工)張數", key:"汽修-技工", rule:"=獲證"},
    {label:"汽車修護(乙)張數",   key:"汽修-乙", rule:"=獲證"},
  ],
  "資訊科": [
    {label:"工業電子(丙)張數",   key:"工業電子-丙", rule:"=獲證"},
    {label:"硬體裝修(丙)張數",   key:"硬體裝修-丙", rule:"=獲證"},
    {label:"網路架設(丙)張數",   key:"網路架設-丙", rule:"=獲證"},
    {label:"數位電子(乙)張數",   key:"數位電子-乙", rule:"=獲證"},
    {label:"儀表電子(乙)張數",   key:"儀表電子-乙", rule:"=獲證"},
    {label:"硬體裝修(乙)張數",   key:"硬體裝修-乙", rule:"=獲證"},
    {label:"網路架設(乙)張數",   key:"網路架設-乙", rule:"=獲證"},
  ],
  "商管群": [
    {label:"電軟(丙)張數", key:"電軟-丙", rule:"=獲證"},
    {label:"會計(丙)張數", key:"會計-丙", rule:"=獲證"},
    {label:"網頁(丙)張數", key:"網頁-丙", rule:"=獲證"},
    {label:"門市(丙)張數", key:"門市-丙", rule:"=獲證"},
    {label:"電軟(乙)張數", key:"電軟-乙", rule:"=獲證"},
  ],
  "設計群": [
    {label:"印前製程(丙)張數", key:"印前製程-丙", rule:"=獲證"},
    {label:"視覺傳達(丙)張數", key:"視覺傳達-丙", rule:"=獲證"},
    {label:"攝影(丙)張數",   key:"攝影-丙",   rule:"=獲證"},
    {label:"視覺傳達(乙)張數", key:"視覺傳達-乙", rule:"=獲證"},
    {label:"建圖電繪(丙)張數", key:"建圖電繪-丙", rule:"=獲證"},
    {label:"建圖手繪(丙)張數", key:"建圖手繪-丙", rule:"=獲證"},
    {label:"印前製程(乙)張數", key:"印前製程-乙", rule:"=獲證"},
  ],
  "時尚科": [
    {label:"女子美髮(丙)", key:"女子美髮-丙", rule:"=獲證"},
    {label:"美容(丙)",     key:"美容-丙",     rule:"=獲證"},
    {label:"男子理髮(丙)", key:"男子理髮-丙", rule:"=獲證"},
    {label:"女子美髮(乙)", key:"女子美髮-乙", rule:"=獲證"},
    {label:"美容(乙)",     key:"美容-乙",     rule:"=獲證"},
    {label:"美睫師(丙)",   key:"美睫師-丙",   rule:"=獲證"},
    {label:"美甲師(丙)",   key:"美甲師-丙",   rule:"=獲證"},
    {label:"美甲師(乙)",   key:"美甲師-乙",   rule:"=獲證"},
  ],
  "餐旅群": [
    {label:"中餐烹調(丙)張數", key:"中餐烹調-丙", rule:"=獲證"},
    {label:"烘焙(丙)張數",     key:"烘焙-丙",     rule:"=獲證"},
    {label:"飲料調製(丙)張數", key:"飲料調製-丙", rule:"=獲證"},
    {label:"烘焙-西點(丙)張數", key:"烘焙-西點-丙", rule:"=獲證"},
    {label:"中式麵食(丙)張數", key:"中式麵食-丙", rule:"=獲證"},
    {label:"餐旅服務(丙)張數", key:"餐旅服務-丙", rule:"=獲證"},
    {label:"中餐素食(丙)張數", key:"中餐素食-丙", rule:"=獲證"},
  ],
  "外語群": [
    {label:"電腦軟體(丙)張數", key:"電腦軟體-丙", rule:"=獲證"},
    {label:"電腦軟體(乙)張數", key:"電腦軟體-乙", rule:"=獲證"},
    {label:"多益730以上",     key:"多益",       rule:">=730"},
    {label:"日語N2",          key:"日語N2",     rule:"=V"},
  ]
};

/* ============= 小工具 ============= */
function beforeSlash(s){ s=String(s||''); const i=s.indexOf('/'); return i>=0?s.slice(0,i).trim():s.trim(); }
function afterSlash(s){ s=String(s||''); const i=s.indexOf('/'); return i>=0?s.slice(i+1).trim():''; }
function isPractical(clazz){ return /實/.test(String(clazz)); }
function gradeOf(clazz){
  const s=String(clazz);
  if (isPractical(clazz)) return '實用技能班';
  if (s.includes('一')) return '一年級';
  if (s.includes('二')) return '二年級';
  if (s.includes('三')) return '三年級';
  return '其他';
}

/* ============= 生成表格 ============= */
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const groupSel = document.getElementById('groupSel');

function render(){
  const groupName = groupSel.value;
  const targetDepts = new Set(GROUP_MAP[groupName]||[]);
  const defs = DEF[groupName]||[];

  // 過濾該群科的列
  const rows = rosterRows.filter(r => targetDepts.has(String(r[0]).trim()));

  // 班級 -> 學生列
  const classMap = new Map();
  rows.forEach(r=>{
    const clazz = String(r[1]).trim();
    if (!classMap.has(clazz)) classMap.set(clazz, []);
    classMap.get(clazz).push(r);
  });

  // 組成排序：一年級 -> 二年級 -> 三年級 -> 實用技能班
  const order = ['一年級','二年級','三年級','實用技能班'];
  const classes = Array.from(classMap.keys()).sort((a,b)=>{
    const ga = order.indexOf(gradeOf(a)); const gb = order.indexOf(gradeOf(b));
    if (ga!==gb) return ga-gb;
    return a.localeCompare(b,'zh-Hant');
  });

  /* ---------- 表頭：兩層 ---------- */
  thead.innerHTML = '';
  const trTop = document.createElement('tr');
  const trSub = document.createElement('tr');

  // 基本四欄（rowspan=2）
  ['序號','班級','導師','班級人數'].forEach(t=>{
    const th=document.createElement('th');
    th.textContent=t; th.rowSpan=2;
    trTop.appendChild(th);
  });

  // 證照別（rowspan=2）
  defs.forEach(d=>{
    const th=document.createElement('th');
    th.textContent=d.label; th.rowSpan=2;
    trTop.appendChild(th);
  });

  // 個人獲證（群組）
  const personalCols = ['7張','6張','5張','4張','3張','2張','1張','0張'];
  const thGrp=document.createElement('th');
  thGrp.textContent='個人獲證';
  thGrp.colSpan = personalCols.length; // 8
  trTop.appendChild(thGrp);

  // 個人獲證子欄
  personalCols.forEach(t=>{
    const th=document.createElement('th'); th.textContent=t; trSub.appendChild(th);
  });

  thead.appendChild(trTop);
  thead.appendChild(trSub);

  /* ---------- 判斷命中 ---------- */
  function cellHit(def, cell){
    const title = beforeSlash(cell);
    const val = afterSlash(cell);
    if (title !== def.key) return false;
    if (def.rule === '=獲證') return val === '獲證';
    if (def.rule === '=V') return val.toUpperCase() === 'V';
    if (def.rule.startsWith('>=')) {
      const n = parseInt(val,10), thr = parseInt(def.rule.slice(2),10);
      return Number.isFinite(n) && n >= thr;
    }
    return false;
  }

  /* ---------- 逐班計算與輸出 ---------- */
  tbody.innerHTML='';
  let seq=0;
  function emptyStat(){ return {classCount:0, lic:defs.map(()=>0), per:Array(8).fill(0)}; } // per[0]=7張 ... per[7]=0張
  function addTo(dst, src){
    dst.classCount += src.classCount;
    dst.lic = dst.lic.map((v,i)=> v + src.lic[i]);
    dst.per = dst.per.map((v,i)=> v + src.per[i]);
  }

  const gradeOrder = ['一年級','二年級','三年級','實用技能班'];
  const grand = emptyStat();

  function pushSubtotalRow(label, s){
    const tr=document.createElement('tr'); tr.className='subtotal';
    // 「○年級小計」跨 3 欄（序號+班級+導師）
    const tdSpan=document.createElement('td'); tdSpan.colSpan=3; tdSpan.textContent=label; tr.appendChild(tdSpan);
    const tdCnt=document.createElement('td'); tdCnt.className='right'; tdCnt.textContent=s.classCount; tr.appendChild(tdCnt);
    s.lic.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });
    s.per.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });
    tbody.appendChild(tr);
  }

  gradeOrder.forEach(grade=>{
    const classesOfGrade = classes.filter(c=> gradeOf(c)===grade);
    if (!classesOfGrade.length) return;

    const subtotal = emptyStat();

    classesOfGrade.forEach(clazz=>{
      const students = classMap.get(clazz);
      const stat = emptyStat();
      stat.classCount = students.length;

      students.forEach(r=>{
        let k = 0; // 個人該群科「獲證」數
        for (let c=6;c<r.length;c++){
          const cell = r[c];
          for (let i=0;i<defs.length;i++){
            if (cellHit(defs[i], cell)){
              stat.lic[i] += 1;
              k += 1;
              break;
            }
          }
        }
        const idx = Math.max(0, Math.min(7, 7 - k)); // k>=7落入「7張」
        stat.per[idx] += 1;
      });

      // 輸出班級列
      const tr=document.createElement('tr');

      // 1) 序號
      let td=document.createElement('td'); td.textContent=++seq; tr.appendChild(td);

      // 2) 班級（可點擊開新分頁）
      const dept = students[0][0]; // 取該班第1列的科別
      td=document.createElement('td');
      const link=document.createElement('a');
      link.href='#'; link.textContent=clazz;
      link.onclick=(e)=>{
        e.preventDefault();
        const w=window.open('teacher.html','_blank');
        try{ w.sessionStorage.setItem('teacherList', JSON.stringify({dept, clazz})); }catch(_){} // 同源可行
      };
      td.appendChild(link); tr.appendChild(td);

      // 3) 導師
      td=document.createElement('td'); td.textContent = advisorsMap[clazz]||''; tr.appendChild(td);

      // 4) 班級人數
      td=document.createElement('td'); td.className='right'; td.textContent=stat.classCount; tr.appendChild(td);

      // 5) 證照別
      stat.lic.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });

      // 6) 個人獲證
      stat.per.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });

      tbody.appendChild(tr);

      addTo(subtotal, stat);
    });

    // 年級小計（緊接在此年級結束）
    pushSubtotalRow(`${grade}小計`, subtotal);
    addTo(grand, subtotal);
  });

  // 人數合計（在最底）
  const trG=document.createElement('tr'); trG.className='grand';
  const tdSpan=document.createElement('td'); tdSpan.colSpan=3; tdSpan.textContent='人數合計'; trG.appendChild(tdSpan);
  const tdCnt=document.createElement('td'); tdCnt.className='right'; tdCnt.textContent=grand.classCount; trG.appendChild(tdCnt);
  grand.lic.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; trG.appendChild(td); });
  grand.per.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; trG.appendChild(td); });
  tbody.appendChild(trG);
}

groupSel.onchange = render;
render();
</script>
</body>
</html>
