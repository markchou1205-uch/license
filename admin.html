<!doctype html>
<html lang="zh-Hant">
<head>
<link rel="icon" href="data:,">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>管理頁 | 職業證照登管系統</title>
<style>
  :root{ --bg:#fff7ed; --card:#fffaf0; --line:#e6d3b8; --text:#3b2f2f; --muted:#8b6b5e;
         --btnBg:#f3f4f6; --btnBorder:#cbd5e1; --btnHover:#e5e7eb; --pri:#f59e0b; --ok:#16a34a; }
  body{margin:0;background:linear-gradient(180deg,var(--bg),#fff);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC"}
  .wrap{width:95%;margin:24px auto}
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tab{padding:8px 14px;border:1px solid var(--btnBorder);border-radius:8px;background:var(--btnBg);cursor:pointer}
  .tab.active{background:#ffe8bb;border-color:#f1c27a}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  label{margin-right:6px}
  select{padding:6px 8px;border:1px solid var(--btnBorder);border-radius:6px;background:#fff;min-width:160px}
  .table-wrap{overflow:auto;margin-top:10px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--line);padding:6px 8px;font-size:14px;white-space:nowrap}
  th{background:#fff3cf}
  tr:nth-child(even) td{background:#fffef8}
  .right{text-align:right}
  .muted{color:var(--muted);font-size:12px}
  .subtotal td{background:#e9f7e9;font-weight:600}
  .grand td{background:#e5f1ff;font-weight:700}
  /* === 年度作業 UI === */
.progress{height:14px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:8px;overflow:hidden}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#f59e0b,#fbbf24);transition:width .25s ease}
.note-danger{background:#fff1f2;border:1px solid #fecdd3;color:#991b1b;border-radius:8px;padding:8px 10px;margin:8px 0;font-size:13px}
kbd{background:#111827;color:#fff;border-radius:6px;padding:2px 6px;font-size:12px}
#annual .muted b{color:#7c3aed}
/* 字體放大（只影響 #annual 區塊） */
#annual { font-size:16px; line-height:1.65; }
#annual h3 { font-size:20px; }
#annual .muted { font-size:15px; }
#annual ol li, 
#annual ul li { font-size:15px; }

#annual input#newSheetId { 
  font-size:14px; 
  padding:8px 10px;
}

#annual button.tab { 
  font-size:14px; 
  padding:8px 10px; 
}

#annual .progress { height:16px; }
#annual .note-danger { font-size:14px; }

</style>
</head>
<body>
<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="stat">統計</button>
    <button class="tab" data-tab="annual">年度作業</button>
  </div>

  <!-- 統計 -->
  <section id="stat" class="card">
    <div>
      <label>請選擇群科</label>
      <select id="groupSel">
        <option value="汽車科">汽車科</option>
        <option value="資訊科">資訊科</option>
        <option value="商管群">商管群</option>
        <option value="設計群">設計群</option>
        <option value="時尚科">時尚科</option>
        <option value="餐旅群">餐旅群</option>
        <option value="外語群">外語群</option>
      </select>
      <span class="muted">（資料來自登入時快取，切換即時生成）</span>
    </div>
    <div class="table-wrap">
      <table id="tbl">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- 年度作業 -->
  <section id="annual" class="card" style="display:none">
    <h3 style="margin:6px 0">年度作業</h3>
    <div>
  <ol class="muted" style="line-height:1.7">
    <li>新的名冊是 Excel，請先上傳到 Google 雲端硬碟後，「開啟 ➜ 檔案 ➜ 另存成 Google 試算表」。</li>
    <li>找到含全部學生資料的工作表，將該分頁<strong>更名為「完整基本資料」</strong>。</li>
    <li>複製新名冊的試算表 <b>ID</b>：開啟新名冊網址 <code>https://docs.google.com/spreadsheets/d/<b>這段就是ID</b>/edit</code>，把 <b>/d/ 與 /edit</b> 中間的字串貼到下面的欄位。</li>
  </ol>

  <div style="display:flex;gap:8px;align-items:center;margin:10px 0 6px">
    <label for="newSheetId"><b>新名冊試算表 ID</b></label>
    <input id="newSheetId" placeholder="例如：1AbCDeFgHiJkLmNoPqRsTuVwXyZ1234567890" style="flex:1;padding:6px 8px;border:1px solid var(--btnBorder);border-radius:6px">
    <button id="btnCheck"   class="tab" title="檢查新名冊是否有「完整基本資料」">檢查 ID</button>
    <button id="btnStart"   class="tab" title="開始年度更新流程（約需數十秒～數分鐘，請勿關閉頁面）" disabled>開始更新</button>
  </div>

  <div id="annualWarn" class="note-danger" style="display:none">
    ⚠️ <b>系統更新中，請勿關閉網頁，以免系統毀損。</b>
  </div>

  <div class="progress" style="margin:8px 0 6px">
    <div id="annualBar" class="progress-bar"></div>
  </div>
  <div id="annualMsg" class="muted">尚未開始</div>

  <details style="margin-top:8px">
    <summary><b>本流程會做什麼？（點我展開）</b></summary>
    <ul class="muted" style="line-height:1.7">
      <li>在新名冊建立 <b>名冊+證照 / 非在校生 / 管理員帳密 / 導師名冊</b>；把「完整基本資料」的前 6 欄貼到「名冊+證照」，並將其儲存格格式設為「文字」。</li>
      <li>從舊總表複製「非在校生」「管理員帳密」到新名冊同名分頁；在新名冊「導師名冊」A1=班級、B1=導師姓名（待管理員貼入）。</li>
      <li>依 <b>第6欄身分證號</b> 對應：命中就把舊表第7欄(含)以後整段貼到新表同列；找不到就將舊表該列 1~6 欄附加到新表「非在校生」。</li>
      <li>在資料夾 <a href="https://drive.google.com/drive/folders/1CLfwJ4v2l1o6WVMySOt7jKJFOY62jTpk" target="_blank" rel="noopener">此路徑</a> 內找/建「備份資料表」資料夾，完整複製舊總表為 <b>YYYY-MM-DD 檢定資料備份檔</b>，最後用新名冊各分頁覆蓋舊總表同名分頁。</li>
    </ul>
  </details>
</div>

  </section>
</div>

<script>
/* ============= 分頁切換（只綁定有 data-tab 的項目） ============= */
const tabButtons = document.querySelectorAll('.tab[data-tab]');
tabButtons.forEach(btn=>{
  btn.onclick=()=>{
    tabButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('stat').style.display   = (btn.dataset.tab==='stat')  ? 'block' : 'none';
    document.getElementById('annual').style.display = (btn.dataset.tab==='annual')? 'block' : 'none';
  };
});

/* ============= 動態加入「登出」按鈕（置於分頁列最右） ============= */
(function addLogout(){
  const wrap = document.querySelector('.tabs');
  if (!wrap) return;
  const btn = document.createElement('button');
  btn.id = 'btnLogout';
  btn.className = 'tab';
  btn.textContent = '登出';
  btn.style.marginLeft = 'auto'; // 推到最右
  btn.title = '清除快取並回到登入頁';
  btn.onclick = ()=>{
    try{
      // 清除本系統快取
      sessionStorage.removeItem('adminData');
      sessionStorage.removeItem('teacherList');
      sessionStorage.removeItem('studentRow');
    }catch(_){}
    location.href = 'index.html';
  };
  wrap.appendChild(btn);
})();
  /* ====== 匯出目前表格為 PDF ====== */
function downloadPDF(){
  const group = document.getElementById('groupSel')?.value || '';
  const tbl = document.getElementById('tbl');
  if(!tbl){ alert('找不到表格'); return; }

  // 取目前表格 HTML（含兩層表頭與小計/合計列）
  const tableHTML = tbl.outerHTML;

  // 另開視窗，注入最小列印樣式，使用瀏覽器的「另存為 PDF」
  const w = window.open('', '_blank');
  w.document.open();
  w.document.write(`<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>${document.title} - ${group}</title>
<style>
  @page { size: A3 landscape; margin: 12mm; }
  body { font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif; }
  h2 { text-align:center; margin: 0 0 6mm; }
  .meta { display:flex; justify-content:space-between; margin: 0 0 4mm; font-size: 12px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #cfcfcf; padding: 6px 8px; font-size: 12px; white-space: nowrap; }
  th { background: #fff3cf; }
  .subtotal td { background: #e9f7e9; font-weight: 600; }
  .grand td { background: #e5f1ff; font-weight: 700; }
</style>
</head>
<body>
  <h2>職業證照登管系統：${group} 統計表</h2>
  <div class="meta">
    <div>匯出時間：${new Date().toLocaleString()}</div>
    <div>來源頁面：${location.href}</div>
  </div>
  ${tableHTML}
  <script>window.addEventListener('load', function(){ setTimeout(function(){ window.print(); window.close(); }, 150); });<\/script>
</body>
</html>`);
  w.document.close();
}

/* ====== 動態加入「下載成PDF」按鈕（置於分頁列右側、在「登出」左邊） ====== */
(function addDownload(){
  const bar = document.querySelector('.tabs');
  if (!bar) return;

  const logoutBtn = document.getElementById('btnLogout');

  const btn = document.createElement('button');
  btn.id = 'btnDownloadPDF';
  btn.className = 'tab';
  btn.textContent = '下載成PDF';
  btn.title = '將目前畫面表格匯出為 PDF';

  // 若有登出鈕，就插在它前面；否則靠右顯示
  if (logoutBtn) {
    bar.insertBefore(btn, logoutBtn);
  } else {
    btn.style.marginLeft = 'auto';
    bar.appendChild(btn);
  }

  btn.onclick = downloadPDF;
})();
/* ====== Spinner 與 GAS 呼叫 ====== */
(function ensureSpinner(){
  if (!document.getElementById('busy')) {
    const el = document.createElement('div');
    el.id = 'busy';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:9999';
    el.innerHTML = '<div style="width:48px;height:48px;border:5px solid #fff;border-top-color:#f59e0b;border-radius:50%;animation:spin .9s linear infinite"></div>';
    document.body.appendChild(el);
    const st = document.createElement('style'); st.textContent='@keyframes spin{to{transform:rotate(360deg)}}'; document.head.appendChild(st);
  }
})();
function showBusy(on){ const el=document.getElementById('busy'); if(el) el.style.display = on?'flex':'none'; }

const GAS_BASE = '/api/gas';
async function gasPost(obj){
  const body = new URLSearchParams(obj).toString();
  const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
  return r.json();
}
/* ============= 讀取快取資料 ============= */
const adminData = JSON.parse(sessionStorage.getItem('adminData')||'null');
if(!adminData || !adminData.ok){ alert('找不到管理員快取，請重新登入'); location.href='index.html'; }

const rosterRows = adminData.roster.rows || []; // [科,班,學號,姓名,座號,身分證,...]
const advisorsMap = adminData.advisors || {};   // {班級: 導師}

  /* ====== 在校生／非在校生 資料快取與狀態 ====== */
const DATASETS = {
  school: { roster: adminData.roster, advisors: adminData.advisors }, // 登入時已帶入
  alumni: null  // 第一次切換時再抓取
};
let currentMode = 'school';        // 'school' | 'alumni'
let firstDigit = '';               // '0'~'9'，僅 alumni 使用


/* ============= 群科對應科別 ============= */
const GROUP_MAP = {
  "汽車科": ["汽車科","汽車修護科"],
  "資訊科": ["資訊科","僑生建教資訊","微電腦修護科"],
  "商管群": ["資料處理科","電子商務科"],
  "設計群": ["室內設計科","廣告設計科"],
  "時尚科": ["時尚造型科","僑生建教時尚","美髮技術科","美容造型科"],
  "餐旅群": ["餐飲管理科","僑生建教餐管","餐飲技術科"],
  "外語群": ["應用英語科","應用日語科"]
};

/* ============= 各群科之證照定義（標題、比對簡稱、規則） ============= */
const DEF = {
  "汽車科": [
    {label:"機器腳踏車(丙)張數", key:"機車-丙", rule:"=獲證"},
    {label:"汽車修護(丙)張數",   key:"汽修-丙", rule:"=獲證"},
    {label:"機器腳踏車(乙)張數", key:"機-乙",   rule:"=獲證"},
    {label:"汽車修護(技工)張數", key:"汽修-技工", rule:"=獲證"},
    {label:"汽車修護(乙)張數",   key:"汽修-乙", rule:"=獲證"},
  ],
  "資訊科": [
    {label:"工業電子(丙)張數",   key:"工業電子-丙", rule:"=獲證"},
    {label:"硬體裝修(丙)張數",   key:"硬體裝修-丙", rule:"=獲證"},
    {label:"網路架設(丙)張數",   key:"網路架設-丙", rule:"=獲證"},
    {label:"數位電子(乙)張數",   key:"數位電子-乙", rule:"=獲證"},
    {label:"儀表電子(乙)張數",   key:"儀表電子-乙", rule:"=獲證"},
    {label:"硬體裝修(乙)張數",   key:"硬體裝修-乙", rule:"=獲證"},
    {label:"網路架設(乙)張數",   key:"網路架設-乙", rule:"=獲證"},
  ],
  "商管群": [
    {label:"電軟(丙)張數", key:"電軟-丙", rule:"=獲證"},
    {label:"會計(丙)張數", key:"會計-丙", rule:"=獲證"},
    {label:"網頁(丙)張數", key:"網頁-丙", rule:"=獲證"},
    {label:"門市(丙)張數", key:"門市-丙", rule:"=獲證"},
    {label:"電軟(乙)張數", key:"電軟-乙", rule:"=獲證"},
  ],
  "設計群": [
    {label:"印前製程(丙)張數", key:"印前製程-丙", rule:"=獲證"},
    {label:"視覺傳達(丙)張數", key:"視覺傳達-丙", rule:"=獲證"},
    {label:"攝影(丙)張數",   key:"攝影-丙",   rule:"=獲證"},
    {label:"視覺傳達(乙)張數", key:"視覺傳達-乙", rule:"=獲證"},
    {label:"建圖電繪(丙)張數", key:"建圖電繪-丙", rule:"=獲證"},
    {label:"建圖手繪(丙)張數", key:"建圖手繪-丙", rule:"=獲證"},
    {label:"印前製程(乙)張數", key:"印前製程-乙", rule:"=獲證"},
  ],
  "時尚科": [
    {label:"女子美髮(丙)", key:"女子美髮-丙", rule:"=獲證"},
    {label:"美容(丙)",     key:"美容-丙",     rule:"=獲證"},
    {label:"男子理髮(丙)", key:"男子理髮-丙", rule:"=獲證"},
    {label:"女子美髮(乙)", key:"女子美髮-乙", rule:"=獲證"},
    {label:"美容(乙)",     key:"美容-乙",     rule:"=獲證"},
    {label:"美睫師(丙)",   key:"美睫師-丙",   rule:"=獲證"},
    {label:"美甲師(丙)",   key:"美甲師-丙",   rule:"=獲證"},
    {label:"美甲師(乙)",   key:"美甲師-乙",   rule:"=獲證"},
  ],
  "餐旅群": [
    {label:"中餐烹調(丙)張數", key:"中餐烹調-丙", rule:"=獲證"},
    {label:"烘焙(丙)張數",     key:"烘焙-丙",     rule:"=獲證"},
    {label:"飲料調製(丙)張數", key:"飲料調製-丙", rule:"=獲證"},
    {label:"烘焙-西點(丙)張數", key:"烘焙-西點-丙", rule:"=獲證"},
    {label:"中式麵食(丙)張數", key:"中式麵食-丙", rule:"=獲證"},
    {label:"餐旅服務(丙)張數", key:"餐旅服務-丙", rule:"=獲證"},
    {label:"中餐素食(丙)張數", key:"中餐素食-丙", rule:"=獲證"},
  ],
  "外語群": [
    {label:"電腦軟體(丙)張數", key:"電腦軟體-丙", rule:"=獲證"},
    {label:"電腦軟體(乙)張數", key:"電腦軟體-乙", rule:"=獲證"},
    {label:"多益730以上",     key:"多益",       rule:">=730"},
    {label:"日語N2",          key:"日語N2",     rule:"=V"},
  ]
};

/* ============= 小工具 ============= */
function beforeSlash(s){ s=String(s||''); const i=s.indexOf('/'); return i>=0?s.slice(0,i).trim():s.trim(); }
function afterSlash(s){ s=String(s||''); const i=s.indexOf('/'); return i>=0?s.slice(i+1).trim():''; }
function isPractical(clazz){ return /實/.test(String(clazz)); }
function gradeOf(clazz){
  const s=String(clazz);
  if (isPractical(clazz)) return '實用技能班';
  if (s.includes('一')) return '一年級';
  if (s.includes('二')) return '二年級';
  if (s.includes('三')) return '三年級';
  return '其他';
}

/* ============= 生成表格 ============= */
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const groupSel = document.getElementById('groupSel');
/* ====== 動態注入：學生類別（在校生／非在校生）與 學號第1碼 ====== */
const statCardTop = document.querySelector('#stat > div'); // 與「請選擇群科」在同一行
const modeWrap = document.createElement('span');
modeWrap.style.marginRight = '10px';
modeWrap.innerHTML = `
  <label style="margin-right:6px">學生類別</label>
  <label style="margin-right:8px"><input type="radio" name="modeKind" value="school" checked> 在校生</label>
  <label><input type="radio" name="modeKind" value="alumni"> 非在校生</label>
`;
statCardTop.insertBefore(modeWrap, statCardTop.firstChild);

// 學號第1碼（僅非在校生時顯示）
const digitSel = document.createElement('select');
digitSel.id = 'digitSel';
digitSel.style.marginLeft = '8px';
digitSel.style.display = 'none';
digitSel.innerHTML = '<option value="">學號第1碼</option>' + Array.from({length:10},(_,i)=>`<option value="${i}">${i}</option>`).join('');
statCardTop.appendChild(digitSel);

// 監聽模式切換
statCardTop.querySelectorAll('input[name="modeKind"]').forEach(r=>{
  r.addEventListener('change', async ()=>{
    const v = r.value;
    if (v === currentMode) return;
    currentMode = v;

    if (currentMode === 'alumni') {
      // 顯示 Spinner 並拉「非在校生」資料（若尚未快取）
      digitSel.style.display = '';
      firstDigit = ''; digitSel.value = '';
      if (!DATASETS.alumni) {
        showBusy(true);
        try{
          const res = await gasPost({ path:'get_all_data', sheet:'非在校生' });
          if(!res.ok){ alert(res.error||'讀取「非在校生」失敗'); currentMode='school'; digitSel.style.display='none'; return; }
          DATASETS.alumni = { roster: res.roster, advisors: res.advisors||{} };
        }catch(e){
          alert('連線異常：'+e.message); currentMode='school'; digitSel.style.display='none';
        }finally{
          showBusy(false);
        }
      }
      // 非在校生：等使用者選 digit 再 render
      clearTable();
    } else {
      // 在校生：隱藏 digit，立即 render
      digitSel.style.display = 'none';
      render();
    }
  });
});

// digit 改變才 render（僅 alumni）
digitSel.addEventListener('change', ()=>{
  firstDigit = digitSel.value || '';
  if (currentMode === 'alumni') {
    if (firstDigit) render(); else clearTable();
  }
});

function clearTable(){ thead.innerHTML=''; tbody.innerHTML=''; }


function render(){
  const groupName = groupSel.value;
  const targetDepts = new Set(GROUP_MAP[groupName]||[]);
  const defs = DEF[groupName]||[];

  // 過濾該群科的列
  // 來源資料集
const cur = (currentMode === 'alumni' ? DATASETS.alumni : DATASETS.school);
const headers = cur.roster.headers || [];
const rowsAll = cur.roster.rows || [];
const advisors = cur.advisors || advisorsMap;

// 找出「學號」欄位索引（防止不同表欄位順序差異）
const sidIdx = Math.max(0, headers.findIndex(h=> String(h).includes('學號')));

// 先依科別篩
let rows = rowsAll.filter(r => targetDepts.has(String(r[0]).trim()));

// 非在校生：若已選學號第1碼，再加一層篩選
if (currentMode === 'alumni' && firstDigit) {
  rows = rows.filter(r => String(r[sidIdx]||'').trim().charAt(0) === firstDigit);
}


  // 班級 -> 學生列
  const classMap = new Map();
  rows.forEach(r=>{
    const clazz = String(r[1]).trim();
    if (!classMap.has(clazz)) classMap.set(clazz, []);
    classMap.get(clazz).push(r);
  });

  // 組成排序：一年級 -> 二年級 -> 三年級 -> 實用技能班
  const order = ['一年級','二年級','三年級','實用技能班'];
  const classes = Array.from(classMap.keys()).sort((a,b)=>{
    const ga = order.indexOf(gradeOf(a)); const gb = order.indexOf(gradeOf(b));
    if (ga!==gb) return ga-gb;
    return a.localeCompare(b,'zh-Hant');
  });

  /* ---------- 表頭：兩層 ---------- */
  thead.innerHTML = '';
  const trTop = document.createElement('tr');
  const trSub = document.createElement('tr');

  // 基本四欄（rowspan=2）
  ['序號','班級','導師','班級人數'].forEach(t=>{
    const th=document.createElement('th');
    th.textContent=t; th.rowSpan=2;
    trTop.appendChild(th);
  });

  // 證照別（rowspan=2）
  defs.forEach(d=>{
    const th=document.createElement('th');
    th.textContent=d.label; th.rowSpan=2;
    trTop.appendChild(th);
  });

  // 個人獲證（群組）
  const personalCols = ['7張','6張','5張','4張','3張','2張','1張','0張'];
  const thGrp=document.createElement('th');
  thGrp.textContent='個人獲證';
  thGrp.colSpan = personalCols.length; // 8
  trTop.appendChild(thGrp);

  // 個人獲證子欄
  personalCols.forEach(t=>{
    const th=document.createElement('th'); th.textContent=t; trSub.appendChild(th);
  });

  thead.appendChild(trTop);
  thead.appendChild(trSub);

  /* ---------- 判斷命中 ---------- */
  function cellHit(def, cell){
    const title = beforeSlash(cell);
    const val = afterSlash(cell);
    if (title !== def.key) return false;
    if (def.rule === '=獲證') return val === '獲證';
    if (def.rule === '=V') return val.toUpperCase() === 'V';
    if (def.rule.startsWith('>=')) {
      const n = parseInt(val,10), thr = parseInt(def.rule.slice(2),10);
      return Number.isFinite(n) && n >= thr;
    }
    return false;
  }

  /* ---------- 逐班計算與輸出 ---------- */
  tbody.innerHTML='';
  let seq=0;
  function emptyStat(){ return {classCount:0, lic:defs.map(()=>0), per:Array(8).fill(0)}; } // per[0]=7張 ... per[7]=0張
  function addTo(dst, src){
    dst.classCount += src.classCount;
    dst.lic = dst.lic.map((v,i)=> v + src.lic[i]);
    dst.per = dst.per.map((v,i)=> v + src.per[i]);
  }

  const gradeOrder = ['一年級','二年級','三年級','實用技能班'];
  const grand = emptyStat();

  function pushSubtotalRow(label, s){
    const tr=document.createElement('tr'); tr.className='subtotal';
    // 「○年級小計」跨 3 欄（序號+班級+導師）
    const tdSpan=document.createElement('td'); tdSpan.colSpan=3; tdSpan.textContent=label; tr.appendChild(tdSpan);
    const tdCnt=document.createElement('td'); tdCnt.className='right'; tdCnt.textContent=s.classCount; tr.appendChild(tdCnt);
    s.lic.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });
    s.per.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });
    tbody.appendChild(tr);
  }

  gradeOrder.forEach(grade=>{
    const classesOfGrade = classes.filter(c=> gradeOf(c)===grade);
    if (!classesOfGrade.length) return;

    const subtotal = emptyStat();

    classesOfGrade.forEach(clazz=>{
      const students = classMap.get(clazz);
      const stat = emptyStat();
      stat.classCount = students.length;

      students.forEach(r=>{
        let k = 0; // 個人該群科「獲證」數
        for (let c=6;c<r.length;c++){
          const cell = r[c];
          for (let i=0;i<defs.length;i++){
            if (cellHit(defs[i], cell)){
              stat.lic[i] += 1;
              k += 1;
              break;
            }
          }
        }
        const idx = Math.max(0, Math.min(7, 7 - k)); // k>=7落入「7張」
        stat.per[idx] += 1;
      });

      // 輸出班級列
      const tr=document.createElement('tr');

      // 1) 序號
      let td=document.createElement('td'); td.textContent=++seq; tr.appendChild(td);

      // 2) 班級（可點擊開新分頁）
      const dept = students[0][0]; // 取該班第1列的科別
      td=document.createElement('td');
      const link=document.createElement('a');
      link.href='#'; link.textContent=clazz;
      link.onclick=(e)=>{
        e.preventDefault();
        const w=window.open('teacher.html','_blank');
        try{ w.sessionStorage.setItem('teacherList', JSON.stringify({dept, clazz})); }catch(_){} // 同源可行
      };
      td.appendChild(link); tr.appendChild(td);

      // 3) 導師
      td=document.createElement('td'); td.textContent = advisors[clazz]||''; tr.appendChild(td);

      // 4) 班級人數
      td=document.createElement('td'); td.className='right'; td.textContent=stat.classCount; tr.appendChild(td);

      // 5) 證照別
      stat.lic.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });

      // 6) 個人獲證
      stat.per.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; tr.appendChild(td); });

      tbody.appendChild(tr);

      addTo(subtotal, stat);
    });

    // 年級小計（緊接在此年級結束）
    pushSubtotalRow(`${grade}小計`, subtotal);
    addTo(grand, subtotal);
  });

  // 人數合計（在最底）
  const trG=document.createElement('tr'); trG.className='grand';
  const tdSpan=document.createElement('td'); tdSpan.colSpan=3; tdSpan.textContent='人數合計'; trG.appendChild(tdSpan);
  const tdCnt=document.createElement('td'); tdCnt.className='right'; tdCnt.textContent=grand.classCount; trG.appendChild(tdCnt);
  grand.lic.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; trG.appendChild(td); });
  grand.per.forEach(v=>{ const td=document.createElement('td'); td.className='right'; td.textContent=v; trG.appendChild(td); });
  tbody.appendChild(trG);
}
/* ================= 年度作業（年度名冊更新） ================= */

// 取得元素
const newSheetIdInput = document.getElementById('newSheetId');
const btnCheck  = document.getElementById('btnCheck');
const btnStart  = document.getElementById('btnStart');
const bar       = document.getElementById('annualBar');
const msg       = document.getElementById('annualMsg');
const warnBox   = document.getElementById('annualWarn');

function setProgress(p, text){
  const pct = Math.max(0, Math.min(100, Math.round(p)));
  bar.style.width = pct + '%';
  msg.textContent = text || (pct + '%');
}

function setWorking(on){
  warnBox.style.display = on ? 'block' : 'none';
  showBusy(on);
  btnCheck.disabled = on;
  btnStart.disabled = on;
  newSheetIdInput.disabled = on;
}

function toastDone(){
  alert('系統更新完畢');
}

// 檢查是否有「完整基本資料」並建立必要頁（annual_prep）
btnCheck?.addEventListener('click', async ()=>{
  const newId = (newSheetIdInput.value||'').trim();
  if(!newId){ alert('請先貼上【新名冊試算表 ID】'); return; }

  setProgress(5, '正在檢查新名冊…');
  setWorking(true);
  try{
    const res = await gasPost({ path:'annual_prep', newId });
    if(!res.ok){ setProgress(0, '檢查失敗'); alert(res.error||'annual_prep 失敗'); return; }
    setProgress(10, '新名冊檢查與初始化完成，可開始更新');
    btnStart.disabled = false;
  }catch(e){
    alert('連線異常：'+e.message);
    setProgress(0, '發生錯誤');
  }finally{
    setWorking(false);
  }
});

// 開始完整流程：annual_prep → annual_migrate(分段) → annual_finalize
btnStart?.addEventListener('click', async ()=>{
  const newId = (newSheetIdInput.value||'').trim();
  if(!newId){ alert('請先貼上【新名冊試算表 ID】並按「檢查 ID」'); return; }

  // 再保守呼叫一次 prep（可略過，確保環境）
  setWorking(true);
  setProgress(5, '環境準備…');
  try{
    let r1 = await gasPost({ path:'annual_prep', newId });
    if(!r1.ok){ alert(r1.error||'annual_prep 失敗'); setWorking(false); return; }
  }catch(e){
    alert('連線異常：'+e.message); setWorking(false); return;
  }

  // 分段遷移
  setProgress(12, '開始比對與遷移（依第6欄身分證號）…');
  let offset = 0, total = 0, done = 0;
  const batch = 600; // 每批處理筆數；如遇超時可調小

  try{
    while(true){
      const r2 = await gasPost({ path:'annual_migrate', newId, offset, size: batch });
      if(!r2.ok){ alert(r2.error||'annual_migrate 失敗'); setWorking(false); return; }
      total = r2.total || total;
      done  = (done + (r2.done||0));
      offset = r2.nextOffset || 0;

      // 進度：把 12%~92% 區間給遷移
      const pct = total>0 ? (12 + Math.min(80, Math.floor(80 * done / total))) : 50;
      setProgress(pct, `遷移中… (${done}/${total})`);

      if (offset >= total) break; // 全部處理完畢
      // 讓 UI 有機會更新
      await new Promise(r=>setTimeout(r, 50));
    }
  }catch(e){
    alert('連線異常：'+e.message); setWorking(false); return;
  }

  // 最後收尾：備份舊總表，覆蓋舊總表
  setProgress(95, '備份舊總表並覆蓋更新中…');
  try{
    const r3 = await gasPost({ path:'annual_finalize', newId });
    if(!r3.ok){ alert(r3.error||'annual_finalize 失敗'); setWorking(false); return; }
    setProgress(100, '完成！');
    toastDone();
  }catch(e){
    alert('連線異常：'+e.message);
    setProgress(98, '完成前發生錯誤');
  }finally{
    setWorking(false);
  }
});

groupSel.onchange = render;
render();
</script>
</body>
</html>
