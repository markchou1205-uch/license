<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>學生填報</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .meta { color:#555; margin-bottom: 16px; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 14px; vertical-align: top; }
  th { background: #fafafa; text-align: left; }
  input[type="text"] { width: 100%; box-sizing: border-box; padding: 6px 8px; }
  .actions { margin-top: 12px; display:flex; gap:8px; }
  .badge { display:inline-block; padding:2px 6px; background:#f2f2f2; border-radius:4px; margin-left:6px; font-size:12px; color:#666; }
  .loading { text-align: center; padding: 40px; color: #666; }
  .error { color: #d32f2f; background: #ffebee; padding: 12px; border-radius: 4px; margin: 16px 0; }
</style>
</head>
<body>
<h1>學生填報</h1>
<div class="meta">
  角色:學生<span class="badge" id="deptBadge"></span>
  <button id="btnLogout" style="float:right">登出</button>
</div>

<div id="root">
  <div class="loading">載入中,請稍候...</div>
</div>

<div class="actions">
  <button id="btnSubmit">確認送出</button>
</div>
<!-- 全畫面遮罩 + 轉圈圈 -->
<style>
  #busyMask {
    position: fixed; inset: 0; display: none;
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(1px);
    align-items: center; justify-content: center;
    z-index: 9999;
  }
  .spinner {
    width: 56px; height: 56px; border-radius: 50%;
    border: 6px solid #c8c8c8; border-top-color: #4a7;
    animation: sp 0.9s linear infinite;
  }
  @keyframes sp { to { transform: rotate(360deg); } }
</style>
  <style>
#certModal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:12000}
#certDialog{background:#fff;border-radius:8px;padding:16px;min-width:280px;max-width:90vw}
#certDialog h3{margin:0 0 8px;font-size:16px}
#certDialog .row{margin:8px 0}
#certDialog .row input[type="file"]{width:100%}
#certDialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
#certDialog button{padding:6px 10px}
#certUploadHint{font-size:12px;color:#666}
</style>
<div id="certModal">
  <div id="certDialog">
    <h3>請先上傳證書相片後，再輸入證號</h3>
    <div class="row">
      <button id="btnPickFile">請上傳證照相片</button>
      <input id="fileInputHidden" type="file" accept="image/*" style="display:none" />
      <div id="certUploadHint">尚未選擇檔案</div>
    </div>
    <div class="row">
      <label>請輸入證號</label>
      <input id="certNoInput" type="text" disabled />
    </div>
    <div class="actions">
      <button id="btnCancelCert">取消</button>
      <button id="btnOkCert" disabled>確認</button>
    </div>
  </div>
</div>
<script>
// 彈窗控制
const certModal = document.getElementById('certModal');
const btnPickFile = document.getElementById('btnPickFile');
const fileInputHidden = document.getElementById('fileInputHidden');
const certNoInput = document.getElementById('certNoInput');
const btnOkCert = document.getElementById('btnOkCert');
const btnCancelCert = document.getElementById('btnCancelCert');
let certModalCtx = { col: null, certName: '', uploadedUrl: '' };

function openCertModal(col, certName){
  certModalCtx = { col, certName, uploadedUrl: '' };
  document.getElementById('certUploadHint').textContent = '尚未選擇檔案';
  certNoInput.value = '';
  certNoInput.disabled = true;
  btnOkCert.disabled = true;
  certModal.style.display = 'flex';
}
function closeCertModal(){ certModal.style.display = 'none'; }

btnPickFile.addEventListener('click', ()=> fileInputHidden.click());
btnCancelCert.addEventListener('click', closeCertModal);

fileInputHidden.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  document.getElementById('certUploadHint').textContent = '上傳中…';
  // 讀 base64
  const base64 = await new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(String(r.result).split(',')[1] || '');
    r.onerror = rej;
    r.readAsDataURL(f);
  });
  // 呼叫後端上傳
  const token = localStorage.getItem('token') || '';
  const mimeType = f.type || 'image/jpeg';
  const certName = certModalCtx.certName || '證照';
  const body = new URLSearchParams({ 
    path:'upload.certificate', token, mimeType, certName, base64 
  });
  const resp = await fetch('/api/gas', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
  const js = await resp.json();
  if (!js.ok) { alert(js.error || '上傳失敗'); return; }
  certModalCtx.uploadedUrl = js.url;
  document.getElementById('certUploadHint').textContent = '已上傳：' + (f.name || '圖片') + '（可輸入證號）';
  certNoInput.disabled = false;
  btnOkCert.disabled = false;
});

btnOkCert.addEventListener('click', ()=>{
  if (!certModalCtx.uploadedUrl) { alert('請先上傳圖片'); return; }
  if (!certNoInput.value.trim()) { alert('請輸入證號'); return; }
  // 回填到畫面上的「獲證字號」欄、並記錄 linkByCol
  const col = certModalCtx.col;
  const input = document.querySelector(`[data-col="${col}"][data-key="獲證字號"]`) 
              || document.querySelector(`[data-col="${col}"]`);
  if (input) input.value = certNoInput.value.trim();

  // 記錄：此欄對應的圖片 URL（儲存時一併帶給後端）
  window.__linkByCol = window.__linkByCol || [];
  const existed = window.__linkByCol.find(x => x.col === col);
  if (existed) existed.url = certModalCtx.uploadedUrl;
  else window.__linkByCol.push({ col, url: certModalCtx.uploadedUrl });

  closeCertModal();
});
</script>

<div id="busyMask"><div class="spinner"></div></div>
<script>
  const GAS_BASE = '/api/gas';

  (function(){ if (!window.dbg) window.dbg = (t,o)=>{ 
    const on = new URLSearchParams(location.search).get('debug')==='1' || localStorage.getItem('debug')==='1';
    if (on) console.log('[DBG]',t,o); 
  };})();

  async function apiGet(path, params) {
    const url = GAS_BASE + '?' + new URLSearchParams({ path, ...params });
    dbg('GET '+url,null);
    const r = await fetch(url); 
    const t = await r.text(); 
    dbg('RESP '+r.status+' '+path,t);
    try { return JSON.parse(t); } catch { return {ok:false, as:'html', status:r.status, body:t}; }
  }

  async function apiPost(path, params) {
    const body = new URLSearchParams({ path, ...params }).toString();
    dbg('POST '+GAS_BASE, body);
    const r = await fetch(GAS_BASE, { 
      method:'POST', 
      headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
      body 
    });
    const t = await r.text(); 
    dbg('RESP '+r.status+' '+path,t);
    try { return JSON.parse(t); } catch { return {ok:false, as:'html', status:r.status, body:t}; }
  }

  // 關鍵修正:檢查 localStorage 中的資料
  const token = localStorage.getItem('token');
  const role  = localStorage.getItem('role');
  const dept  = localStorage.getItem('dept');
  const designSub = localStorage.getItem('designSub') || '';
    // ★ 防呆：設計群一定要有子別，否則請回首頁重新登入選子別
  if (role !== 'student') {
    location.href = 'index.html';
  } else if (dept === '設計群' && !designSub) {
    alert('請回首頁選擇子別（廣設 / 室設）後再進入學生頁');
    location.href = 'index.html';
  }
  if (!token || role !== 'student') {
    alert('請先登入');
    location.href = 'index.html';
  }

  // 關鍵修正:驗證 dept 是否存在
  if (!dept || dept === 'null' || dept === 'undefined') {
    alert('登入資訊不完整,請重新登入');
    localStorage.clear();
    location.href = 'index.html';
  }

  document.getElementById('deptBadge').textContent = dept || '';

  let headersRaw = [];
  let rowRaw = [];
  let editableCols = [];
  let tableInputs = new Map();

  const PASS = '及格';
  const FAIL = '不及格';
  const GET  = '獲證';

const GUARD_MSG = '本欄由系統自動判斷，您無須填寫';

// 全域守門（只綁一次）
if (!window.__guardInited) {
  window.__guardInited = true;

  // 用捕獲階段攔截「滑鼠按下」→ 阻止聚焦並提示
  document.addEventListener('mousedown', (ev) => {
    const inp = ev.target.closest('input[data-guard="1"]');
    if (inp) {
      ev.preventDefault();               // 阻止這次點擊導致的 focus
      alert(GUARD_MSG);                  // 提示一次
      // 不做 blur，因為根本沒有拿到焦點（preventDefault 已阻止）
    }
  }, true);

  // 鍵盤 Tab 進來的情況：不彈框，只是立即移開焦點，避免卡住
  document.addEventListener('focusin', (ev) => {
    const inp = ev.target.closest('input[data-guard="1"]');
    if (inp) {
      setTimeout(() => inp.blur(), 0);
    }
  });
}


  function detectGroups(headers) {
    const groups = [];
    for (let i = 0; i < headers.length; i++) {
      const name = String(headers[i] || '').trim();
      if (/-學$/.test(name)) {
        const base = name.replace(/-學$/, '');
        let idx2 = headers.findIndex((h, j) => j>i && String(h).trim() === (base + '-術'));
        let idx3 = headers.findIndex((h, j) => j>Math.max(i, idx2) && (
          String(h).trim() === (base + '-丙') ||
          String(h).trim() === (base + '-乙') ||
          /技工$/.test(String(h).trim()) ||
          String(h).trim().replace(/[-乙丙]$/,'') === base
        ));
        let idx4 = headers.findIndex((h, j) => j>Math.max(i, idx2, idx3) && String(h).trim() === '獲證字號');

        if (idx2> -1 && idx3> -1 && idx4> -1) {
          groups.push({ base, c1: i+1, c2: idx2+1, c3: idx3+1, c4: idx4+1 });
        }
      }
    }
    return groups;
  }

function renderTable() {
  const root = document.getElementById('root');
  tableInputs.clear();
  const table = document.createElement('table'); 
  const tbody = document.createElement('tbody');

  // 固定四欄
  const fixed = ['班級','座號','學號','姓名'];
  fixed.forEach((name) => {
    const col = headersRaw.findIndex(h => String(h).trim() === name) + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `<th>${name}</th><td>${col? String(rowRaw[col-1] ?? '') : ''}</td>`;
    tbody.appendChild(tr);
  });

  // 既有群組（-學 / -術 / 乙丙 / 獲證字號）
  const groups = detectGroups(headersRaw);
  const groupedCols = new Set();
  groups.forEach(g => { groupedCols.add(g.c1); groupedCols.add(g.c2); groupedCols.add(g.c3); groupedCols.add(g.c4); });

  groups.forEach((g) => {
    tbody.appendChild(makeSelectRow(`${g.base}-學`, g.c1));
    tbody.appendChild(makeSelectRow(`${g.base}-術`, g.c2));
    tbody.appendChild(makeReadonlyRow(findHeader(g.c3), g.c3));       // 乙/丙 自動
    tbody.appendChild(makeTextRow('獲證字號', g.c4, true));
  });

// 其餘可編輯欄位：依最後一字決定元件型態
for (let c = 1; c <= headersRaw.length; c++) {
  const name = String(headersRaw[c-1] || '').trim();
  if (fixed.includes(name)) continue;
  if (groupedCols.has(c)) continue;
  if (!editableCols.includes(c)) continue;

  const lastChar = name.slice(-1);
  if (lastChar === '科') {
    // 尾字「科」→ 下拉（及格／不及格）
    tbody.appendChild(makeSelectRow(name, c));
  } else if (lastChar === '乙' || lastChar === '丙') {
    // 尾字「乙／丙」→ 自動欄（唯讀），交由 applyRulesAndCounters 決定是否「獲證」
    tbody.appendChild(makeReadonlyRow(name, c));
  } else if (lastChar === '號') {
    // ★ 尾字「號」→ 視為「獲證字號」欄，啟用上傳彈窗邏輯
    tbody.appendChild(makeTextRow(name, c, /*isCertNo=*/true));
  } else {
    tbody.appendChild(makeTextRow(name, c, /*isCertNo=*/false));
  }
}


  // 獲證張數（若存在）
  const countCol = headersRaw.findIndex(h => String(h).trim() === '獲證張數') + 1;
  if (countCol) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<th>獲證張數</th><td><input type="text" data-col="${countCol}" readonly /></td>`;
    tbody.appendChild(tr);
    tableInputs.set(countCol, tr.querySelector('input'));
  }

  table.appendChild(tbody);
  root.innerHTML = ''; 
  root.appendChild(table);

  applyRulesAndCounters(detectGroups(headersRaw)); // 初次套用規則
}
  
// 往前尋找最近的「乙／丙」欄名作為證照名稱；若找不到就回傳當前欄名
function findNearbyCertName(col) {
  for (let c = col; c >= 1; c--) {
    const h = String(headersRaw[c-1] || '');
    const last = h.slice(-1);
    if (last === '乙' || last === '丙') return h;
  }
  return String(headersRaw[col-1] || '證照');
}

  function findHeader(col){ return String(headersRaw[col-1] || '').trim(); }

  function makeSelectRow(label, col) {
    const tr = document.createElement('tr');
    const v = rowRaw[col-1] ?? '';
    tr.innerHTML = `<th>${label}</th>
      <td><select data-col="${col}">
        <option value=""></option>
        <option value="${PASS}">${PASS}</option>
        <option value="${FAIL}">${FAIL}</option>
      </select></td>`;
    const sel = tr.querySelector('select');
    sel.value = v;
    sel.addEventListener('change', onAnyInputChanged);
    tableInputs.set(col, sel);
    return tr;
  }

function makeReadonlyRow(label, col) {
  const tr = document.createElement('tr');
  const v = rowRaw[col-1] ?? '';
  tr.innerHTML = `<th>${label}</th>
    <td><input type="text" data-col="${col}" value="${String(v)}" readonly style="background:#f0f0f0;cursor:not-allowed" /></td>`;
  const inp = tr.querySelector('input');
  tableInputs.set(col, inp);
  return tr;
}

function makeTextRow(label, col, isCertNo) {
  const tr = document.createElement('tr');
  const v = rowRaw[col-1] ?? '';
  tr.innerHTML = `<th>${label}</th>
    <td>
      <input type="text" data-col="${col}" data-key="${label}" value="${String(v)}" />
      <span class="link-badge" style="margin-left:6px;color:#16a34a;font-weight:600;display:none">v</span>
    </td>`;
  const inp = tr.querySelector('input');
  const badge = tr.querySelector('.link-badge');

  // ★ 若此欄是「獲證字號」且後端告訴我們這欄有連結 → 顯示 v
  if (label === '獲證字號' && Array.isArray(window.__linkCols) && window.__linkCols.includes(col)) {
    badge.style.display = 'inline';
  }

  // 一般文字輸入：維持原本規則
  inp.addEventListener('input', onAnyInputChanged);

  // ★ 若是「獲證字號」類型的欄位：在 focus 時攔截，先走上傳彈窗
  if (isCertNo) {
    inp.addEventListener('focus', () => {
      // 前一欄是否為「獲證」？
      const prevEl = tableInputs.get(col - 1);
      const prevVal = (prevEl?.value || '').trim();
      const curVal  = (inp.value || '').trim();
      if (prevVal === GET && !curVal) {
        // 證照名稱：往前找最近的「乙／丙」欄，找不到就用當前欄名
        const certName = findNearbyCertName(col) || label;
        openCertModal(col, certName);
        setTimeout(() => inp.blur(), 0); // 關掉鍵盤／游標，避免使用者直接輸入
      }
    });
  }

  tableInputs.set(col, inp);
  return tr;
}

  function onAnyInputChanged() {
    const groups = detectGroups(headersRaw);
    applyRulesAndCounters(groups);
  }

function applyRulesAndCounters(groups) {
  let total = 0;
  const PASS = '及格';
  const FAIL = '不及格';
  const GET  = '獲證';

  // 處理既有群組（-學 / -術 → 乙/丙）
  groups.forEach(g => {
    const s1 = (tableInputs.get(g.c1)?.value || '').trim();
    const s2 = (tableInputs.get(g.c2)?.value || '').trim();
    const s3El = tableInputs.get(g.c3);
    const s4El = tableInputs.get(g.c4);

const isPass = (s1 === PASS && s2 === PASS);
const incomplete = (!s1 || !s2 || s1 === FAIL || s2 === FAIL);

if (s3El) {
  s3El.readOnly = true;
  s3El.style.background = '#f0f0f0';

  const prevVal = s3El.value;                 // ★ 新增：記錄自動前的值
  s3El.value = isPass ? GET : '';

  // ★ 若剛剛才自動變成「獲證」，立刻觸發原本的證號開窗流程
  if (s3El.value === GET && prevVal !== GET && s4El) {
    triggerUploadCertFlow(s4El);
  }

  if (incomplete) s3El.setAttribute('data-guard', '1');
  else s3El.removeAttribute('data-guard');
}

if (s4El) {
  if (isPass) {
    s4El.removeAttribute('readonly');
    s4El.required = true;
    s4El.style.background = '#fff';
  } else {
    s4El.value = '';
    s4El.setAttribute('readonly', 'readonly');
    s4El.required = false;
    s4El.style.background = '#f0f0f0';
  }
}
    if (isPass) total++;
  });

  // ★ 一般版：凡是「乙／丙」欄（不在 groups 內的）
  for (let idx0 = 0; idx0 < headersRaw.length; idx0++) {
    const name = String(headersRaw[idx0] || '').trim();
    const last = name.slice(-1);
    const col = idx0 + 1;
    const handledInGroups = groups.some(g => g.c3 === col);
    if (handledInGroups) continue;

    if (last === '乙' || last === '丙') {
      const c1 = col - 2, c2 = col - 1;
      const el1 = tableInputs.get(c1);
      const el2 = tableInputs.get(c2);
      const target = tableInputs.get(col);
      if (!target) continue;

const v1 = (el1?.value || '').trim();
const v2 = (el2?.value || '').trim();
const isPass = (v1 === PASS && v2 === PASS);
const incomplete = (!v1 || !v2 || v1 === FAIL || v2 === FAIL);

target.readOnly = true;
target.style.background = '#f0f0f0';

const prevVal = target.value;                 // ★ 新增：記錄自動前的值
target.value = isPass ? GET : '';

// ★ 剛變成「獲證」→ 找到對應的「獲證字號」欄位，直接觸發原流程
if (target.value === GET && prevVal !== GET) {
  const certInput = findCertNumberInputFor(col);
  if (certInput) triggerUploadCertFlow(certInput);
}

if (incomplete) target.setAttribute('data-guard', '1');
else target.removeAttribute('data-guard');

if (target.value === GET) total++;
    }
  }

  // 總張數
  const countCol = headersRaw.findIndex(h => String(h).trim() === '獲證張數') + 1;
  if (countCol && tableInputs.get(countCol)) {
    tableInputs.get(countCol).value = String(total);
  }
}


  async function loadProfile() {
    showBusy(true);
    try {
      // 確保傳遞 dept 參數
      const res = await apiGet('profile', { token, dept, designSub, debug: '1' });
      
      if (!res.ok) {
        throw new Error(res.error || '讀取失敗');
      }

      headersRaw = res.headersRaw || [];
      rowRaw = res.rowRaw || [];
      editableCols = res.editableCols || [];
      // ★ 接住後端回傳的「本列有連結的獲證字號欄」(1-based)
      window.__linkCols = Array.isArray(res.linkCols) ? res.linkCols : [];

      if (!headersRaw.length || !rowRaw.length) {
        throw new Error('資料異常:找不到表頭或資料列');
      }
      
      renderTable();
      
      // 顯示除錯資訊(如果有)
      if (res.debugTimings) {
        console.log('載入時間分析:', res.debugTimings);
      }
    } catch (err) {
      const root = document.getElementById('root');
      root.innerHTML = `<div class="error">
        <strong>載入失敗:</strong> ${err.message}<br>
        <button onclick="location.href='index.html'" style="margin-top:8px">返回登入頁</button>
      </div>`;
      throw err;
    }finally {
    showBusy(false);
  }
  }

  document.getElementById('btnSubmit').addEventListener('click', async () => {
    showBusy(true);
    try {
      const groups = detectGroups(headersRaw);
      for (const g of groups) {
        const s3 = (tableInputs.get(g.c3)?.value || '').trim();
        if (s3 === GET) {
          const s4 = (tableInputs.get(g.c4)?.value || '').trim();
          if (!s4) { 
            alert(`【${findHeader(g.c4)}】未填寫(${findHeader(g.c3)}=「${GET}」時必填)`); 
            return; 
          }
        }
      }

      const updatesByCol = [];
      for (const [col, el] of tableInputs.entries()) {
        const oldVal = rowRaw[col-1] ?? '';
        const newVal = (el.value ?? '').toString();
        if (String(oldVal) !== String(newVal)) {
          updatesByCol.push({ col, value: newVal });
        }
      }
      
      if (!updatesByCol.length) { 
        alert('沒有變更'); 
        return; 
      }

// 組 payload
const payload = {
  token,
  dept,
  designSub,
  updatesByCol: JSON.stringify(updatesByCol)
};
// 若有上傳過圖片，會被彈窗程式記在 window.__linkByCol
if (window.__linkByCol && window.__linkByCol.length) {
  payload.linkByCol = JSON.stringify(window.__linkByCol);
}

// 呼叫後端
const res = await apiPost('profile.update', payload);

// （可選）成功後清掉暫存，避免下次誤送
if (res.ok) {
  window.__linkByCol = [];
}

      
      if (!res.ok) throw new Error(res.error || '送出失敗');
if (res.sheetName) localStorage.setItem('sheetName', res.sheetName);
if (res.designSub) localStorage.setItem('designSub', res.designSub);
alert('儲存完畢');
location.href = 'index.html';
    } catch (err) {
      alert(err.message);
    }finally {
    showBusy(false);
  }
  });

  document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.clear(); 
    location.href = 'index.html';
  });

  loadProfile().catch(err => {
    console.error('loadProfile error:', err);
  });
    function showBusy(on) {
    const m = document.getElementById('busyMask');
    if (!m) return;
    m.style.display = on ? 'flex' : 'none';
  }
  // 讓系統幫使用者「點」證號欄位，觸發原本的開窗流程
function triggerUploadCertFlow(certInput) {
  if (!certInput) return;
  // 確保在本輪 DOM/值更新後再觸發，避免 race
  requestAnimationFrame(() => {
    try {
      // 若你已把開窗流程封裝成函式（例如 openCertDialogForInput）
      // 可直接呼叫：openCertDialogForInput(certInput);
      // 否則就模擬滑鼠點擊，走原本 click-handler 的路徑
      certInput.focus();
      certInput.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
      certInput.dispatchEvent(new MouseEvent('click', {bubbles:true}));
    } catch (e) { console && console.warn('triggerUploadCertFlow failed:', e); }
  });
}

// 根據「乙/丙欄位的 col」去找對應的「獲證字號」欄位 input（一般版用）
function findCertNumberInputFor(col) {
  // 先嘗試「下一欄就是獲證字號」的常見情況
  const maybeNext = tableInputs.get(col + 1);
  const nextHeader = String(headersRaw[col] || '').trim(); // col+1 對應 headersRaw[col]
  const isCertHeader = /字號$/.test(nextHeader) || nextHeader.includes('獲證字號');
  if (maybeNext && isCertHeader) return maybeNext;

  // 再嘗試直接用欄名搜尋（萬一不是隔壁）
  for (let i = 0; i < headersRaw.length; i++) {
    const name = String(headersRaw[i] || '').trim();
    if (/字號$/.test(name) || name.includes('獲證字號')) {
      const input = tableInputs.get(i + 1);
      if (input) return input;
    }
  }
  return null;
}

</script>

</body>
</html>
