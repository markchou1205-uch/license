<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" href="data:,">
<title>學生資料 | 職業證照登管系統</title>
<style>
  :root{
    --bg1:#fff7ed; --card:#fffaf0; --line:#e6d3b8;
    --text:#3b2f2f; --muted:#8b6b5e; --accent:#f59e0b;
    --btnBg:#f3f4f6; --btnBorder:#cbd5e1; --btnHover:#e5e7eb;
    --btnPriBg:#f59e0b; --btnPriText:#fff; --btnPriBorder:#d97706;
    --error:#b91c1c; --ok:#16a34a; --shadow:0 10px 30px rgba(217,119,6,.12);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),#fff);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC"}
  .wrap{width:95%;margin:22px auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  h1{margin:0 0 6px} .sub{margin:0 0 10px;color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  /* table */
  .table-wrap{width:95%;overflow:auto;margin-top:10px}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid var(--line);padding:8px 8px;text-align:left;font-size:14px;vertical-align:middle;white-space:nowrap}
  th{font-weight:600;color:#6b4f43;background:#fff8ea}
  .ro{background:#f7f3ea}
  /* controls / buttons */
  select,input[type="text"]{min-width:120px;padding:6px 8px;border:1px solid var(--btnBorder);border-radius:6px;background:#fff;outline:none;appearance:auto}
  select:focus,input[type="text"]:focus{border-color:#94a3b8;box-shadow:0 0 0 2px rgba(148,163,184,.25)}
  .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:1px solid var(--btnBorder);background:var(--btnBg);color:var(--text);cursor:pointer}
  .btn:hover{background:var(--btnHover)}
  .btn.primary{background:var(--btnPriBg); border-color:var(--btnPriBorder); color:var(--btnPriText)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .okMark{display:inline-block;margin-left:6px;color:var(--ok);font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  /* Spinner & Progress */
  #busy{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:9999}
  .spinner{width:48px;height:48px;border:5px solid #fff;border-top-color:#f59e0b;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
#uploadProgress{
  position:fixed; inset:0;
  display:none; z-index:2147483646;
  background:rgba(0,0,0,.45);
  align-items:center; justify-content:center;
}
#uploadProgress .barWrap{
  width:min(560px,90vw);
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  box-shadow:var(--shadow);
  overflow:hidden;
  padding:14px;
}
#uploadProgress .bar{
  height:12px; width:0%;
  background:linear-gradient(90deg,#f59e0b,#fde68a);
  border-radius:6px;
  transition:width .2s ease;
}
#uploadProgress .meta{
  padding:8px 2px 0; font-size:14px; color:var(--text); text-align:center;
}

  /* Modal */
  #certModal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10001}
  .modalCard{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:14px;max-width:480px;width:92%}
  .row{display:grid;grid-template-columns:1fr;gap:8px}
  .modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>學生資料</h1>
    <p class="sub" id="sub"></p>
    <div class="actions">
      <button class="btn primary" id="btnSubmit" disabled>確認送出</button>
      <a class="btn" href="index.html">返回登入</a>
      <span class="small" id="err"></span>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="busy"><div class="spinner"></div></div>
<div id="uploadProgress"><div class="barWrap"><div class="bar" id="progBar"></div><div class="meta" id="progMeta">準備上傳…</div></div></div>
<div id="certModal">
  <div class="modalCard">
    <h3 id="cmTitle" style="margin:0 0 6px">證號與截圖</h3>
    <div class="row">
      <label>證號 <input id="cmNo" type="text" autocomplete="off"/></label>
      <label>上傳截圖（學生必須附檔） <input id="cmFile" type="file" accept="image/*"/></label>
    </div>
    <div class="modalActions">
      <button class="btn" id="cmCancel">取消</button>
      <button class="btn primary" id="cmOk">確認</button>
    </div>
  </div>
</div>
<!-- === 影像對齊裁切視窗（九宮格置中裁切） === -->
<style>
  #cropperOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2147483647;display:none;align-items:center;justify-content:center}
  #cropperBox{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:12px;max-width:92vw}
  #cropperTitle{font-size:16px;margin:4px 0 8px}
  #cropperCanvasWrap{position:relative;width:720px;height:480px;max-width:92vw;max-height:70vh;background:#111;overflow:hidden;border-radius:8px}
  #cropperCanvas{display:block;width:100%;height:100%}
  /* 九宮格覆蓋（白線，置中顯示） */
  #gridOverlay{pointer-events:none;position:absolute;inset:0}
  #gridOverlay svg{width:100%;height:100%}
  #gridOverlay line{stroke:#ffffff;stroke-opacity:.6;stroke-width:1}
    /* 中央紅色虛線框（置頂顯示、不隨縮放變細） */
  #gridOverlay .centerBox{
    fill: none;
    stroke: red;
    stroke-width: 0.06;         /* 以 viewBox 座標為單位 */
    stroke-dasharray: 0.12 0.12;
    vector-effect: non-scaling-stroke;
    shape-rendering: crispEdges;
  }

  /* 中央可視區以外加上暗角（僅視覺效果） */
  #maskOverlay{pointer-events:none;position:absolute;inset:0}
  #cropperOps{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:10px}
  #cropperOps .left{display:flex;gap:8px;align-items:center}
  #cropperOps .right{display:flex;gap:8px}
  .cropBtn{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
  .cropBtn.primary{border-color:#2563eb;background:#2563eb;color:#fff}
  .hint{color:#6b7280;font-size:13px}
</style>

<div id="cropperOverlay" role="dialog" aria-modal="true">
  <div id="cropperBox">
    <div id="cropperTitle">對齊圖片到中央格，然後按「使用這張」。</div>
    <div id="cropperCanvasWrap">
      <canvas id="cropperCanvas" width="1080" height="720"></canvas>
      <div id="gridOverlay">
<svg viewBox="0 0 3 3" preserveAspectRatio="none">
  <!-- 垂直線 -->
  <line x1="1" y1="0" x2="1" y2="3"></line>
  <line x1="2" y1="0" x2="2" y2="3"></line>
  <!-- 水平線 -->
  <line x1="0" y1="1" x2="3" y2="1"></line>
  <line x1="0" y1="2" x2="3" y2="2"></line>

  <!-- 中央格紅色虛線框 -->
  <rect class="centerBox" x="1" y="1" width="1" height="1"/>
</svg>
      </div>
    </div>
    <div id="cropperOps">
      <div class="left">
        <button id="zoomOut" class="cropBtn" title="縮小">－</button>
        <button id="zoomIn" class="cropBtn" title="放大">＋</button>
        <span class="hint">拖曳移動；滑鼠滾輪縮放；中央九宮格為保留區</span>
      </div>
      <div class="right">
        <button id="cropCancel" class="cropBtn">取消</button>
        <button id="cropUse" class="cropBtn primary">使用這張</button>
      </div>
    </div>
  </div>
</div>

<script>
const GAS_BASE = '/api/gas';
const stuRow = JSON.parse(sessionStorage.getItem('studentRow')||'null'); // [dept, clazz, sid, name, seat, nid]

const sub = document.getElementById('sub');
const errEl = document.getElementById('err');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const btnSubmit = document.getElementById('btnSubmit');
const BASE_COLS = 5; // 學生頁基礎欄位數（不含身分證號）

const busy = document.getElementById('busy');
const upWrap = document.getElementById('uploadProgress');
const progBar = document.getElementById('progBar');
const progMeta = document.getElementById('progMeta');

function showBusy(on){ busy.style.display = on ? 'flex' : 'none'; }
function showProgress(on){ upWrap.style.display = on ? 'flex' : 'none'; }
function setProgress(p, txt){ progBar.style.width = (p|0)+'%'; if (txt) progMeta.textContent = txt; }

if(!stuRow){ sub.textContent='無資料，請由登入頁進入。'; }

let headersMeta = []; // [{title,kind,group,colIndex}]
let rowData = null;   // {rowIndex, base, tail}
let originalTail = [];
const dirtySet = new Set();
const pendingCertOps = []; // 暫存多張證照的寫入/上傳作業

  
function syncDirty(rowIndex, colIndex, newDisplay){
  const idx = headersMeta.findIndex(h=>h.colIndex===colIndex);
  const orig = originalTail[idx] || '';
  const key = `${rowIndex}-${colIndex}`;
  if ((newDisplay||'') === orig){
    dirtySet.delete(key);
  }else{
    dirtySet.add(key);
  }
  btnSubmit.disabled = dirtySet.size===0;
}
  
async function loadStudent(){
  showBusy(true);
  try{
    const body = new URLSearchParams({ path:'student_row', sid: stuRow[2] }).toString();
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'load failed');

    headersMeta = data.headersMeta||[];
    rowData = data.row;
    originalTail = (rowData.tail||[]).map(c => (c?.display||''));
    renderTable();
  }catch(e){ errEl.textContent=e.message; }
  finally{ showBusy(false); }
}

function setDirty(rowIndex, colIndex){
  dirtySet.add(`${rowIndex}-${colIndex}`);
  btnSubmit.disabled = dirtySet.size===0;
}
function clearDirty(){ dirtySet.clear(); btnSubmit.disabled = true; }

async function loadClass(){
  try{
    showBusy(true);
    const body = new URLSearchParams({ path:'class_rows', dept:stuRow[0], clazz:stuRow[1] }).toString();
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'load failed');

    headersMeta = data.headersMeta||[];
    rowData = (data.rows||[]).find(x=> (x.base?.[2]||'')===stuRow[2]) || null;
    if (!rowData) throw new Error('找不到該學生的資料列');
    renderTable();
  }catch(e){ errEl.textContent = e.message; }
  finally{ showBusy(false); }
}

function th(t){ const x=document.createElement('th'); x.textContent=t; return x; }
function td(){ return document.createElement('td'); }

function renderTable() {
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // 表頭
  ['科別名稱', '班級名稱', '學號', '姓名', '座號'].forEach(t => thead.appendChild(th(t)));
  headersMeta.forEach(h => thead.appendChild(th(h.title)));

  // 單列資料
  const tr = document.createElement('tr');
  rowData.base.slice(0, BASE_COLS).forEach(v => {
    const c = td();
    c.textContent = v || '';
    tr.appendChild(c);
  });

  // 動態欄位
  headersMeta.forEach((h, idx) => {
    const cell = rowData.tail[idx] || { display: '', hasLink: false };
    const c = td();

    // ===== S1 / S2 =====
    if (h.kind === 'S1' || h.kind === 'S2') {
      const sel = document.createElement('select');
      ['及格', '不及格', ''].forEach(op => {
        const o = document.createElement('option');
        o.value = op;
        o.textContent = op || '（空白）';
        sel.appendChild(o);
      });
      sel.value = cell.display || '';
      sel.addEventListener('change', () => {
        cell.display = sel.value;
        syncDirty(rowData.rowIndex, h.colIndex, sel.value);
        updateS3AndMaybePrompt(h.group);
      });
      c.appendChild(sel);
      // 註冊到 groupSelects，供 S4 鎖定/解鎖用
      (groupSelects[h.group] ||= {})[h.kind] = sel;
    }

    // ===== S3 =====
    else if (h.kind === 'S3') {
      c.classList.add('ro');
      const span = document.createElement('span');
      span.textContent = computeS3ByGroup(h.group);
      c.appendChild(span);
    }

    // ===== S4 =====
    else if (h.kind === 'S4') {
      c.classList.add('ro');
      const certNo = (cell.display || '').trim();

      // 顯示證號
      const txt = document.createElement('span');
      txt.textContent = certNo;
      c.appendChild(txt);

      // 若有影像連結：顯示 ✓
      if (cell.hasLink) {
        const ok = document.createElement('span');
        ok.className = 'okMark';
        ok.textContent = '✓';
        c.appendChild(ok);
      }

      // 若已有證號 → 鎖定同組 S1/S2
      if (certNo) {
        const gs = groupSelects[h.group];
        if (gs) {
          ['S1','S2'].forEach(k=>{
            const sel = gs[k];
            if (sel) { sel.disabled = true; sel.style.backgroundColor = '#eee'; }
          });
        }
      }

      // 只有已有證號時才顯示「修正/傳圖」與「刪除獲證記錄」
      if (certNo) {
        // 修正/傳圖
        const btn = document.createElement('button');
        btn.className = 'btn small';
        btn.textContent = '修正/傳圖';
        btn.addEventListener('click', () => openCertModal({
          headerTitle: h.title,
          currentNo: certNo,
          requireImage: false,
          mode: 'edit',
          group: h.group
        }));
        c.appendChild(document.createTextNode(' '));
        c.appendChild(btn);

        // 刪除獲證記錄
        const delBtn = document.createElement('button');
        delBtn.className = 'btn small danger';
        delBtn.textContent = '刪除獲證記錄';
        delBtn.addEventListener('click', async ()=>{
          if (!confirm('將刪除此張證照的記錄及截圖。要繼續嗎？')) return;
          showProgress(true); setProgress(10,'連線伺服器中…');
          try{
            const r = await postForm({
              path: 'revoke_cert',
              dept: stuRow[0], clazz: stuRow[1], sid: stuRow[2],
              headerTitle: h.title, clearImage: 1
            });
            if (!r.ok) throw new Error(r.error || 'revoke failed');

            // 前端同步：S1/S2/S3/S4 清空（畫面＆rowData）
            const s1Idx = headersMeta.findIndex(x=>x.group===h.group && x.kind==='S1');
            const s2Idx = headersMeta.findIndex(x=>x.group===h.group && x.kind==='S2');
            const s3Idx = headersMeta.findIndex(x=>x.group===h.group && x.kind==='S3');

            [s1Idx, s2Idx].forEach(ix=>{
              if (ix>=0) {
                (rowData.tail[ix] ||= {}).display = '';
                const tdc = tbody.querySelectorAll('tr')[0].children[BASE_COLS + ix];
                const sel = tdc.querySelector('select');
                if (sel) { sel.value = ''; sel.disabled = false; sel.style.backgroundColor=''; }
                setDirty(rowData.rowIndex, headersMeta[ix].colIndex);
              }
            });
            if (s3Idx>=0) {
              (rowData.tail[s3Idx] ||= {}).display = '';
              const tdS3 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s3Idx];
              tdS3.textContent = '';
              setDirty(rowData.rowIndex, headersMeta[s3Idx].colIndex);
            }

            updateS4CellUI(h.title, '', false, h.group); // 清掉 S4（前端顯示為空 / 解鎖 S1/S2）

            setProgress(100,'完成');
            showProgress(false);
          }catch(err){
            showProgress(false);
            alert(err.message || '刪除失敗');
          }
        });
        c.appendChild(document.createTextNode(' '));
        c.appendChild(delBtn);
      }
    }

    // ===== 其他一般欄位 =====
    else {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = cell.display || '';
      input.addEventListener('change', () => {
        cell.display = input.value.trim();
        setDirty(rowData.rowIndex, h.colIndex);
      });
      c.appendChild(input);
    }

    tr.appendChild(c);
  });

  tbody.appendChild(tr);
}



/* -------- 同組 S3 判斷＆更新（學生） -------- */
function computeS3ByGroup(group){
  const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
  const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
  const v1 = s1Idx>=0 ? (rowData.tail[s1Idx]?.display||'').trim() : '';
  const v2 = s2Idx>=0 ? (rowData.tail[s2Idx]?.display||'').trim() : '';
  return (v1==='及格' && v2==='及格') ? '獲證' : '';
}

function updateS3AndMaybePrompt(group){
  const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
  if (s3Idx<0) return;
  const oldVal = (rowData.tail[s3Idx]?.display||'');
  const newVal = computeS3ByGroup(group);
  rowData.tail[s3Idx] = rowData.tail[s3Idx] || {};
  rowData.tail[s3Idx].display = newVal;
  // 更新畫面
  const tdS3 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s3Idx];
  tdS3.textContent = newVal;

  // 只有「空白 ➜ 獲證」這次變化才彈窗
  if (oldVal !== '獲證' && newVal === '獲證'){
    const s4Hdr = headersMeta.find(h=>h.group===group && h.kind==='S4');
    if (s4Hdr) openCertModal({ headerTitle: s4Hdr.title, currentNo:'', requireImage:true, mode:'new', group });
  }
}

/* -------- 對話框（學生：新獲證必須上傳） -------- */
const certModal = document.getElementById('certModal');
const cmTitle = document.getElementById('cmTitle');
const cmNo = document.getElementById('cmNo');
const cmFile = document.getElementById('cmFile');
const cmCancel = document.getElementById('cmCancel');
const cmOk = document.getElementById('cmOk');
let cmCtx=null;
// 記住每個 group 的學科/術科 <select>
const groupSelects = {};  // { [group]: { S1:HTMLSelectElement, S2:HTMLSelectElement } }
// 讓 <input type="file" id="cmFile"> 選檔後，先進九宮格裁切，再把裁切結果暫存在 cmCtx 中
// ※ 不會立刻上傳；只是把裁切好的圖片暫存給 cmOk.onclick 使用
document.getElementById('cmFile').addEventListener('change', async () => {
  const f = cmFile.files && cmFile.files[0];
  if (!f) return;
  const cropped = await openCropperForFile(f); // 開啟九宮格裁切
  if (!cropped) {
    // 使用者取消裁切
    cmFile.value = '';
    if (cmCtx) delete cmCtx.croppedDataURL;
    return;
  }
  // 暫存裁切結果（dataURL）；稍後按「確認」才真正上傳
  if (!cmCtx) cmCtx = {};
  cmCtx.croppedDataURL = cropped;

  // 視覺提示（你也可改成把預覽圖塞到 modal 裡）
  // 這裡用改變 label 文字的方式提示已完成裁切
  const fileLabel = document.querySelector('label[for="cmFile"]') || document.getElementById('cmFile')?.parentElement;
  if (fileLabel) fileLabel.innerHTML = '上傳截圖（學生必須附檔） <input id="cmFile" type="file" accept="image/*"/>（已完成對齊與裁切）';
});

function openCertModal(ctx){
  cmCtx = ctx; cmTitle.textContent=`證號與截圖：${ctx.headerTitle}`;
  cmNo.value=ctx.currentNo||''; 
  cmFile.value=''; 
  // ===== 在「修改」模式下，顯示 S1/S2 下拉在證號欄位上方 =====
let sWrap = document.getElementById('cmSWrap');
if (!sWrap) {
  sWrap = document.createElement('div');
  sWrap.id = 'cmSWrap';
  sWrap.style.display = 'grid';
  sWrap.style.gridTemplateColumns = '1fr 1fr';
  sWrap.style.gap = '8px';
  // 插到「證號輸入列」的上方（cmNo 的外層 label 上方）
  const noRow = cmNo.closest('label') || cmNo.parentElement;
  noRow.parentElement.insertBefore(sWrap, noRow);
  
}
// 兩種模式都顯示 S1/S2；預設皆為「及格」，若表格已有值則帶入
sWrap.innerHTML = `
  <label>學科 (S1)
    <select id="cmS1">
      <option value="及格">及格</option>
      <option value="不及格">不及格</option>
    </select>
  </label>
  <label>術科 (S2)
    <select id="cmS2">
      <option value="及格">及格</option>
      <option value="不及格">不及格</option>
    </select>
  </label>
`;
sWrap.style.display = 'grid';
sWrap.style.gridTemplateColumns = '1fr';
sWrap.style.gap = '8px';

// 依目前表格值帶入（若無則維持及格）
const s1IdxCur = headersMeta.findIndex(h=>h.group===ctx.group && h.kind==='S1');
const s2IdxCur = headersMeta.findIndex(h=>h.group===ctx.group && h.kind==='S2');
const cmS1 = document.getElementById('cmS1');
const cmS2 = document.getElementById('cmS2');
cmS1.value = (s1IdxCur>=0 ? (rowData.tail[s1IdxCur]?.display||'') : '') || '及格';
cmS2.value = (s2IdxCur>=0 ? (rowData.tail[s2IdxCur]?.display||'') : '') || '及格';

// 若任一改「不及格」→ 鎖證號與上傳
const blockIfFail = ()=>{
  const blocked = (cmS1.value === '不及格' || cmS2.value === '不及格');
  cmNo.disabled = blocked;
  cmNo.style.backgroundColor = blocked ? '#eee' : '';
  cmFile.disabled = blocked;
  const fileLabel = document.querySelector('label[for="cmFile"]') || cmFile?.parentElement;
  if (fileLabel) fileLabel.style.opacity = blocked ? .5 : 1;
};
cmS1.onchange = cmS2.onchange = blockIfFail;
blockIfFail();

// --- 建立「刪除獲證」按鈕（若不存在）並插入在「確認」按鈕左邊 ---
let cmDel = document.getElementById('cmDelete');
if (!cmDel) {
  cmDel = document.createElement('button');
  cmDel.id = 'cmDelete';
  cmDel.className = 'btn danger';
  cmDel.textContent = '刪除獲證';
  // 把它插在確認按鈕左邊
  const footer = cmOk.parentElement;
  footer.insertBefore(cmDel, cmOk);
}

// 點「刪除獲證」：清 s1/s2 的「及格」、清 s3 的「獲證」、清 s4（含超連結），並標記髒資料；關閉視窗。
cmDel.onclick = ()=>{
  if (!ctx) return;
  if (!confirm('將刪除目前此組的學科/術科/獲證與證號（含截圖連結）。您確定嗎？')) return;
  // 群組索引
  const g = ctx.group;
  const s1Idx = headersMeta.findIndex(h=>h.group===g && h.kind==='S1');
  const s2Idx = headersMeta.findIndex(h=>h.group===g && h.kind==='S2');
  const s3Idx = headersMeta.findIndex(h=>h.group===g && h.kind==='S3');
  const s4Idx = headersMeta.findIndex(h=>h.group===g && h.kind==='S4');

  // 清 S1/S2（畫面與資料）
  if (s1Idx>=0){
    rowData.tail[s1Idx] = rowData.tail[s1Idx]||{};
    rowData.tail[s1Idx].display = '';
    // 畫面 select
    const sel = tbody.querySelectorAll('tr')[0].children[BASE_COLS+s1Idx].querySelector('select');
    if (sel) sel.value = '';
    setDirty(rowData.rowIndex, headersMeta[s1Idx].colIndex);
  }
  if (s2Idx>=0){
    rowData.tail[s2Idx] = rowData.tail[s2Idx]||{};
    rowData.tail[s2Idx].display = '';
    const sel = tbody.querySelectorAll('tr')[0].children[BASE_COLS+s2Idx].querySelector('select');
    if (sel) sel.value = '';
    setDirty(rowData.rowIndex, headersMeta[s2Idx].colIndex);
  }

  // 清 S3（畫面與資料）
  if (s3Idx>=0){
    rowData.tail[s3Idx] = rowData.tail[s3Idx]||{};
    rowData.tail[s3Idx].display = '';
    const tdS3 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s3Idx];
    if (tdS3) tdS3.textContent = '';
    setDirty(rowData.rowIndex, headersMeta[s3Idx].colIndex);
  }

  // 清 S4（畫面與資料，含去掉超連結顯示）
  if (s4Idx>=0){
    rowData.tail[s4Idx] = rowData.tail[s4Idx]||{};
    rowData.tail[s4Idx].display = '';
    rowData.tail[s4Idx].hasLink = false;
    const tdS4 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s4Idx];
    if (tdS4){
      tdS4.innerHTML = ''; // 直接清空整格
    }
    setDirty(rowData.rowIndex, headersMeta[s4Idx].colIndex);
  }

  alert('已刪除本組的獲證欄位資料。請記得關閉視窗前點擊「確認送出」，才會寫入資料庫。');
  certModal.style.display = 'none';
};


  certModal.style.display='flex';
}
cmCancel.onclick = () => {
  certModal.style.display = 'none';
  if (cmCtx && cmCtx.mode === 'new') {
    // 清除本組 s1/s2 與 s3
    const group = cmCtx.group;
    const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
    const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
    const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
    if (s1Idx>=0){
      rowData.tail[s1Idx].display = '';
      const sel = tbody.querySelectorAll('tr')[0].children[BASE_COLS+s1Idx].querySelector('select');
      if (sel) sel.value = '';
      setDirty(rowData.rowIndex, headersMeta[s1Idx].colIndex);   // 加入變更追蹤
    }
    if (s2Idx>=0){
      rowData.tail[s2Idx].display = '';
      const sel = tbody.querySelectorAll('tr')[0].children[BASE_COLS+s2Idx].querySelector('select');
      if (sel) sel.value = '';
      setDirty(rowData.rowIndex, headersMeta[s2Idx].colIndex);
    }
    if (s3Idx>=0){
      rowData.tail[s3Idx].display = '';
      const tdS3 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s3Idx];
      tdS3.textContent = '';
    }
  }
  cmCtx = null;
};
// 把裁切後的 dataURL 轉成 Blob，方便用 FormData 上傳
async function dataURLtoBlob(dataURL){
  const res = await fetch(dataURL);
  return await res.blob();
}
cmOk.onclick = async ()=>{
  if (!cmCtx) return;
  // 二次確認
  if (!confirm('請再次確認您輸入的資料無誤，按「確認」繼續。')) return;

  const { headerTitle, requireImage, group } = cmCtx;
  const no = (cmNo.value||'').trim();
  const f  = cmFile.files[0] || null;
  if (!no) { alert('請輸入證號'); return; }
  // 你原本的格式檢查（若有）保留
  // if (...) { alert('格式錯誤'); return; }

  // 1) 推進暫存佇列（不上傳、不呼叫後端）
  const baseOp = {
    type: f ? 'upload' : 'write',
    dept: stuRow[0],
    clazz: stuRow[1],
    sid:   stuRow[2],
    name:  rowData.base[3] || '',
    headerTitle,
    certNo: no
  };
  if (f) {
    // 若你已做裁切且拿到 dataURL，可改存 dataURL；否則這裡轉 base64
    const buf = await f.arrayBuffer();
    const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    baseOp.fileBase64 = b64;
    baseOp.mime = f.type || 'image/png';
    baseOp.overwrite = '1';
  }
  pendingCertOps.push(baseOp);

  // 2) 立刻在前端畫面更新（但不觸發後端）——讓使用者看到已填好
  // 2-1 鎖定本組 S1/S2、補上 S3、S4 顯示證號與 ✓
  const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
  const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
  const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
  const s4Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S4');

  if (s1Idx>=0){
    rowData.tail[s1Idx] = rowData.tail[s1Idx] || {};
    rowData.tail[s1Idx].display = '及格';
    const tdc = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s1Idx];
    const sel = tdc.querySelector('select');
    if (sel){ sel.value='及格'; sel.disabled = true; sel.style.backgroundColor = '#eee'; }
    setDirty(rowData.rowIndex, headersMeta[s1Idx].colIndex);
  }
  if (s2Idx>=0){
    rowData.tail[s2Idx] = rowData.tail[s2Idx] || {};
    rowData.tail[s2Idx].display = '及格';
    const tdc = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s2Idx];
    const sel = tdc.querySelector('select');
    if (sel){ sel.value='及格'; sel.disabled = true; sel.style.backgroundColor = '#eee'; }
    setDirty(rowData.rowIndex, headersMeta[s2Idx].colIndex);
  }
  if (s3Idx>=0){
    rowData.tail[s3Idx] = rowData.tail[s3Idx] || {};
    rowData.tail[s3Idx].display = '獲證';
    const tdS3 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s3Idx];
    if (tdS3) tdS3.textContent = '獲證';
    setDirty(rowData.rowIndex, headersMeta[s3Idx].colIndex);
  }
  if (s4Idx>=0){
    rowData.tail[s4Idx] = rowData.tail[s4Idx] || {};
    rowData.tail[s4Idx].display = no;
    rowData.tail[s4Idx].hasLink = !!f; // 有檔案就先顯示 ✓，最後送出後端會真正建立連結
    const tdS4 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s4Idx];
    if (tdS4){
      tdS4.innerHTML = '';
      const txt = document.createElement('span'); txt.textContent = no; tdS4.appendChild(txt);
      if (f){
        const ok = document.createElement('span'); ok.className='okMark'; ok.textContent='✓'; tdS4.appendChild(ok);
      }
      // 追加「修正/傳圖」「刪除獲證」按鈕（如同既有 renderTable 的做法）
    }
    setDirty(rowData.rowIndex, headersMeta[s4Idx].colIndex);
  }

  // 3) 關閉對話框；提示「已加入待送清單」
  alert('已加入待送清單：按「確認送出」將一次寫入後端。');
  certModal.style.display = 'none';
  cmCtx = null;
};

function updateS4CellUI(headerTitle, certNo, hasLink, group){
  const idx = (group != null)
    ? headersMeta.findIndex(h => h.group === group && h.kind === 'S4')
    : headersMeta.findIndex(h => h.title === headerTitle && h.kind === 'S4');
  if (idx < 0) return;

  const cell = rowData.tail[idx] || (rowData.tail[idx] = {});
  cell.display = certNo;
  cell.hasLink = !!hasLink;

  const tdNode = tbody.querySelectorAll('tr')[0].children[BASE_COLS + idx];
  tdNode.innerHTML = '';

  // 證號
  const txt = document.createElement('span');
  txt.textContent = certNo;
  tdNode.appendChild(txt);

  // 影像連結提示
  if (hasLink) {
    const ok = document.createElement('span');
    ok.className = 'okMark';
    ok.textContent = '✓';
    tdNode.appendChild(ok);
  }
// 依據 certNo 鎖/解鎖同組 S1/S2
if (group != null) {
  const gs = groupSelects[group];
  if (gs) {
    const locked = !!certNo;
    ['S1','S2'].forEach(k=>{
      const sel = gs[k];
      if (sel) {
        sel.disabled = locked;
        sel.style.backgroundColor = locked ? '#eee' : '';
      }
    });
  }
}

// 只有已有證號時才顯示「修正/傳圖」
if (certNo) {
  const g = group ?? headersMeta[idx]?.group;
  const btn = document.createElement('button');
  btn.className = 'btn small';
  btn.textContent = '修正/傳圖';
  btn.addEventListener('click', () => openCertModal({
    headerTitle,
    currentNo: certNo,
    requireImage: false,
    mode: 'edit',
    group: g
  }));
  tdNode.appendChild(document.createTextNode(' '));
  tdNode.appendChild(btn);
}
  }


/* -------- 確認送出（只有變更才可點） -------- */
btnSubmit.onclick = async ()=>{
  if (dirtySet.size===0) return;
  try{
    showBusy(true);
        // 先把待送的「證照作業」批次送出（可大幅減少網路往返）
    if (pendingCertOps.length > 0){
      const r1 = await postForm({ path:'batch_cert', ops: JSON.stringify(pendingCertOps) });
      if (!r1.ok) throw new Error(r1.error || 'batch_cert failed');
      // 後端已實際寫入 S4 與 S1/S2/S3（apiWriteCert_/apiUploadCert_ 內含同步）
      // 清空佇列
      pendingCertOps.length = 0;
    }

    const updates=[];
    dirtySet.forEach(k=>{
      const [r,c]=k.split('-').map(n=>parseInt(n,10));
      const h = headersMeta.find(h=>h.colIndex===c);
      const idx = headersMeta.indexOf(h);
      const valueDisplay = (rowData.tail[idx]?.display)||'';
      updates.push({ rowIndex:r, colIndex:c, valueDisplay, headerTitle:h.title });
      
    });
        // [NEW] 送出前去重：同一格 (rowIndex,colIndex) 只保留最後一次
    const map = new Map();
    for (const u of updates) {
      map.set(`${u.rowIndex},${u.colIndex}`, u); // 後者覆蓋前者
    }
    const deduped = Array.from(map.values());
// [NEW-2] 排除：若此欄位是「已批次處理過的 group 的 S1~S4」，就不要再送
const batchGroups = new Set();
// 簡化規則：若某格 S4 目前有證號，就視為該 group 已處理過（避免重覆送）
headersMeta.filter(h=>h.kind==='S4').forEach(h=>{
  const idx = headersMeta.indexOf(h);
  const certNoNow = (rowData.tail[idx]?.display || '').trim();
  if (certNoNow) batchGroups.add(h.group);
});
let finalUpdates = deduped.filter(u=>{
  const h = headersMeta.find(x=>x.colIndex===u.colIndex);
  if (!h) return true;
  if ((h.kind==='S1'||h.kind==='S2'||h.kind==='S3'||h.kind==='S4') && batchGroups.has(h.group)) {
    return false; // 排除同組 S1~S4，避免和剛完成的 batch_cert 重覆
  }
  return true;
});

// 沒有其它一般欄位更新就略過 update_rows（證照相關已用 batch_cert 送過）
if (finalUpdates.length > 0) {
  const r2 = await postForm({ path:'update_rows', updates: JSON.stringify(finalUpdates) });
  if (!r2.ok) throw new Error(r2.error || 'update_rows failed');
}

clearDirty();
alert('已送出！批次證照與一般欄位更新完成。');

        // [NEW] 成功後依 S4 重新同步 S1/S2 的鎖定狀態（不用重整）
    headersMeta
      .filter(h => h.kind === 'S4')
      .forEach(h => {
        const idx = headersMeta.indexOf(h);
        const certNo = (rowData.tail[idx]?.display || '').trim();
        const hasLink = !!(rowData.tail[idx]?.hasLink);
        updateS4CellUI(h.title, certNo, hasLink, h.group);
      });

  }catch(e){ alert('送出失敗：'+e.message); }
  finally{ showBusy(false); }
};

/* -------- 工具 -------- */
async function postForm(obj){ const body=new URLSearchParams(obj).toString(); const r=await fetch(GAS_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body}); return r.json(); }
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

(async function init(){
  if (!stuRow) return;
  sub.textContent = `科別：${stuRow[0]}　班級：${stuRow[1]}　學號：${stuRow[2]}　姓名：${stuRow[3]}`;
  await loadStudent();
})();
// ======== 簡易裁切器（中央九宮格裁切） ========
(function(){
  const overlay = document.getElementById('cropperOverlay');
  const canvas = document.getElementById('cropperCanvas');
  const ctx = canvas.getContext('2d');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const btnUse = document.getElementById('cropUse');
  const btnCancel = document.getElementById('cropCancel');

  let img = null;
  let imgW = 0, imgH = 0;
  let scale = 1, minScale = 1, maxScale = 8;
  let offsetX = 0, offsetY = 0;      // 圖片相對畫布中心的偏移（畫布座標）
  let dragging = false, lastX = 0, lastY = 0;
  let resolveCallback = null;         // 將裁切結果回傳給呼叫端

  function draw(){
    // 背景
    ctx.fillStyle = '#111';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    if(!img) return;

    // 將(0,0)移到畫布中心，之後位移＋縮放
    ctx.save();
    ctx.translate(canvas.width/2 + offsetX, canvas.height/2 + offsetY);
    ctx.scale(scale, scale);
    // 以圖片中心對準(0,0)
    ctx.drawImage(img, -imgW/2, -imgH/2);
    ctx.restore();

    // 可加深中央以外暗角（單純視覺輔助，不影響裁切）
    // 這裡略過，九宮格線條已在 HTML 疊層
  }

  function fitImage(){
    // 讓圖片最小縮放即可覆蓋整個中央裁切區（中央 1/3 寬、高）
    // 畫布中央區域大小：
    const targetW = canvas.width / 3;
    const targetH = canvas.height / 3;
    const sx = targetW / imgW;
    const sy = targetH / imgH;
    // 我們希望「最小縮放」至少能使目標區完全填滿 → 取 max
    minScale = Math.max(sx, sy);
    scale = Math.max(minScale, Math.min(scale, maxScale));
    offsetX = 0; offsetY = 0;
    draw();
  }

  // 事件：拖曳移動
  canvas.addEventListener('mousedown', e=>{
    dragging = true;
    lastX = e.offsetX;
    lastY = e.offsetY;
  });
  window.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const rect = canvas.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    offsetX += (cx - lastX);
    offsetY += (cy - lastY);
    lastX = cx; lastY = cy;
    draw();
  });
  window.addEventListener('mouseup', ()=> dragging=false);

  // 滾輪縮放（以滑鼠位置為中心縮放，這裡簡化為以畫布中心縮放）
  canvas.addEventListener('wheel', e=>{
    e.preventDefault();
    const delta = Math.sign(e.deltaY);
    const factor = (delta > 0 ? 0.9 : 1.1);
    const newScale = Math.max(minScale, Math.min(maxScale, scale * factor));
    if (newScale !== scale) {
      scale = newScale;
      draw();
    }
  }, { passive:false });

  // 按鈕縮放
  zoomInBtn.onclick  = ()=>{ scale = Math.min(maxScale, scale*1.1); draw(); };
  zoomOutBtn.onclick = ()=>{ scale = Math.max(minScale, scale/1.1); draw(); };

  btnCancel.onclick = ()=>{
    overlay.style.display = 'none';
    if (resolveCallback) resolveCallback(null);
    resolveCallback = null;
  };

  btnUse.onclick = ()=>{
    // 計算中央格對應到原圖的裁切矩形
    // 中央格在畫布座標： [w/3, 2w/3] x [h/3, 2h/3]
    const x1 = canvas.width / 3;
    const y1 = canvas.height / 3;
    const x2 = canvas.width * 2 / 3;
    const y2 = canvas.height * 2 / 3;

    // 反推回「圖片座標」：
    // 畫圖時：translate(cx+offset) → scale(scale) → drawImage(-imgW/2, -imgH/2)
    // 反推：先減中心與偏移，再除以 scale，再加回 imgW/2,imgH/2
    function canvasToImage(px, py){
      const dx = px - (canvas.width/2 + offsetX);
      const dy = py - (canvas.height/2 + offsetY);
      const ix = dx / scale + imgW/2;
      const iy = dy / scale + imgH/2;
      return {x: ix, y: iy};
    }
    const p1 = canvasToImage(x1, y1);
    const p2 = canvasToImage(x2, y2);

    // 取得整數且界內
    const sx = Math.max(0, Math.floor(Math.min(p1.x, p2.x)));
    const sy = Math.max(0, Math.floor(Math.min(p1.y, p2.y)));
    const sw = Math.min(imgW - sx, Math.floor(Math.abs(p2.x - p1.x)));
    const sh = Math.min(imgH - sy, Math.floor(Math.abs(p2.y - p1.y)));

    if (sw <= 0 || sh <= 0) {
      alert('裁切範圍無效，請重新對齊');
      return;
    }

    // 在離屏畫布裁切出中央格
    const out = document.createElement('canvas');
    out.width = sw; out.height = sh;
    const octx = out.getContext('2d');
    octx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

    const dataURL = out.toDataURL('image/jpeg', 0.92);
    overlay.style.display = 'none';
    if (resolveCallback) resolveCallback(dataURL);
    resolveCallback = null;
  };

  // 對外 API：從 File 進來 → 開窗 → 回傳 dataURL（或 null）
  window.openCropperForFile = async function(file){
    const url = URL.createObjectURL(file);
    img = new Image();
    img.onload = ()=>{
      imgW = img.naturalWidth; imgH = img.naturalHeight;
      // 調整畫布比例（跟容器相同，預設1080x720，可依實際畫面調整）
      // 這裡保留固定 canvas 解析度，避免鋸齒；縮放由 CSS 控制
      document.body.appendChild(overlay);    // 移到 body 最後，確保疊在最上層
      overlay.style.zIndex = '2147483647';   // 雙保險
      overlay.style.display = 'flex';
      fitImage();
    };
    img.src = url;

    return new Promise(resolve=>{
      resolveCallback = resolve;
    });
  };
})();
// 有沒有未送出的編輯？請換成你實際的判斷函式或變數
function hasDirty() {
  return (dirtySet.size > 0) || (pendingCertOps.length > 0);
}

window.addEventListener('beforeunload', (e) => {
  if (hasDirty()) {
    e.preventDefault();
    e.returnValue = ''; // 觸發瀏覽器的離開確認對話框
  }
});
</script>
</body>
</html>
