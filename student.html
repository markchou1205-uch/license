<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" href="data:,">
<title>學生資料 | 職業證照登管系統</title>
<style>
  :root{
    --bg1:#fff7ed; --card:#fffaf0; --line:#e6d3b8;
    --text:#3b2f2f; --muted:#8b6b5e; --accent:#f59e0b;
    --btnBg:#f3f4f6; --btnBorder:#cbd5e1; --btnHover:#e5e7eb;
    --btnPriBg:#f59e0b; --btnPriText:#fff; --btnPriBorder:#d97706;
    --error:#b91c1c; --ok:#16a34a; --shadow:0 10px 30px rgba(217,119,6,.12);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),#fff);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC"}
  .wrap{width:95%;margin:22px auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  h1{margin:0 0 6px} .sub{margin:0 0 10px;color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  /* table */
  .table-wrap{width:95%;overflow:auto;margin-top:10px}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid var(--line);padding:8px 8px;text-align:left;font-size:14px;vertical-align:middle;white-space:nowrap}
  th{font-weight:600;color:#6b4f43;background:#fff8ea}
  .ro{background:#f7f3ea}
  /* controls / buttons */
  select,input[type="text"]{min-width:120px;padding:6px 8px;border:1px solid var(--btnBorder);border-radius:6px;background:#fff;outline:none;appearance:auto}
  select:focus,input[type="text"]:focus{border-color:#94a3b8;box-shadow:0 0 0 2px rgba(148,163,184,.25)}
  .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:1px solid var(--btnBorder);background:var(--btnBg);color:var(--text);cursor:pointer}
  .btn:hover{background:var(--btnHover)}
  .btn.primary{background:var(--btnPriBg); border-color:var(--btnPriBorder); color:var(--btnPriText)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .okMark{display:inline-block;margin-left:6px;color:var(--ok);font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  /* Spinner & Progress */
  #busy{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:9999}
  .spinner{width:48px;height:48px;border:5px solid #fff;border-top-color:#f59e0b;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #uploadProgress{position:fixed;left:0;right:0;bottom:18px;display:none;z-index:10000}
  #uploadProgress .barWrap{max-width:560px;margin:0 auto;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);overflow:hidden}
  #uploadProgress .bar{height:10px;width:0%;background:linear-gradient(90deg,#f59e0b,#fde68a)}
  #uploadProgress .meta{padding:6px 10px;font-size:12px;color:var(--text)}
  /* Modal */
  #certModal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10001}
  .modalCard{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:14px;max-width:480px;width:92%}
  .row{display:grid;grid-template-columns:1fr;gap:8px}
  .modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>學生資料</h1>
    <p class="sub" id="sub"></p>
    <div class="actions">
      <button class="btn primary" id="btnSubmit" disabled>確認送出</button>
      <a class="btn" href="index.html">返回登入</a>
      <span class="small" id="err"></span>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="busy"><div class="spinner"></div></div>
<div id="uploadProgress"><div class="barWrap"><div class="bar" id="progBar"></div><div class="meta" id="progMeta">準備上傳…</div></div></div>
<div id="certModal">
  <div class="modalCard">
    <h3 id="cmTitle" style="margin:0 0 6px">證號與截圖</h3>
    <div class="row">
      <label>證號 <input id="cmNo" type="text" autocomplete="off"/></label>
      <label>上傳截圖（學生必須附檔） <input id="cmFile" type="file" accept="image/*"/></label>
    </div>
    <div class="modalActions">
      <button class="btn" id="cmCancel">取消</button>
      <button class="btn primary" id="cmOk">確認</button>
    </div>
  </div>
</div>

<script>
const GAS_BASE = '/api/gas';
const stuRow = JSON.parse(sessionStorage.getItem('studentRow')||'null'); // [dept, clazz, sid, name, seat, nid]

const sub = document.getElementById('sub');
const errEl = document.getElementById('err');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const btnSubmit = document.getElementById('btnSubmit');
const BASE_COLS = 5; // 學生頁基礎欄位數（不含身分證號）

const busy = document.getElementById('busy');
const upWrap = document.getElementById('uploadProgress');
const progBar = document.getElementById('progBar');
const progMeta = document.getElementById('progMeta');

function showBusy(on){ busy.style.display = on ? 'flex' : 'none'; }
function showProgress(on){ upWrap.style.display = on ? 'block' : 'none'; }
function setProgress(p, txt){ progBar.style.width = (p|0)+'%'; if (txt) progMeta.textContent = txt; }

if(!stuRow){ sub.textContent='無資料，請由登入頁進入。'; }

let headersMeta = []; // [{title,kind,group,colIndex}]
let rowData = null;   // {rowIndex, base, tail}
let originalTail = [];
const dirtySet = new Set();
  
function syncDirty(rowIndex, colIndex, newDisplay){
  const idx = headersMeta.findIndex(h=>h.colIndex===colIndex);
  const orig = originalTail[idx] || '';
  const key = `${rowIndex}-${colIndex}`;
  if ((newDisplay||'') === orig){
    dirtySet.delete(key);
  }else{
    dirtySet.add(key);
  }
  btnSubmit.disabled = dirtySet.size===0;
}
  
async function loadStudent(){
  showBusy(true);
  try{
    const body = new URLSearchParams({ path:'student_row', sid: stuRow[2] }).toString();
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'load failed');

    headersMeta = data.headersMeta||[];
    rowData = data.row;
    originalTail = (rowData.tail||[]).map(c => (c?.display||''));
    renderTable();
  }catch(e){ errEl.textContent=e.message; }
  finally{ showBusy(false); }
}

function setDirty(rowIndex, colIndex){
  dirtySet.add(`${rowIndex}-${colIndex}`);
  btnSubmit.disabled = dirtySet.size===0;
}
function clearDirty(){ dirtySet.clear(); btnSubmit.disabled = true; }

async function loadClass(){
  try{
    showBusy(true);
    const body = new URLSearchParams({ path:'class_rows', dept:stuRow[0], clazz:stuRow[1] }).toString();
    const r = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'load failed');

    headersMeta = data.headersMeta||[];
    rowData = (data.rows||[]).find(x=> (x.base?.[2]||'')===stuRow[2]) || null;
    if (!rowData) throw new Error('找不到該學生的資料列');
    renderTable();
  }catch(e){ errEl.textContent = e.message; }
  finally{ showBusy(false); }
}

function th(t){ const x=document.createElement('th'); x.textContent=t; return x; }
function td(){ return document.createElement('td'); }

function renderTable(){
  thead.innerHTML=''; tbody.innerHTML='';
  ['科別名稱','班級名稱','學號','姓名','座號'].forEach(t=>thead.appendChild(th(t)));
  headersMeta.forEach(h=>thead.appendChild(th(h.title)));

  const tr=document.createElement('tr');
  rowData.base.slice(0, BASE_COLS).forEach(v => { const c = td(); c.textContent = v || ''; tr.appendChild(c); });

  headersMeta.forEach((h, idx)=>{
    const cell = rowData.tail[idx] || {display:'',hasLink:false};
    const c = td();
if (h.kind==='S1' || h.kind==='S2'){
  const sel = document.createElement('select');
  ['及格','不及格',''].forEach(op=>{ const o=document.createElement('option'); o.value=op; o.textContent=op||'（空白）'; sel.appendChild(o); });
  sel.value = cell.display || '';
  sel.addEventListener('change', ()=>{
    cell.display = sel.value;
    syncDirty(rowData.rowIndex, h.colIndex, sel.value);
    updateS3AndMaybePrompt(h.group);
  });
  c.appendChild(sel);
    }else if (h.kind==='S3'){
      c.classList.add('ro');
      const span=document.createElement('span');
      span.textContent = computeS3ByGroup(h.group);
      c.appendChild(span);
    }else if (h.kind==='S4'){
      c.classList.add('ro');
      const txt=document.createElement('span'); txt.textContent = cell.display || '';
      c.appendChild(txt);
      if (cell.hasLink){
        const ok=document.createElement('span'); ok.className='okMark'; ok.textContent='✓'; c.appendChild(ok);
      }else if ((cell.display||'').trim()!==''){
        const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='修改/補截圖';
        btn.addEventListener('click', ()=>openCertModal({
  headerTitle: h.title,
  currentNo: cell.display || '',
  requireImage:false,
  mode:'edit',
  group: h.group
}));

        c.appendChild(document.createTextNode(' ')); c.appendChild(btn);
      }
    }else{ // FREE
      const input=document.createElement('input'); input.type='text'; input.value = cell.display || '';
      input.addEventListener('change', ()=>{ cell.display=input.value.trim(); setDirty(rowData.rowIndex,h.colIndex); });
      c.appendChild(input);
    }
    tr.appendChild(c);
  });

  tbody.appendChild(tr);
}

/* -------- 同組 S3 判斷＆更新（學生） -------- */
function computeS3ByGroup(group){
  const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
  const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
  const v1 = s1Idx>=0 ? (rowData.tail[s1Idx]?.display||'').trim() : '';
  const v2 = s2Idx>=0 ? (rowData.tail[s2Idx]?.display||'').trim() : '';
  return (v1==='及格' && v2==='及格') ? '獲證' : '';
}

function updateS3AndMaybePrompt(group){
  const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
  if (s3Idx<0) return;
  const oldVal = (rowData.tail[s3Idx]?.display||'');
  const newVal = computeS3ByGroup(group);
  rowData.tail[s3Idx] = rowData.tail[s3Idx] || {};
  rowData.tail[s3Idx].display = newVal;
  // 更新畫面
  const tdS3 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s3Idx];
  tdS3.textContent = newVal;

  // 只有「空白 ➜ 獲證」這次變化才彈窗
  if (oldVal !== '獲證' && newVal === '獲證'){
    const s4Hdr = headersMeta.find(h=>h.group===group && h.kind==='S4');
    if (s4Hdr) openCertModal({ headerTitle: s4Hdr.title, currentNo:'', requireImage:true, mode:'new', group });
  }
}

/* -------- 對話框（學生：新獲證必須上傳） -------- */
const certModal = document.getElementById('certModal');
const cmTitle = document.getElementById('cmTitle');
const cmNo = document.getElementById('cmNo');
const cmFile = document.getElementById('cmFile');
const cmCancel = document.getElementById('cmCancel');
const cmOk = document.getElementById('cmOk');
let cmCtx=null;

function openCertModal(ctx){
  cmCtx = ctx; cmTitle.textContent=`證號與截圖：${ctx.headerTitle}`;
  cmNo.value=ctx.currentNo||''; cmFile.value=''; certModal.style.display='flex';
}
cmCancel.onclick = () => {
  certModal.style.display = 'none';
  if (cmCtx && cmCtx.mode === 'new') {
    // 清除本組 s1/s2 與 s3
    const group = cmCtx.group;
    const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
    const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
    const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
    if (s1Idx>=0){
      rowData.tail[s1Idx].display = '';
      const sel = tbody.querySelectorAll('tr')[0].children[BASE_COLS+s1Idx].querySelector('select');
      if (sel) sel.value = '';
      setDirty(rowData.rowIndex, headersMeta[s1Idx].colIndex);   // 加入變更追蹤
    }
    if (s2Idx>=0){
      rowData.tail[s2Idx].display = '';
      const sel = tbody.querySelectorAll('tr')[0].children[BASE_COLS+s2Idx].querySelector('select');
      if (sel) sel.value = '';
      setDirty(rowData.rowIndex, headersMeta[s2Idx].colIndex);
    }
    if (s3Idx>=0){
      rowData.tail[s3Idx].display = '';
      const tdS3 = tbody.querySelectorAll('tr')[0].children[BASE_COLS + s3Idx];
      tdS3.textContent = '';
    }
  }
  cmCtx = null;
};

cmOk.onclick=async ()=>{
  if (!cmCtx) return;
  const { headerTitle, requireImage, group } = cmCtx;
  const no=(cmNo.value||'').trim(); const file=cmFile.files[0]||null;
  if (!no){ alert('請輸入證號'); return; }
  if (requireImage && !file){
    certModal.style.display='none';
    alert('您沒有上傳截圖，所以已經清除您填的資料，請準備截圖後再次填寫');
    // 清除本組 s1/s2 與 s3
const s1Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S1');
const s2Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S2');
const s3Idx = headersMeta.findIndex(h=>h.group===group && h.kind==='S3');
    if (s1Idx>=0){ rowData.tail[s1Idx].display=''; tbody.querySelectorAll('tr')[0].children[BASE_COLS+s1Idx].querySelector('select').value=''; setDirty(rowData.rowIndex, headersMeta[s1Idx].colIndex); }
    if (s2Idx>=0){ rowData.tail[s2Idx].display=''; tbody.querySelectorAll('tr')[0].children[BASE_COLS+s2Idx].querySelector('select').value=''; setDirty(rowData.rowIndex, headersMeta[s2Idx].colIndex); }
    if (s3Idx>=0){ rowData.tail[s3Idx].display=''; tbody.querySelectorAll('tr')[0].children[BASE_COLS+s3Idx].textContent=''; }
    return;
  }
  certModal.style.display='none';

  try{
    showProgress(true); setProgress(10,'準備上傳…');
    if (file){
      const b64 = await fileToBase64(file); setProgress(30,'上傳檔案至伺服器…');
      const r = await postForm({
        path:'upload_cert',
        dept: stuRow[0], clazz: stuRow[1], sid: stuRow[2], name: stuRow[3],
        headerTitle, certNo:no, fileBase64:b64.split(',')[1], mime:file.type||'image/png'
      });
      if (!r.ok) throw new Error(r.error||'upload failed');
      updateS4CellUI(headerTitle, no, true, group);
      setProgress(100,'完成');
    }else{
      // 補圖模式可只改證號
      const r = await postForm({ path:'write_cert', sid: stuRow[2], headerTitle, certNo:no });
      if (!r.ok) throw new Error(r.error||'write failed');
      updateS4CellUI(headerTitle, no, false, group);
      setProgress(100,'完成');
    }
  }catch(e){ alert('上傳/寫入失敗：' + e.message); }
  finally{ setTimeout(()=>showProgress(false), 500); }
};

function updateS4CellUI(headerTitle, certNo, hasLink, group){
  const idx = (group != null)
    ? headersMeta.findIndex(h => h.group === group && h.kind === 'S4')
    : headersMeta.findIndex(h => h.title === headerTitle && h.kind === 'S4');
  if (idx<0) return;
  const cell = rowData.tail[idx] || (rowData.tail[idx]={});
  cell.display=certNo; cell.hasLink=!!hasLink;
  const tdNode = tbody.querySelectorAll('tr')[0].children[BASE_COLS + idx];
  tdNode.innerHTML='';
  const txt=document.createElement('span'); txt.textContent=certNo; tdNode.appendChild(txt);
  if (hasLink){ const ok=document.createElement('span'); ok.className='okMark'; ok.textContent='✓'; tdNode.appendChild(ok); }
  else{
const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='修改/補截圖';
const g = group ?? headersMeta[idx]?.group;
btn.addEventListener('click', ()=>openCertModal({
  headerTitle,
  currentNo:certNo,
  requireImage:false,
  mode:'edit',
  group: g
}));

    tdNode.appendChild(document.createTextNode(' ')); tdNode.appendChild(btn);
  }
}

/* -------- 確認送出（只有變更才可點） -------- */
btnSubmit.onclick = async ()=>{
  if (dirtySet.size===0) return;
  try{
    showBusy(true);
    const updates=[];
    dirtySet.forEach(k=>{
      const [r,c]=k.split('-').map(n=>parseInt(n,10));
      const h = headersMeta.find(h=>h.colIndex===c);
      const idx = headersMeta.indexOf(h);
      const valueDisplay = (rowData.tail[idx]?.display)||'';
      updates.push({ rowIndex:r, colIndex:c, valueDisplay, headerTitle:h.title });
    });
    const r = await postForm({ path:'update_rows', updates: JSON.stringify(updates) });
    if (!r.ok) throw new Error(r.error||'update failed');
    clearDirty();
    alert(`已送出！更新筆數：${r.count}`);
  }catch(e){ alert('送出失敗：'+e.message); }
  finally{ showBusy(false); }
};

/* -------- 工具 -------- */
async function postForm(obj){ const body=new URLSearchParams(obj).toString(); const r=await fetch(GAS_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body}); return r.json(); }
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

(async function init(){
  if (!stuRow) return;
  sub.textContent = `科別：${stuRow[0]}　班級：${stuRow[1]}　學號：${stuRow[2]}　姓名：${stuRow[3]}`;
  await loadStudent();
})();
</script>
</body>
</html>
