<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>學生填報</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .meta { color:#555; margin-bottom: 16px; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 14px; vertical-align: top; }
  th { background: #fafafa; text-align: left; }
  input[type="text"] { width: 100%; box-sizing: border-box; padding: 6px 8px; }
  .actions { margin-top: 12px; display:flex; gap:8px; }
  .badge { display:inline-block; padding:2px 6px; background:#f2f2f2; border-radius:4px; margin-left:6px; font-size:12px; color:#666; }
  .loading { text-align: center; padding: 40px; color: #666; }
  .error { color: #d32f2f; background: #ffebee; padding: 12px; border-radius: 4px; margin: 16px 0; }
</style>
</head>
<body>
<h1>學生填報</h1>
<div class="meta">
  角色:學生<span class="badge" id="deptBadge"></span>
  <button id="btnLogout" style="float:right">登出</button>
</div>

<div id="root">
  <div class="loading">載入中,請稍候...</div>
</div>

<div class="actions">
  <button id="btnSubmit">確認送出</button>
</div>

<script>
  const GAS_BASE = '/api/gas';

  (function(){ if (!window.dbg) window.dbg = (t,o)=>{ 
    const on = new URLSearchParams(location.search).get('debug')==='1' || localStorage.getItem('debug')==='1';
    if (on) console.log('[DBG]',t,o); 
  };})();

  async function apiGet(path, params) {
    const url = GAS_BASE + '?' + new URLSearchParams({ path, ...params });
    dbg('GET '+url,null);
    const r = await fetch(url); 
    const t = await r.text(); 
    dbg('RESP '+r.status+' '+path,t);
    try { return JSON.parse(t); } catch { return {ok:false, as:'html', status:r.status, body:t}; }
  }

  async function apiPost(path, params) {
    const body = new URLSearchParams({ path, ...params }).toString();
    dbg('POST '+GAS_BASE, body);
    const r = await fetch(GAS_BASE, { 
      method:'POST', 
      headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
      body 
    });
    const t = await r.text(); 
    dbg('RESP '+r.status+' '+path,t);
    try { return JSON.parse(t); } catch { return {ok:false, as:'html', status:r.status, body:t}; }
  }

  // 關鍵修正:檢查 localStorage 中的資料
  const token = localStorage.getItem('token');
  const role  = localStorage.getItem('role');
  const dept  = localStorage.getItem('dept');

  if (!token || role !== 'student') {
    alert('請先登入');
    location.href = 'index.html';
  }

  // 關鍵修正:驗證 dept 是否存在
  if (!dept || dept === 'null' || dept === 'undefined') {
    alert('登入資訊不完整,請重新登入');
    localStorage.clear();
    location.href = 'index.html';
  }

  document.getElementById('deptBadge').textContent = dept || '';

  let headersRaw = [];
  let rowRaw = [];
  let editableCols = [];
  let tableInputs = new Map();

  const PASS = '及格';
  const FAIL = '不及格';
  const GET  = '獲證';

  function detectGroups(headers) {
    const groups = [];
    for (let i = 0; i < headers.length; i++) {
      const name = String(headers[i] || '').trim();
      if (/-學$/.test(name)) {
        const base = name.replace(/-學$/, '');
        let idx2 = headers.findIndex((h, j) => j>i && String(h).trim() === (base + '-術'));
        let idx3 = headers.findIndex((h, j) => j>Math.max(i, idx2) && (
          String(h).trim() === (base + '-丙') ||
          String(h).trim() === (base + '-乙') ||
          /技工$/.test(String(h).trim()) ||
          String(h).trim().replace(/[-乙丙]$/,'') === base
        ));
        let idx4 = headers.findIndex((h, j) => j>Math.max(i, idx2, idx3) && String(h).trim() === '獲證字號');

        if (idx2> -1 && idx3> -1 && idx4> -1) {
          groups.push({ base, c1: i+1, c2: idx2+1, c3: idx3+1, c4: idx4+1 });
        }
      }
    }
    return groups;
  }

  function renderTable() {
    const root = document.getElementById('root');
    tableInputs.clear();
    const table = document.createElement('table'); 
    const tbody = document.createElement('tbody');

    const fixed = ['班級','座號','學號','姓名'];
    fixed.forEach((name) => {
      const col = headersRaw.findIndex(h => String(h).trim() === name) + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `<th>${name}</th><td>${col? String(rowRaw[col-1] ?? '') : ''}</td>`;
      tbody.appendChild(tr);
    });

    const groups = detectGroups(headersRaw);
    const groupedCols = new Set();
    groups.forEach(g => { 
      groupedCols.add(g.c1); 
      groupedCols.add(g.c2); 
      groupedCols.add(g.c3); 
      groupedCols.add(g.c4); 
    });

    groups.forEach((g) => {
      tbody.appendChild(makeSelectRow(`${g.base}-學`, g.c1));
      tbody.appendChild(makeSelectRow(`${g.base}-術`, g.c2));
      tbody.appendChild(makeReadonlyRow(findHeader(g.c3), g.c3));
      tbody.appendChild(makeTextRow('獲證字號', g.c4, true));
    });

    for (let c = 1; c <= headersRaw.length; c++) {
      const name = headersRaw[c-1];
      if (fixed.includes(String(name).trim())) continue;
      if (groupedCols.has(c)) continue;
      if (!editableCols.includes(c)) continue;
      tbody.appendChild(makeTextRow(String(name), c, false));
    }

    const countCol = headersRaw.findIndex(h => String(h).trim() === '獲證張數') + 1;
    if (countCol) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<th>獲證張數</th><td><input type="text" data-col="${countCol}" readonly /></td>`;
      tbody.appendChild(tr);
      tableInputs.set(countCol, tr.querySelector('input'));
    }

    table.appendChild(tbody);
    root.innerHTML = ''; 
    root.appendChild(table);

    applyRulesAndCounters(groups);
  }

  function findHeader(col){ return String(headersRaw[col-1] || '').trim(); }

  function makeSelectRow(label, col) {
    const tr = document.createElement('tr');
    const v = rowRaw[col-1] ?? '';
    tr.innerHTML = `<th>${label}</th>
      <td><select data-col="${col}">
        <option value=""></option>
        <option value="${PASS}">${PASS}</option>
        <option value="${FAIL}">${FAIL}</option>
      </select></td>`;
    const sel = tr.querySelector('select');
    sel.value = v;
    sel.addEventListener('change', onAnyInputChanged);
    tableInputs.set(col, sel);
    return tr;
  }

  function makeReadonlyRow(label, col) {
    const tr = document.createElement('tr');
    const v = rowRaw[col-1] ?? '';
    tr.innerHTML = `<th>${label}</th><td><input type="text" data-col="${col}" value="${String(v)}" readonly /></td>`;
    tableInputs.set(col, tr.querySelector('input'));
    return tr;
  }

  function makeTextRow(label, col, isCertNo) {
    const tr = document.createElement('tr');
    const v = rowRaw[col-1] ?? '';
    tr.innerHTML = `<th>${label}</th><td><input type="text" data-col="${col}" value="${String(v)}" ${isCertNo?'':' '} /></td>`;
    const inp = tr.querySelector('input');
    inp.addEventListener('input', onAnyInputChanged);
    tableInputs.set(col, inp);
    return tr;
  }

  function onAnyInputChanged() {
    const groups = detectGroups(headersRaw);
    applyRulesAndCounters(groups);
  }

  function applyRulesAndCounters(groups) {
    let total = 0;
    groups.forEach(g => {
      const s1 = (tableInputs.get(g.c1)?.value || '').trim();
      const s2 = (tableInputs.get(g.c2)?.value || '').trim();
      const s3El = tableInputs.get(g.c3);
      const s4El = tableInputs.get(g.c4);

      const isPass = (s1 === PASS && s2 === PASS);

      if (s3El) {
        s3El.readOnly = true;
        s3El.value = isPass ? GET : '';
      }
      if (s4El) {
        if (isPass) {
          s4El.removeAttribute('readonly');
          s4El.required = true;
        } else {
          s4El.value = '';
          s4El.setAttribute('readonly', 'readonly');
          s4El.required = false;
        }
      }
      if (isPass) total++;
    });

    const countCol = headersRaw.findIndex(h => String(h).trim() === '獲證張數') + 1;
    if (countCol && tableInputs.get(countCol)) {
      tableInputs.get(countCol).value = String(total);
    }
  }

  async function loadProfile() {
    try {
      // 確保傳遞 dept 參數
      const res = await apiGet('profile', { token, dept, debug: '1' });
      
      if (!res.ok) {
        throw new Error(res.error || '讀取失敗');
      }

      headersRaw = res.headersRaw || [];
      rowRaw = res.rowRaw || [];
      editableCols = res.editableCols || [];

      if (!headersRaw.length || !rowRaw.length) {
        throw new Error('資料異常:找不到表頭或資料列');
      }
      
      renderTable();
      
      // 顯示除錯資訊(如果有)
      if (res.debugTimings) {
        console.log('載入時間分析:', res.debugTimings);
      }
    } catch (err) {
      const root = document.getElementById('root');
      root.innerHTML = `<div class="error">
        <strong>載入失敗:</strong> ${err.message}<br>
        <button onclick="location.href='index.html'" style="margin-top:8px">返回登入頁</button>
      </div>`;
      throw err;
    }
  }

  document.getElementById('btnSubmit').addEventListener('click', async () => {
    try {
      const groups = detectGroups(headersRaw);
      for (const g of groups) {
        const s3 = (tableInputs.get(g.c3)?.value || '').trim();
        if (s3 === GET) {
          const s4 = (tableInputs.get(g.c4)?.value || '').trim();
          if (!s4) { 
            alert(`【${findHeader(g.c4)}】未填寫(${findHeader(g.c3)}=「${GET}」時必填)`); 
            return; 
          }
        }
      }

      const updatesByCol = [];
      for (const [col, el] of tableInputs.entries()) {
        const oldVal = rowRaw[col-1] ?? '';
        const newVal = (el.value ?? '').toString();
        if (String(oldVal) !== String(newVal)) {
          updatesByCol.push({ col, value: newVal });
        }
      }
      
      if (!updatesByCol.length) { 
        alert('沒有變更'); 
        return; 
      }

      const res = await apiPost('profile.update', {
        token,
        dept,
        updatesByCol: JSON.stringify(updatesByCol),
        debug: '1'
      });
      
      if (!res.ok) throw new Error(res.error || '送出失敗');

      alert('已送出!更新欄位數:' + res.updated);
      await loadProfile();
    } catch (err) {
      alert(err.message);
    }
  });

  document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.clear(); 
    location.href = 'index.html';
  });

  loadProfile().catch(err => {
    console.error('loadProfile error:', err);
  });
</script>

</body>
</html>
